@page "/properties/{id:guid}"
@using cima.Domain.Shared.Dtos
@using cima.Listings
@inject IListingAppService ListingAppService
@inject NavigationManager Navigation

<PageTitle>@(listing?.Title ?? "Propiedad") - CIMA</PageTitle>

@if (isLoading)
{
    <div class="min-h-screen flex items-center justify-center">
        <div class="cima-spinner"></div>
    </div>
}
else if (listing == null)
{
    <div class="container mx-auto px-4 py-20">
        <div class="max-w-2xl mx-auto text-center">
            <h1 class="text-headline cima-heading mb-4">Propiedad No Encontrada</h1>
            <p class="text-body cima-subheading mb-8">La propiedad que buscas no existe o fue eliminada</p>
            <button @onclick="@(() => Navigation.NavigateTo("/properties"))" class="cima-btn-primary">
                Volver a Propiedades
            </button>
        </div>
    </div>
}
else
{
    <!-- Breadcrumb -->
    <div class="bg-gray-50 dark:bg-gray-800 py-4 border-b border-gray-200 dark:border-gray-700 transition-colors duration-300">
        <div class="container mx-auto px-4">
            <nav class="flex text-xs uppercase tracking-wider text-gray-600 dark:text-gray-400">
                <a href="/" class="hover:text-cima-accent dark:hover:text-white">Inicio</a>
                <span class="mx-2">/</span>
                <a href="/properties" class="hover:text-cima-accent dark:hover:text-white">Propiedades</a>
                <span class="mx-2">/</span>
                <span class="text-gray-900 dark:text-white">@listing.Title</span>
            </nav>
        </div>
    </div>
    
    <div class="container mx-auto px-4 py-12">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
            <!-- Main Content -->
            <div class="lg:col-span-2">
                <!-- Image Gallery -->
                <div class="mb-12">
                    <PropertyGallery Images="@listing.Images" />
                </div>
                
                <!-- Property Info -->
                <div class="mb-12">
                    <div class="flex justify-between items-start mb-8">
                        <div>
                            <h1 class="text-headline cima-heading mb-4">@listing.Title</h1>
                            <div class="flex items-center gap-2 text-gray-600 dark:text-gray-400">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                          d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                </svg>
                                <span class="text-sm uppercase tracking-wide">@listing.Location</span>
                            </div>
                        </div>
                        <span class="cima-badge cima-badge-published">@listing.Status</span>
                    </div>
                    
                    <div class="cima-price mb-12">$@listing.Price.ToString("N0")</div>
                    
                    <!-- Features Grid -->
                    <div class="grid grid-cols-3 gap-8 mb-12 pb-12 border-b-2 border-gray-200 dark:border-gray-700">
                        <div class="text-center">
                            <div class="text-4xl font-bold text-cima-accent dark:text-white mb-2">@listing.Bedrooms</div>
                            <div class="text-xs uppercase tracking-wider text-gray-600 dark:text-gray-400">Recámaras</div>
                        </div>
                        <div class="text-center">
                            <div class="text-4xl font-bold text-cima-accent dark:text-white mb-2">@listing.Bathrooms</div>
                            <div class="text-xs uppercase tracking-wider text-gray-600 dark:text-gray-400">Baños</div>
                        </div>
                        <div class="text-center">
                            <div class="text-4xl font-bold text-cima-accent dark:text-white mb-2">@listing.Area</div>
                            <div class="text-xs uppercase tracking-wider text-gray-600 dark:text-gray-400">m²</div>
                        </div>
                    </div>
                    
                    <!-- Description -->
                    <div>
                        <h2 class="text-title cima-heading mb-6">Descripción</h2>
                        <div class="w-16 h-1 bg-cima-accent dark:bg-white mb-6"></div>
                        <p class="text-body cima-subheading whitespace-pre-line leading-relaxed">@listing.Description</p>
                    </div>
                </div>
                
                <!-- Architect Info -->
                @if (listing.Architect != null)
                {
                    <div class="cima-card">
                        <div class="cima-card-body">
                            <h2 class="text-title cima-heading mb-6">Arquitecto</h2>
                            <div class="w-16 h-1 bg-cima-accent dark:bg-white mb-8"></div>
                            
                            <div class="flex items-start gap-6">
                                <div class="w-20 h-20 bg-gray-200 dark:bg-gray-700 flex items-center justify-center flex-shrink-0">
                                    <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                              d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-3 uppercase tracking-wide">
                                        @listing.Architect.UserName
                                    </h3>
                                    @if (!string.IsNullOrEmpty(listing.Architect.Bio))
                                    {
                                        <p class="text-gray-600 dark:text-gray-400 mb-4 text-sm leading-relaxed">@listing.Architect.Bio</p>
                                    }
                                    @if (!string.IsNullOrEmpty(listing.Architect.PortfolioUrl))
                                    {
                                        <a href="@listing.Architect.PortfolioUrl" 
                                           target="_blank" 
                                           class="text-cima-accent dark:text-white hover:underline text-sm uppercase tracking-wide">
                                            Ver Portfolio ?
                                        </a>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
            
            <!-- Sidebar -->
            <div class="lg:col-span-1">
                <div class="sticky top-24">
                    <ContactForm ListingId="@Id" />
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public Guid Id { get; set; }
    
    private ListingDto? listing;
    private bool isLoading = true;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadListing();
    }
    
    private async Task LoadListing()
    {
        isLoading = true;
        
        try
        {
            listing = await ListingAppService.GetAsync(Id);
        }
        catch
        {
            listing = null;
        }
        finally
        {
            isLoading = false;
        }
    }
}
