@page "/"
@using cima.Domain.Shared.Dtos
@using cima.Listings
@inject IListingAppService ListingService
@inject NavigationManager NavManager
@inherits cimaComponentBase

<PageTitle>@L["Home"] - @L["CompanyName"]</PageTitle>

@* Hero Section *@
<HeroSection OnSearch="HandleSearch" />

@* Featured Properties Section *@
<section class="cima-section cima-section-alt">
    <div class="cima-container">
        <div class="text-center mb-12">
            <h2 class="text-3xl md:text-4xl font-display font-bold text-neutral-900 mb-4">
                @L["Properties:Featured"]
            </h2>
            <p class="text-lg text-neutral-600 max-w-2xl mx-auto">
                @L["Properties:Subtitle"]
            </p>
        </div>

        @if (IsLoading)
        {
            <div class="cima-grid">
                @for (int i = 0; i < 3; i++)
                {
                    <div class="cima-card">
                        <div class="cima-skeleton-image"></div>
                        <div class="p-5 space-y-3">
                            <div class="cima-skeleton-text w-3/4"></div>
                            <div class="cima-skeleton-text w-1/2"></div>
                            <div class="cima-skeleton-text w-full"></div>
                        </div>
                    </div>
                }
            </div>
        }
        else if (FeaturedListings?.Any() == true)
        {
            <div class="cima-grid">
                @foreach (var listing in FeaturedListings)
                {
                    <ListingCard 
                        Listing="listing" 
                        OnCardFlipped="HandleCardFlipped"
                        @ref="@_cardRefs[listing.Id]" />
                }
            </div>

            <div class="text-center mt-12">
                <a href="/properties" class="cima-btn cima-btn-primary">
                    @L["Properties:ViewAll"]
                </a>
            </div>
        }
        else
        {
            <div class="text-center py-12">
                <svg class="w-16 h-16 mx-auto text-neutral-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                <p class="text-neutral-600">@L["Search:NoResults"]</p>
            </div>
        }
    </div>
</section>

@* General Contact Form Section *@
<section class="cima-section">
    <div class="cima-container max-w-2xl">
        <div class="text-center mb-8">
            <h2 class="text-3xl md:text-4xl font-display font-bold text-neutral-900 mb-4">
                @L["Contact:Title"]
            </h2>
            <p class="text-lg text-neutral-600">
                @L["Contact:Subtitle"]
            </p>
        </div>

        <GeneralContactForm />
    </div>
</section>

@code {
    private bool IsLoading { get; set; } = true;
    private List<ListingDto>? FeaturedListings { get; set; }
    private Dictionary<Guid, ListingCard> _cardRefs = new();
    private Guid? _currentFlippedCardId;

    protected override async Task OnInitializedAsync()
    {
        await LoadFeaturedListings();
    }

    private async Task LoadFeaturedListings()
    {
        try
        {
            IsLoading = true;
            
            // Obtener propiedades destacadas (publicadas, ordenadas por fecha)
            var result = await ListingService.GetPublishedAsync(new GetListingsInput
            {
                MaxResultCount = 6,
                SkipCount = 0,
                Sorting = "CreatedAt DESC"
            });

            FeaturedListings = result.Items.ToList();
        }
        catch (Exception ex)
        {
            await HandleErrorAsync(ex);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void HandleSearch(string searchTerm)
    {
        NavManager.NavigateTo($"/properties?search={Uri.EscapeDataString(searchTerm)}");
    }

    private void HandleCardFlipped(Guid listingId)
    {
        // Cerrar card previamente abierta
        if (_currentFlippedCardId.HasValue && 
            _currentFlippedCardId != listingId && 
            _cardRefs.TryGetValue(_currentFlippedCardId.Value, out var prevCard))
        {
            prevCard.Close();
        }

        _currentFlippedCardId = listingId;
    }
}
