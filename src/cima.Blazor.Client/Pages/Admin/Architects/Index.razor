@page "/admin/architects"
@using cima.Architects
@using cima.Permissions
@using MudBlazor
@attribute [Authorize(cimaPermissions.Architects.Default)]
@inject IArchitectAppService ArchitectService
@inject NavigationManager NavManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IJSRuntime JS
@inherits cimaComponentBase

<PageTitle>Gestionar Arquitectos - @L["CompanyName"]</PageTitle>

<div class="min-h-screen bg-neutral-50 pt-20"> @* pt-20 para compensar el navbar fixed *@
    <div class="bg-white border-b border-neutral-200">
        <div class="cima-container py-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                    <h1 class="text-2xl md:text-3xl font-display font-bold text-neutral-900">Gestionar Arquitectos</h1>
                    <p class="text-neutral-600 mt-1">Administra los perfiles de arquitectos del sistema</p>
                </div>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/admin/architects/create"
                    StartIcon="@Icons.Material.Filled.PersonAdd">
                    Nuevo Arquitecto
                </MudButton>
            </div>
        </div>
    </div>

    <div class="cima-container py-8">
        @if (IsLoading)
        {
            <MudCard Class="p-6">
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
                <p class="text-center mt-4 text-neutral-600">Cargando arquitectos...</p>
            </MudCard>
        }
        else if (Architects?.Any() == true)
        {
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                @foreach (var architect in Architects)
                {
                    <MudCard Class="rounded-xl">
                        <MudCardContent>
                            <div class="flex items-start gap-4 mb-4">
                                <MudAvatar Color="Color.Primary" Size="Size.Large">@GetInitials(architect.Name, architect.Surname)</MudAvatar>
                                <div class="flex-1 min-w-0">
                                    <h3 class="font-semibold text-lg text-neutral-900 truncate">
                                        @architect.Name @architect.Surname
                                    </h3>
                                    <p class="text-sm text-neutral-600 truncate">@architect.Email</p>
                                    <div class="flex items-center gap-2 mt-1">
                                        <MudChip T="string" Size="Size.Small" Color="@(architect.IsActive ? Color.Success : Color.Default)">
                                            @(architect.IsActive ? "Activo" : "Inactivo")
                                        </MudChip>
                                        @if (architect.MustChangePassword)
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Warning">
                                                Cambio pendiente
                                            </MudChip>
                                        }
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4 mb-4 pt-4 border-t border-neutral-200">
                                <div>
                                    <p class="text-2xl font-bold text-primary">@architect.TotalListingsPublished</p>
                                    <p class="text-xs text-neutral-600">Total Publicadas</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-green-600">@architect.ActiveListings</p>
                                    <p class="text-xs text-neutral-600">Activas</p>
                                </div>
                            </div>

                            <div class="text-xs text-neutral-500">
                                <p>Registro: @architect.RegistrationDate.ToString("dd/MM/yyyy")</p>
                            </div>
                        </MudCardContent>
                        <MudCardActions Class="justify-between">
                            <div>
                                @if (architect.IsActive)
                                {
                                    <MudButton Variant="Variant.Text" Color="Color.Error" Size="Size.Small"
                                        OnClick="@(() => DeactivateArchitect(architect.Id))">
                                        Desactivar
                                    </MudButton>
                                }
                                else
                                {
                                    <MudButton Variant="Variant.Text" Color="Color.Success" Size="Size.Small"
                                        OnClick="@(() => ActivateArchitect(architect.Id))">
                                        Activar
                                    </MudButton>
                                }
                            </div>
                            <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small">
                                <MudMenuItem Icon="@Icons.Material.Filled.Key" OnClick="@(() => HandleResetPassword(architect))">
                                    Restablecer Contraseña
                                </MudMenuItem>
                                @if (architect.ActiveListings == 0 && architect.TotalListingsPublished == 0)
                                {
                                    <MudMenuItem Icon="@Icons.Material.Filled.Delete" IconColor="Color.Error"
                                        OnClick="@(() => DeleteArchitect(architect))">
                                        Eliminar
                                    </MudMenuItem>
                                }
                            </MudMenu>
                        </MudCardActions>
                    </MudCard>
                }
            </div>
        }
        else
        {
            <MudCard Class="p-16 text-center">
                <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Large" Class="text-neutral-400 mb-4" Style="font-size: 4rem;" />
                <h3 class="text-xl font-semibold text-neutral-900 mb-2">No hay arquitectos registrados</h3>
                <p class="text-neutral-600 mb-6">Comienza creando el primer arquitecto</p>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/admin/architects/create"
                    StartIcon="@Icons.Material.Filled.PersonAdd">
                    Crear Arquitecto
                </MudButton>
            </MudCard>
        }
    </div>
</div>

@* Dialog para mostrar contraseña temporal después de reset *@
<MudDialog @bind-Visible="ShowResetDialog" Options="@(new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Key" Color="Color.Warning" Class="mr-2" />
            Contraseña Restablecida
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudAlert Severity="Severity.Warning" Class="mb-4">
            <strong>¡Importante!</strong> Comparte esta contraseña de forma segura con el arquitecto.
        </MudAlert>

        <MudText Typo="Typo.body1" Class="mb-2">Arquitecto: <strong>@ResetArchitectName</strong></MudText>

        <MudTextField Value="@NewTempPassword" Label="Nueva Contraseña Temporal" ReadOnly="true"
            Variant="Variant.Outlined" Adornment="Adornment.End"
            AdornmentIcon="@Icons.Material.Filled.ContentCopy"
            OnAdornmentClick="CopyResetPassword" />

        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
            El arquitecto deberá cambiar esta contraseña en su próximo inicio de sesión.
        </MudText>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => ShowResetDialog = false)">
            Entendido
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private bool IsLoading { get; set; } = true;
    private List<ArchitectDto>? Architects { get; set; }

    private bool ShowResetDialog { get; set; }
    private string ResetArchitectName { get; set; } = "";
    private string NewTempPassword { get; set; } = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadArchitects();
    }

    private async Task LoadArchitects()
    {
        try
        {
            IsLoading = true;
            var result = await ArchitectService.GetListAsync(new Volo.Abp.Application.Dtos.PagedAndSortedResultRequestDto
            {
                MaxResultCount = 100,
                Sorting = "RegistrationDate DESC"
            });
            Architects = result.Items.ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task DeactivateArchitect(Guid id)
    {
        var result = await DialogService.ShowMessageBox(
            "Desactivar Arquitecto",
            "¿Estás seguro? El arquitecto no podrá iniciar sesión.",
            yesText: "Desactivar", cancelText: "Cancelar");

        if (result == true)
        {
            try
            {
                await ArchitectService.UpdateAsync(id, new UpdateArchitectDto { IsActive = false });
                Snackbar.Add("Arquitecto desactivado", Severity.Success);
                await LoadArchitects();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task ActivateArchitect(Guid id)
    {
        try
        {
            await ArchitectService.UpdateAsync(id, new UpdateArchitectDto { IsActive = true });
            Snackbar.Add("Arquitecto activado", Severity.Success);
            await LoadArchitects();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task HandleResetPassword(ArchitectDto architect)
    {
        var result = await DialogService.ShowMessageBox(
            "Restablecer Contraseña",
            $"¿Generar una nueva contraseña temporal para {architect.Name} {architect.Surname}?",
            yesText: "Restablecer", cancelText: "Cancelar");

        if (result == true)
        {
            try
            {
                var newPassword = await ArchitectService.ResetPasswordAsync(architect.Id, new ResetArchitectPasswordDto());
                
                ResetArchitectName = $"{architect.Name} {architect.Surname}";
                NewTempPassword = newPassword;
                ShowResetDialog = true;
                
                await LoadArchitects();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DeleteArchitect(ArchitectDto architect)
    {
        var result = await DialogService.ShowMessageBox(
            "Eliminar Arquitecto",
            $"¿Eliminar permanentemente a {architect.Name} {architect.Surname}? Esta acción no se puede deshacer.",
            yesText: "Eliminar", cancelText: "Cancelar");

        if (result == true)
        {
            try
            {
                await ArchitectService.DeleteAsync(architect.Id);
                Snackbar.Add("Arquitecto eliminado", Severity.Success);
                await LoadArchitects();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task CopyResetPassword()
    {
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", NewTempPassword);
            Snackbar.Add("Contraseña copiada al portapapeles", Severity.Success);
        }
        catch
        {
            Snackbar.Add("No se pudo copiar. Copia manualmente.", Severity.Warning);
        }
    }

    private string GetInitials(string? name, string? surname)
    {
        var first = !string.IsNullOrWhiteSpace(name) ? name[0].ToString().ToUpper() : "";
        var last = !string.IsNullOrWhiteSpace(surname) ? surname[0].ToString().ToUpper() : "";
        return $"{first}{last}";
    }
}
