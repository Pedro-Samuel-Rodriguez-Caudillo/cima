@page "/admin/architects"
@using cima.Architects
@using cima.Permissions
@using cima.Listings
@attribute [Authorize(cimaPermissions.Architects.Default)]
@inject IArchitectAppService ArchitectService
@inject IListingSaleAppService ListingSaleService
@inject IJSRuntime JS
@inject IDialogService DialogService
@inherits cimaComponentBase

<PageTitle>@L["Admin:Architects:Title"] - @L["CompanyName"]</PageTitle>

<ErrorBoundary>
    <ErrorContent Context="exception">
        <PageShell>
            <div class="cima-container py-10">
                <MudAlert Severity="Severity.Error">
                    @GetUserFriendlyErrorMessage(exception)
                </MudAlert>
            </div>
        </PageShell>
    </ErrorContent>
    <ChildContent>
        <PageShell>
    <div class="bg-white border-b border-neutral-200">
        <div class="cima-container py-6">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <div>
                    <h1 class="text-2xl md:text-3xl font-display font-bold text-neutral-900">
                        @L["Admin:Architects:Title"]
                    </h1>
                    <p class="text-neutral-600 mt-1">
                        @L["Admin:Architects:Subtitle"]
                    </p>
                </div>
                <div class="flex items-center gap-2">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/admin/architects/create"
                        StartIcon="@Icons.Material.Filled.PersonAdd">
                        @L["Admin:Architects:Create"]
                    </MudButton>
                </div>
            </div>
        </div>
    </div>

    <div class="cima-container py-8">
        @if (IsLoading)
        {
            <div class="flex justify-center py-12">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
            </div>
        }
        else if (Architects?.Any() == true)
        {
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                @foreach (var architect in Architects)
                {
                    <MudCard Class="cima-card h-full flex flex-col cursor-pointer"
                             @ondblclick="@(() => OpenArchitectDetails(architect))">
                        <MudCardHeader>
                            <CardHeaderAvatar>
                                <MudAvatar Color="Color.Primary" Variant="Variant.Filled" Size="Size.Large">
                                    @GetInitials(architect.Name, architect.Surname)
                                </MudAvatar>
                            </CardHeaderAvatar>
                            <CardHeaderContent>
                                <MudText Typo="Typo.body1" Class="font-bold">@architect.Name @architect.Surname</MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">@architect.UserName</MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                <MudChip T="string" Size="Size.Small" 
                                    Color="@(architect.IsActive ? Color.Success : Color.Default)"
                                    Variant="Variant.Text">
                                    @(architect.IsActive ? L["Admin:Architects:Active"] : L["Admin:Architects:Inactive"])
                                </MudChip>
                            </CardHeaderActions>
                        </MudCardHeader>
                        <MudCardContent Class="flex-grow pt-0">
                            <div class="grid grid-cols-2 gap-2 text-center mt-2">
                                <div class="bg-neutral-50 p-2 rounded">
                                    <MudText Typo="Typo.h6" Color="Color.Primary">@architect.ActiveListings</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@L["Admin:Architects:ActiveListingsCount"]</MudText>
                                </div>
                                <div class="bg-neutral-50 p-2 rounded">
                                    <MudText Typo="Typo.h6">@architect.TotalListingsPublished</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@L["Admin:Architects:TotalPublishedCount"]</MudText>
                                </div>
                            </div>
                        </MudCardContent>
                        <MudCardActions Class="border-t border-neutral-100 flex justify-between px-4">
                            <div class="flex gap-1">
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small"
                                    Href="@($"/admin/architects/edit/{architect.Id}")" />
                                
                                @if (architect.IsActive)
                                {
                                    <MudButton Variant="Variant.Text" Color="Color.Warning" Size="Size.Small"
                                        OnClick="@(() => DeactivateArchitect(architect.Id))">
                                        @L["Admin:Architects:DeactivateAction"]
                                    </MudButton>
                                }
                                else
                                {
                                    <MudButton Variant="Variant.Text" Color="Color.Success" Size="Size.Small"
                                        OnClick="@(() => ActivateArchitect(architect.Id))">
                                        @L["Admin:Architects:ActivateAction"]
                                    </MudButton>
                                }
                            </div>
                            <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small">
                                <MudMenuItem Icon="@Icons.Material.Filled.Key" OnClick="@(() => HandleResetPassword(architect))">
                                    @L["Admin:Architects:ResetPasswordAction"]
                                </MudMenuItem>
                                @if (architect.ActiveListings == 0 && architect.TotalListingsPublished == 0)
                                {
                                    <MudMenuItem Icon="@Icons.Material.Filled.Delete" IconColor="Color.Error"
                                        OnClick="@(() => DeleteArchitect(architect))">
                                        @L["Common:Delete"]
                                    </MudMenuItem>
                                }
                            </MudMenu>
                        </MudCardActions>
                    </MudCard>
                }
            </div>
        }
        else
        {
            <MudCard Class="p-16 text-center">
                <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Large" Class="text-neutral-400 mb-4" Style="font-size: 4rem;" />
                <h3 class="text-xl font-semibold text-neutral-900 mb-2">@L["Admin:Architects:NoArchitectsFound"]</h3>
                <p class="text-neutral-600 mb-6">@L["Admin:Architects:NoArchitectsFoundDetail"]</p>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/admin/architects/create"
                    StartIcon="@Icons.Material.Filled.PersonAdd">
                    @L["Admin:Architects:Create"]
                </MudButton>
            </MudCard>
        }
    </div>
        </PageShell>
    </ChildContent>
</ErrorBoundary>

@* Dialog para mostrar contraseña temporal después de reset *@
<MudDialog @bind-Visible="ShowResetDialog" Options="@(new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Key" Color="Color.Warning" Class="mr-2" />
            @L["Admin:Architects:ResetDialog:Title"]
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudAlert Severity="Severity.Warning" Class="mb-4">
            <strong>@L["Admin:Architects:ResetDialog:Important"]</strong> @L["Admin:Architects:ResetDialog:Instruction"]
        </MudAlert>

        <MudText Typo="Typo.body1" Class="mb-2">@L["Profile:AccountDetails"]: <strong>@ResetArchitectName</strong></MudText>

        <MudTextField Value="@NewTempPassword" Label="@L["Admin:Architects:ResetDialog:TempPasswordLabel"]" ReadOnly="true"
            Variant="Variant.Outlined" Adornment="Adornment.End"
            AdornmentIcon="@Icons.Material.Filled.ContentCopy"
            OnAdornmentClick="CopyResetPassword" />

        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
            @L["Admin:Architects:ResetDialog:Footer"]
        </MudText>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => ShowResetDialog = false)">
            @L["Common:Ok"]
        </MudButton>
    </DialogActions>
</MudDialog>

@* Dialog detalle arquitecto *@
<MudDialog @bind-Visible="ShowDetailDialog" Options="@(new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Person" Class="mr-2" />
            @SelectedArchitectName
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (SelectedArchitect is null)
        {
            <MudText Typo="Typo.body2" Color="Color.Secondary">@L["Common:NotSet"]</MudText>
        }
        else
        {
            <MudStack Spacing="2">
                <MudStack Spacing="0">
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Admin:Architects:Username"]</MudText>
                    <MudText Typo="Typo.body2">@SelectedArchitect.UserName</MudText>
                </MudStack>
                <MudStack Spacing="0">
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Common:Email"]</MudText>
                    <MudText Typo="Typo.body2">@SelectedArchitect.Email</MudText>
                </MudStack>
                <MudStack Row="true" Spacing="2" Class="flex-wrap">
                    <MudPaper Class="p-3" Elevation="0">
                        <MudText Typo="Typo.h6" Color="Color.Primary">@SelectedArchitect.ActiveListings</MudText>
                        <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Admin:Architects:ActiveListingsCount"]</MudText>
                    </MudPaper>
                    <MudPaper Class="p-3" Elevation="0">
                        <MudText Typo="Typo.h6">@SelectedArchitect.TotalListingsPublished</MudText>
                        <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Admin:Architects:TotalPublishedCount"]</MudText>
                    </MudPaper>
                    <MudPaper Class="p-3" Elevation="0">
                        <MudText Typo="Typo.h6">@SelectedSalesSummary?.TotalSales ?? 0</MudText>
                        <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Sales:Summary:TotalSales"]</MudText>
                    </MudPaper>
                    <MudPaper Class="p-3" Elevation="0">
                        <MudText Typo="Typo.h6">@FormatAmount(SelectedSalesSummary?.TotalAmount ?? 0m)</MudText>
                        <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Sales:Summary:TotalAmount"]</MudText>
                    </MudPaper>
                </MudStack>
                @if (IsSalesSummaryLoading)
                {
                    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mt-2" />
                }
                else if (SelectedSalesSummary?.LastSaleAt != null)
                {
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">
                        @string.Format(L["Sales:Summary:LastSale"], SelectedSalesSummary.LastSaleAt.Value.ToLocalTime().ToString("dd MMM yyyy"))
                    </MudText>
                }
                <MudChip T="string" Size="Size.Small"
                         Color="@(SelectedArchitect.IsActive ? Color.Success : Color.Default)">
                    @(SelectedArchitect.IsActive ? L["Admin:Architects:Active"] : L["Admin:Architects:Inactive"])
                </MudChip>
            </MudStack>
        }
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="@(() => ShowDetailDialog = false)">@L["Common:Close"]</MudButton>
        @if (SelectedArchitect is not null)
        {
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="@($"/admin/architects/edit/{SelectedArchitect.Id}")">
                @L["Admin:Architects:Edit"]
            </MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    private bool IsLoading { get; set; } = true;
    private List<ArchitectDto>? Architects { get; set; }

    private bool ShowResetDialog { get; set; }
    private string ResetArchitectName { get; set; } = "";
    private string NewTempPassword { get; set; } = "";
    private bool ShowDetailDialog { get; set; }
    private ArchitectDto? SelectedArchitect { get; set; }
    private ArchitectSalesSummaryDto? SelectedSalesSummary { get; set; }
    private bool IsSalesSummaryLoading { get; set; }

    private string SelectedArchitectName =>
        SelectedArchitect == null
            ? L["Common:NotSet"]
            : $"{SelectedArchitect.Name} {SelectedArchitect.Surname}".Trim();

    private void OpenArchitectDetails(ArchitectDto architect)
    {
        SelectedArchitect = architect;
        SelectedSalesSummary = null;
        ShowDetailDialog = true;
        _ = LoadSalesSummaryAsync(architect.Id);
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadArchitects();
    }

    private async Task LoadArchitects()
    {
        try
        {
            IsLoading = true;
            var result = await ArchitectService.GetListAsync(new Volo.Abp.Application.Dtos.PagedAndSortedResultRequestDto
            {
                MaxResultCount = 100,
                Sorting = "RegistrationDate DESC"
            });
            Architects = result.Items.ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(L["Dashboard:Error:LoadingStats"], GetUserFriendlyErrorMessage(ex)), Severity.Error);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task DeactivateArchitect(Guid id)
    {
        var result = await DialogService.ShowMessageBox(
            L["Admin:Architects:Dialog:DeactivateTitle"],
            L["Admin:Architects:Dialog:DeactivateConfirm"],
            yesText: L["Admin:Architects:DeactivateAction"], cancelText: L["Common:Cancel"]);

        if (result == true)
        {
            try
            {
                await ArchitectService.UpdateAsync(id, new UpdateArchitectDto { IsActive = false });
                Snackbar.Add(L["Admin:Architects:Success:Deactivated"], Severity.Success);
                await LoadArchitects();
            }
            catch (Exception ex)
            {
                Snackbar.Add(GetUserFriendlyErrorMessage(ex), Severity.Error);
            }
        }
    }

    private async Task ActivateArchitect(Guid id)
    {
        try
        {
            await ArchitectService.UpdateAsync(id, new UpdateArchitectDto { IsActive = true });
            Snackbar.Add(L["Admin:Architects:Success:Activated"], Severity.Success);
            await LoadArchitects();
        }
        catch (Exception ex)
        {
            Snackbar.Add(GetUserFriendlyErrorMessage(ex), Severity.Error);
        }
    }

    private async Task HandleResetPassword(ArchitectDto architect)
    {
        var result = await DialogService.ShowMessageBox(
            L["Admin:Architects:ResetPasswordAction"],
            string.Format(L["Admin:Architects:Dialog:DeleteConfirm"], $"{architect.Name} {architect.Surname}"),
            yesText: L["Admin:Architects:ResetPasswordAction"], cancelText: L["Common:Cancel"]);

        if (result == true)
        {
            try
            {
                var newPassword = await ArchitectService.ResetPasswordAsync(architect.Id, new ResetArchitectPasswordDto());

                ResetArchitectName = $"{architect.Name} {architect.Surname}";
                NewTempPassword = newPassword;
                ShowResetDialog = true;

                await LoadArchitects();
            }
            catch (Exception ex)
            {
                Snackbar.Add(GetUserFriendlyErrorMessage(ex), Severity.Error);
            }
        }
    }

    private async Task DeleteArchitect(ArchitectDto architect)
    {
        var result = await DialogService.ShowMessageBox(
            L["Admin:Architects:Dialog:DeleteTitle"],
            string.Format(L["Admin:Architects:Dialog:DeleteConfirm"], $"{architect.Name} {architect.Surname}"),
            yesText: L["Common:Delete"], cancelText: L["Common:Cancel"]);

        if (result == true)
        {
            try
            {
                await ArchitectService.DeleteAsync(architect.Id);
                Snackbar.Add(L["Admin:Architects:Success:Deleted"], Severity.Success);
                await LoadArchitects();
            }
            catch (Exception ex)
            {
                Snackbar.Add(GetUserFriendlyErrorMessage(ex), Severity.Error);
            }
        }
    }

    private async Task CopyResetPassword()
    {
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", NewTempPassword);
            Snackbar.Add(L["Common:Copied"], Severity.Success);
        }
        catch
        {
            Snackbar.Add(L["Common:CopyError"], Severity.Warning);
        }
    }

    private string GetInitials(string? name, string? surname)
    {
        var first = !string.IsNullOrWhiteSpace(name) ? name[0].ToString().ToUpper() : "";
        var last = !string.IsNullOrWhiteSpace(surname) ? surname[0].ToString().ToUpper() : "";
        return $"{first}{last}";
    }

    private async Task LoadSalesSummaryAsync(Guid architectId)
    {
        try
        {
            IsSalesSummaryLoading = true;
            SelectedSalesSummary = await ListingSaleService.GetSummaryByArchitectIdAsync(architectId);
        }
        catch (Exception ex)
        {
            SelectedSalesSummary = null;
            Snackbar.Add(GetUserFriendlyErrorMessage(ex), Severity.Error);
        }
        finally
        {
            IsSalesSummaryLoading = false;
            StateHasChanged();
        }
    }

    private static string FormatAmount(decimal amount) =>
        amount.ToString("C0", System.Globalization.CultureInfo.GetCultureInfo("es-MX"));
}
