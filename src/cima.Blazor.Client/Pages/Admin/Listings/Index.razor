@page "/admin/listings"
@using cima.Listings
@using cima.Domain.Shared.Dtos
@using cima.Domain.Shared
@using cima.Blazor.Client.Services
@using cima.Permissions
@attribute [Authorize(cimaPermissions.Listings.Default)]
@inject IListingAppService ListingService
@inject EnumLocalizationService EnumLocalizer
@inject NavigationManager NavManager
@inject IUiMessageService MessageService
@inherits cimaComponentBase

<PageTitle>@L["Admin:Listings:Title"] - @L["CompanyName"]</PageTitle>

<div class="min-h-screen bg-neutral-50">
    @* Header *@
    <div class="bg-white border-b border-neutral-200">
        <div class="cima-container py-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                    <h1 class="text-2xl md:text-3xl font-display font-bold text-neutral-900">
                        @L["Admin:Listings:Title"]
                    </h1>
                    <p class="text-neutral-600 mt-1">
                        Gestiona el catálogo de propiedades
                    </p>
                </div>
                <a href="/admin/listings/create" class="cima-btn cima-btn-primary">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    @L["Admin:Listings:Create"]
                </a>
            </div>
        </div>
    </div>

    @* Filters *@
    <div class="bg-white border-b border-neutral-200">
        <div class="cima-container py-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                @* Search *@
                <div>
                    <input 
                        type="search" 
                        class="cima-input" 
                        placeholder="@L["Search"]..."
                        @bind="SearchTerm"
                        @bind:event="oninput"
                        @onkeyup="HandleSearchKeyUp" />
                </div>

                @* Status Filter *@
                <div>
                    <select class="cima-input" value="@StatusFilter" @onchange="@(e => { StatusFilter = e.Value?.ToString(); LoadListings(); })">
                        <option value="">@L["Common:All"] (@L["Common:Status"])</option>
                        <option value="@((int)ListingStatus.Draft)">@EnumLocalizer.GetListingStatusName(ListingStatus.Draft)</option>
                        <option value="@((int)ListingStatus.Published)">@EnumLocalizer.GetListingStatusName(ListingStatus.Published)</option>
                        <option value="@((int)ListingStatus.Archived)">@EnumLocalizer.GetListingStatusName(ListingStatus.Archived)</option>
                        <option value="@((int)ListingStatus.Portfolio)">@EnumLocalizer.GetListingStatusName(ListingStatus.Portfolio)</option>
                    </select>
                </div>

                @* Category Filter *@
                <div>
                    <select class="cima-input" value="@CategoryFilter" @onchange="@(e => { CategoryFilter = e.Value?.ToString(); LoadListings(); })">
                        <option value="">@L["Common:All"] (@L["Search:PropertyCategory"])</option>
                        <option value="@((int)PropertyCategory.Residential)">@EnumLocalizer.GetPropertyCategoryName(PropertyCategory.Residential)</option>
                        <option value="@((int)PropertyCategory.Commercial)">@EnumLocalizer.GetPropertyCategoryName(PropertyCategory.Commercial)</option>
                        <option value="@((int)PropertyCategory.Mixed)">@EnumLocalizer.GetPropertyCategoryName(PropertyCategory.Mixed)</option>
                        <option value="@((int)PropertyCategory.Land)">@EnumLocalizer.GetPropertyCategoryName(PropertyCategory.Land)</option>
                    </select>
                </div>

                @* Transaction Type Filter *@
                <div>
                    <select class="cima-input" value="@TransactionFilter" @onchange="@(e => { TransactionFilter = e.Value?.ToString(); LoadListings(); })">
                        <option value="">@L["Common:All"] (@L["Search:TransactionType"])</option>
                        <option value="@((int)TransactionType.Sale)">@EnumLocalizer.GetTransactionTypeName(TransactionType.Sale)</option>
                        <option value="@((int)TransactionType.Rent)">@EnumLocalizer.GetTransactionTypeName(TransactionType.Rent)</option>
                        <option value="@((int)TransactionType.Lease)">@EnumLocalizer.GetTransactionTypeName(TransactionType.Lease)</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    @* Content *@
    <div class="cima-container py-8">
        @if (IsLoading)
        {
            <div class="cima-card">
                <div class="p-6 space-y-4">
                    @for (int i = 0; i < 5; i++)
                    {
                        <div class="flex items-center gap-4">
                            <div class="cima-skeleton-image w-20 h-20"></div>
                            <div class="flex-1 space-y-2">
                                <div class="cima-skeleton-text w-3/4"></div>
                                <div class="cima-skeleton-text w-1/2"></div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
        else if (Listings?.Any() == true)
        {
            <div class="cima-card overflow-hidden">
                @* Table Header *@
                <div class="hidden lg:grid lg:grid-cols-12 gap-4 p-4 bg-neutral-50 border-b border-neutral-200 text-sm font-medium text-neutral-700">
                    <div class="col-span-4">@L["Properties:Title"]</div>
                    <div class="col-span-2">@L["Search:PropertyCategory"]</div>
                    <div class="col-span-2">@L["Properties:Price"]</div>
                    <div class="col-span-2">@L["Common:Status"]</div>
                    <div class="col-span-2 text-right">@L["Common:Actions"]</div>
                </div>

                @* Table Body *@
                <div class="divide-y divide-neutral-200">
                    @foreach (var listing in Listings)
                    {
                        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 p-4 hover:bg-neutral-50 transition-colors">
                            @* Title + Image (Mobile & Desktop) *@
                            <div class="col-span-1 lg:col-span-4 flex items-center gap-3">
                                <div class="w-16 h-16 bg-neutral-200 rounded overflow-hidden flex-shrink-0">
                                    @if (listing.Images?.Any() == true)
                                    {
                                        <img src="@listing.Images.First().Url" alt="@listing.Title" class="w-full h-full object-cover" />
                                    }
                                    else
                                    {
                                        <div class="w-full h-full flex items-center justify-center">
                                            <svg class="w-6 h-6 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                        </div>
                                    }
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="font-semibold text-neutral-900 truncate">@listing.Title</div>
                                    <div class="text-sm text-neutral-600 truncate">@listing.Location</div>
                                </div>
                            </div>

                            @* Category *@
                            <div class="col-span-1 lg:col-span-2 flex items-center">
                                <span class="text-sm text-neutral-700">
                                    <span class="lg:hidden font-medium mr-2">@L["Search:PropertyCategory"]:</span>
                                    @EnumLocalizer.GetPropertyCategoryName(listing.Category)
                                </span>
                            </div>

                            @* Price *@
                            <div class="col-span-1 lg:col-span-2 flex items-center">
                                <span class="text-sm font-semibold text-neutral-900">
                                    <span class="lg:hidden font-medium mr-2">@L["Properties:Price"]:</span>
                                    @listing.Price.ToString("C0", new System.Globalization.CultureInfo("es-MX"))
                                </span>
                            </div>

                            @* Status *@
                            <div class="col-span-1 lg:col-span-2 flex items-center">
                                <span class="@GetStatusBadgeClass(listing.Status)">
                                    @EnumLocalizer.GetListingStatusName(listing.Status)
                                </span>
                            </div>

                            @* Actions *@
                            <div class="col-span-1 lg:col-span-2 flex items-center justify-start lg:justify-end gap-2">
                                <a href="/admin/listings/edit/@listing.Id" class="cima-btn cima-btn-sm cima-btn-secondary">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                              d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                    <span class="ml-1">@L["Common:Edit"]</span>
                                </a>

                                @if (listing.Status == ListingStatus.Draft)
                                {
                                    <button @onclick="async () => await PublishListing(listing.Id)" class="cima-btn cima-btn-sm cima-btn-primary">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                                        </svg>
                                        <span class="ml-1">@L["Admin:Listings:Publish"]</span>
                                    </button>
                                }
                                else if (listing.Status == ListingStatus.Published)
                                {
                                    <button @onclick="async () => await ArchiveListing(listing.Id)" class="cima-btn cima-btn-sm cima-btn-secondary">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                                  d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                                        </svg>
                                        <span class="ml-1">@L["Admin:Listings:Archive"]</span>
                                    </button>
                                }

                                <button @onclick="async () => await DeleteListing(listing.Id)" class="cima-btn cima-btn-sm cima-btn-danger">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                              d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    }
                </div>
            </div>

            @* Pagination *@
            @if (TotalPages > 1)
            {
                <div class="mt-6 flex justify-center items-center gap-2">
                    <button 
                        @onclick="PreviousPage"
                        disabled="@(CurrentPage == 1)"
                        class="cima-btn cima-btn-secondary disabled:opacity-50 disabled:cursor-not-allowed">
                        @L["Common:Previous"]
                    </button>

                    <div class="flex gap-1">
                        @{
                            var maxVisiblePages = Math.Min(TotalPages, 5);
                            var startPage = Math.Max(1, CurrentPage - 2);
                            var endPage = Math.Min(TotalPages, startPage + maxVisiblePages - 1);
                            
                            for (int i = startPage; i <= endPage; i++)
                            {
                                var pageNum = i;
                                <button 
                                    @onclick="@(() => GoToPage(pageNum))"
                                    class="@GetPageButtonClass(pageNum)">
                                    @pageNum
                                </button>
                            }
                        }
                    </div>

                    <button 
                        @onclick="NextPage"
                        disabled="@(CurrentPage == TotalPages)"
                        class="cima-btn cima-btn-secondary disabled:opacity-50 disabled:cursor-not-allowed">
                        @L["Common:Next"]
                    </button>
                </div>
            }
        }
        else
        {
            <div class="cima-card p-16 text-center">
                <svg class="w-20 h-20 mx-auto text-neutral-400 mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <h3 class="text-xl font-semibold text-neutral-900 mb-2">
                    No hay propiedades
                </h3>
                <p class="text-neutral-600 mb-6">
                    Comienza agregando tu primera propiedad al catálogo
                </p>
                <a href="/admin/listings/create" class="cima-btn cima-btn-primary">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    @L["Admin:Listings:Create"]
                </a>
            </div>
        }
    </div>
</div>

@code {
    private bool IsLoading { get; set; } = true;
    private List<ListingDto>? Listings { get; set; }
    private int TotalCount { get; set; }
    private int CurrentPage { get; set; } = 1;
    private const int PageSize = 20;
    private int TotalPages => (int)Math.Ceiling((double)TotalCount / PageSize);

    private string? SearchTerm { get; set; }
    private string? StatusFilter { get; set; }
    private string? CategoryFilter { get; set; }
    private string? TransactionFilter { get; set; }

    private System.Timers.Timer? _searchTimer;

    protected override async Task OnInitializedAsync()
    {
        _searchTimer = new System.Timers.Timer(500);
        _searchTimer.Elapsed += async (sender, e) =>
        {
            _searchTimer.Stop();
            await InvokeAsync(async () =>
            {
                CurrentPage = 1;
                await LoadListings();
                StateHasChanged();
            });
        };

        await LoadListings();
    }

    private void HandleSearchKeyUp()
    {
        _searchTimer?.Stop();
        _searchTimer?.Start();
    }

    private async Task LoadListings()
    {
        try
        {
            IsLoading = true;

            var input = new GetListingsInput
            {
                SkipCount = (CurrentPage - 1) * PageSize,
                MaxResultCount = PageSize,
                Sorting = "CreatedAt DESC",
                SearchTerm = SearchTerm,
                Status = !string.IsNullOrEmpty(StatusFilter) ? int.Parse(StatusFilter) : null,
                PropertyCategory = !string.IsNullOrEmpty(CategoryFilter) ? int.Parse(CategoryFilter) : null,
                TransactionType = !string.IsNullOrEmpty(TransactionFilter) ? int.Parse(TransactionFilter) : null
            };

            var result = await ListingService.GetListAsync(input);
            
            Listings = result.Items.ToList();
            TotalCount = (int)result.TotalCount;
        }
        catch (Exception ex)
        {
            await HandleErrorAsync(ex);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task PublishListing(Guid id)
    {
        try
        {
            await ListingService.PublishAsync(id);
            await MessageService.Success("Propiedad publicada exitosamente");
            await LoadListings();
        }
        catch (Exception ex)
        {
            await HandleErrorAsync(ex);
        }
    }

    private async Task ArchiveListing(Guid id)
    {
        try
        {
            await ListingService.ArchiveAsync(id);
            await MessageService.Success("Propiedad archivada exitosamente");
            await LoadListings();
        }
        catch (Exception ex)
        {
            await HandleErrorAsync(ex);
        }
    }

    private async Task DeleteListing(Guid id)
    {
        var confirmed = await MessageService.Confirm("¿Estás seguro de eliminar esta propiedad?");
        if (!confirmed)
            return;

        try
        {
            await ListingService.DeleteAsync(id);
            await MessageService.Success("Propiedad eliminada exitosamente");
            await LoadListings();
        }
        catch (Exception ex)
        {
            await HandleErrorAsync(ex);
        }
    }

    private async Task GoToPage(int page)
    {
        CurrentPage = page;
        await LoadListings();
    }

    private async Task PreviousPage()
    {
        if (CurrentPage > 1)
            await GoToPage(CurrentPage - 1);
    }

    private async Task NextPage()
    {
        if (CurrentPage < TotalPages)
            await GoToPage(CurrentPage + 1);
    }

    private string GetPageButtonClass(int page)
    {
        var baseClass = "px-4 py-2 text-sm font-medium rounded transition-colors";
        
        if (page == CurrentPage)
            return $"{baseClass} bg-navy-500 text-white";
        
        return $"{baseClass} bg-neutral-100 text-neutral-700 hover:bg-neutral-200";
    }

    private string GetStatusBadgeClass(ListingStatus status)
    {
        return status switch
        {
            ListingStatus.Published => "px-3 py-1 text-xs font-medium rounded-full bg-success-light text-success",
            ListingStatus.Draft => "px-3 py-1 text-xs font-medium rounded-full bg-warning-light text-warning",
            ListingStatus.Archived => "px-3 py-1 text-xs font-medium rounded-full bg-neutral-200 text-neutral-700",
            ListingStatus.Portfolio => "px-3 py-1 text-xs font-medium rounded-full bg-navy-100 text-navy-700",
            _ => "px-3 py-1 text-xs font-medium rounded-full bg-neutral-100 text-neutral-600"
        };
    }

    public void Dispose()
    {
        _searchTimer?.Dispose();
    }
}
