@page "/admin/listings/create"
@page "/admin/listings/edit/{Id:guid}"
@using cima.Listings
@using cima.Architects
@using cima.Domain.Shared
@using cima.Blazor.Client.Services
@using cima.Blazor.Client.Components.Admin
@using cima.Permissions
@using MudBlazor
@using System.Globalization
@attribute [Authorize(cimaPermissions.Listings.Default)]
@inject IListingAppService ListingService
@inject IArchitectAppService ArchitectService
@inject EnumLocalizationService EnumLocalizer
@inject NavigationManager NavManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inherits cimaComponentBase

<PageTitle>@PageTitle - @L["CompanyName"]</PageTitle>

<div class="min-h-screen bg-neutral-50 pt-20"> @* pt-20 para compensar el navbar fixed *@
    <div class="bg-white border-b border-neutral-200">
        <div class="cima-container py-6">
            <div class="flex items-center gap-4 mb-2">
                <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.ArrowBack" Href="/admin/listings">
                    Volver
                </MudButton>
            </div>
            <h1 class="text-2xl md:text-3xl font-display font-bold text-neutral-900">@PageTitle</h1>
        </div>
    </div>

    <div class="cima-container py-8">
        @if (IsLoading)
        {
            <MudCard Class="p-8">
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
                <p class="text-center mt-4">Cargando...</p>
            </MudCard>
        }
        else if (!CanCreateListings)
        {
            <MudAlert Severity="Severity.Warning" Class="mb-4">
                <strong>Sin perfil de arquitecto</strong>
                <p>Tu cuenta no tiene un perfil de arquitecto asociado. Contacta al administrador.</p>
            </MudAlert>
        }
        else if (IsAdmin && (Architects == null || !Architects.Any()))
        {
            <MudAlert Severity="Severity.Warning" Class="mb-4">
                <strong>No hay arquitectos disponibles</strong>
                <p>Primero debes crear al menos un arquitecto antes de poder crear propiedades.</p>
                <MudButton Variant="Variant.Text" Color="Color.Primary" Href="/admin/architects/create" Class="mt-2">
                    Crear Arquitecto
                </MudButton>
            </MudAlert>
        }
        else
        {
            <EditForm Model="@Model" OnValidSubmit="HandleSubmit" OnInvalidSubmit="HandleInvalidSubmit">
                <DataAnnotationsValidator />
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        <MudCard Class="p-6">
                            <h2 class="text-xl font-semibold text-neutral-900 mb-6">Informacion Basica</h2>
                            <div class="space-y-4">
                                <MudTextField @bind-Value="Model.Title" Label="Titulo" Required="true" 
                                    Variant="Variant.Outlined" Class="mb-4"
                                    For="@(() => Model.Title)" />
                                <MudTextField @bind-Value="Model.Description" Label="Descripcion" 
                                    Lines="4" Variant="Variant.Outlined" Class="mb-4"
                                    For="@(() => Model.Description)" />
                                <MudTextField @bind-Value="Model.Location" Label="Ubicacion" Required="true" 
                                    Variant="Variant.Outlined"
                                    For="@(() => Model.Location)" />
                            </div>
                        </MudCard>

                        <MudCard Class="p-6">
                            <h2 class="text-xl font-semibold text-neutral-900 mb-6">Detalles</h2>
                            <div class="grid grid-cols-2 gap-4">
                                <MudNumericField @bind-Value="Model.Price" Label="Precio (MXN)" 
                                    Variant="Variant.Outlined" 
                                    Culture="@MexicoCulture"
                                    Format="N0"
                                    For="@(() => Model.Price)" />
                                <MudNumericField @bind-Value="Model.LandArea" Label="Area Terreno (m²)" 
                                    Variant="Variant.Outlined" 
                                    Culture="@MexicoCulture"
                                    Format="N2"
                                    For="@(() => Model.LandArea)" />
                                <MudNumericField @bind-Value="Model.ConstructionArea" Label="Area Construccion (m²)" 
                                    Variant="Variant.Outlined" 
                                    Culture="@MexicoCulture"
                                    Format="N2"
                                    For="@(() => Model.ConstructionArea)" />
                                <MudNumericField @bind-Value="Model.Bedrooms" Label="Recamaras" 
                                    Variant="Variant.Outlined"
                                    For="@(() => Model.Bedrooms)" />
                                <MudNumericField @bind-Value="Model.Bathrooms" Label="Banos" 
                                    Variant="Variant.Outlined"
                                    For="@(() => Model.Bathrooms)" />
                                
                                <MudSelect T="PropertyCategory" @bind-Value="Model.Category" Label="Categoria" 
                                    Variant="Variant.Outlined" Required="true"
                                    For="@(() => Model.Category)">
                                    <MudSelectItem Value="PropertyCategory.Residential">Residencial</MudSelectItem>
                                    <MudSelectItem Value="PropertyCategory.Commercial">Comercial</MudSelectItem>
                                    <MudSelectItem Value="PropertyCategory.Mixed">Mixto</MudSelectItem>
                                    <MudSelectItem Value="PropertyCategory.Land">Terreno</MudSelectItem>
                                </MudSelect>

                                <MudSelect T="PropertyType" @bind-Value="Model.Type" Label="Tipo" 
                                    Variant="Variant.Outlined" Required="true"
                                    For="@(() => Model.Type)">
                                    <MudSelectItem Value="PropertyType.House">Casa</MudSelectItem>
                                    <MudSelectItem Value="PropertyType.Apartment">Departamento</MudSelectItem>
                                    <MudSelectItem Value="PropertyType.Condo">Condominio</MudSelectItem>
                                    <MudSelectItem Value="PropertyType.Townhouse">Townhouse</MudSelectItem>
                                    <MudSelectItem Value="PropertyType.Villa">Villa</MudSelectItem>
                                    <MudSelectItem Value="PropertyType.Office">Oficina</MudSelectItem>
                                </MudSelect>

                                @* Admin siempre ve el selector de arquitecto si hay arquitectos disponibles *@
                                @if (ShowArchitectSelector)
                                {
                                    <MudSelect T="Guid" @bind-Value="Model.ArchitectId" Label="Arquitecto" 
                                        Variant="Variant.Outlined" Required="true"
                                        For="@(() => Model.ArchitectId)">
                                        @foreach (var arch in Architects!)
                                        {
                                            <MudSelectItem Value="@arch.Id">@GetArchitectDisplayName(arch)</MudSelectItem>
                                        }
                                    </MudSelect>
                                }
                            </div>
                        </MudCard>

                        @* Galería de imágenes - disponible siempre que tengamos un ID *@
                        @if (CurrentListingId.HasValue)
                        {
                            <MudCard Class="p-6">
                                <ImageGalleryManager ListingId="@CurrentListingId.Value" 
                                    InitialImages="@(ExistingListing?.Images ?? new())" 
                                    ImagesChanged="HandleImagesChanged" />
                            </MudCard>
                        }
                        else
                        {
                            <MudCard Class="p-6">
                                <div class="text-center py-8 text-neutral-500">
                                    <MudIcon Icon="@Icons.Material.Filled.PhotoLibrary" Size="Size.Large" Class="mb-4" />
                                    <p class="font-medium">Galeria de Imagenes</p>
                                    <p class="text-sm mt-1">Guarda la propiedad primero para agregar imagenes</p>
                                </div>
                            </MudCard>
                        }
                    </div>

                    <div class="lg:col-span-1">
                        <div class="sticky top-24 space-y-6"> @* top-24 para navbar + padding *@
                            <MudCard Class="p-6">
                                <h3 class="font-semibold mb-4">Acciones</h3>
                                
                                @* Mostrar errores de validación si los hay *@
                                <ValidationSummary class="text-red-600 text-sm mb-4" />
                                
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" 
                                    ButtonType="ButtonType.Submit" Disabled="@IsSubmitting" Class="mb-2">
                                    @if (IsSubmitting)
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                        <span>Guardando...</span>
                                    }
                                    else
                                    {
                                        <span>Guardar</span>
                                    }
                                </MudButton>
                                <MudButton Variant="Variant.Outlined" FullWidth="true" Href="/admin/listings">
                                    Cancelar
                                </MudButton>
                            </MudCard>

                            @if (IsEditMode && ExistingListing != null)
                            {
                                <MudCard Class="p-6">
                                    <h3 class="font-semibold mb-4">Estado</h3>
                                    <MudChip T="string" Color="@GetStatusColor(ExistingListing.Status)" Class="mb-4">
                                        @EnumLocalizer.GetListingStatusName(ExistingListing.Status)
                                    </MudChip>

                                    <div class="space-y-2">
                                        @if (ExistingListing.Status == ListingStatus.Draft)
                                        {
                                            <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true" 
                                                Size="Size.Small" OnClick="PublishListing">
                                                Publicar
                                            </MudButton>
                                        }
                                        @if (ExistingListing.Status == ListingStatus.Published)
                                        {
                                            <MudButton Variant="Variant.Outlined" Color="Color.Warning" FullWidth="true" 
                                                Size="Size.Small" OnClick="ArchiveListing">
                                                Archivar
                                            </MudButton>
                                        }
                                    </div>
                                </MudCard>
                            }
                        </div>
                    </div>
                </div>
            </EditForm>
        }
    </div>
</div>

@code {
    [Parameter] public Guid? Id { get; set; }

    // Cultura mexicana para formato de números (comas para miles, punto para decimales)
    private static readonly CultureInfo MexicoCulture = new("es-MX");

    private bool IsEditMode => Id.HasValue && Id.Value != Guid.Empty;
    private string PageTitle => IsEditMode ? "Editar Propiedad" : "Nueva Propiedad";

    private bool IsLoading { get; set; } = true;
    private bool IsSubmitting { get; set; }
    private bool IsAdmin { get; set; }
    
    // Usuario puede crear listings si:
    // - Es arquitecto (tiene perfil propio), o
    // - Es admin Y hay arquitectos disponibles para asignar
    private bool CanCreateListings => CurrentArchitect != null || (IsAdmin && Architects?.Any() == true);
    
    // Mostrar selector de arquitecto si:
    // - Es admin (siempre debe poder elegir a quién asignar)
    // - O hay múltiples arquitectos y el usuario actual es uno de ellos
    private bool ShowArchitectSelector => IsAdmin && Architects != null && Architects.Any();
    
    private CreateUpdateListingDto Model { get; set; } = new() 
    { 
        Title = "", 
        Description = "",
        Category = PropertyCategory.Residential,
        Type = PropertyType.House,
        TransactionType = TransactionType.Sale
    };
    
    private List<ArchitectDto>? Architects { get; set; }
    private ArchitectDto? CurrentArchitect { get; set; }
    private ListingDto? ExistingListing { get; set; }
    
    // ID actual del listing (para modo edición o después de crear)
    private Guid? CurrentListingId => ExistingListing?.Id ?? (IsEditMode ? Id : null);

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Verificar si es admin
            IsAdmin = CurrentUser.IsInRole("admin");
            
            // Siempre intentar obtener el arquitecto actual (puede ser null para admin puro)
            try
            {
                CurrentArchitect = await ArchitectService.GetCurrentAsync();
            }
            catch
            {
                CurrentArchitect = null;
            }
            
            // Si es admin, SIEMPRE cargar lista de arquitectos
            if (IsAdmin)
            {
                await LoadArchitects();
            }
            
            // Establecer el arquitecto por defecto
            if (CurrentArchitect != null)
            {
                // Si el usuario tiene perfil de arquitecto, usarlo por defecto
                Model.ArchitectId = CurrentArchitect.Id;
            }
            else if (Architects?.Any() == true)
            {
                // Si es admin sin perfil propio, usar el primer arquitecto disponible
                Model.ArchitectId = Architects.First().Id;
            }
            
            // Si es modo edición, cargar el listing existente
            if (IsEditMode)
            {
                await LoadListing();
            }
        }
        catch (OperationCanceledException)
        {
            // Ignorar - navegación en progreso
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al inicializar: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task LoadArchitects()
    {
        try
        {
            var result = await ArchitectService.GetListAsync(
                new Volo.Abp.Application.Dtos.PagedAndSortedResultRequestDto { MaxResultCount = 100 });
            Architects = result.Items.ToList();
        }
        catch (OperationCanceledException)
        {
            // Ignorar - navegación en progreso
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar arquitectos: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadListing()
    {
        try
        {
            if (!Id.HasValue) return;
            ExistingListing = await ListingService.GetAsync(Id.Value);
            
            Model = new CreateUpdateListingDto
            {
                Title = ExistingListing.Title,
                Description = ExistingListing.Description,
                Location = ExistingListing.Location,
                Price = ExistingListing.Price,
                LandArea = ExistingListing.LandArea,
                ConstructionArea = ExistingListing.ConstructionArea,
                Bedrooms = ExistingListing.Bedrooms,
                Bathrooms = ExistingListing.Bathrooms,
                Category = ExistingListing.Category,
                Type = ExistingListing.Type,
                TransactionType = ExistingListing.TransactionType,
                ArchitectId = ExistingListing.ArchitectId
            };
        }
        catch (OperationCanceledException)
        {
            // Ignorar - navegación en progreso
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar propiedad: {ex.Message}", Severity.Error);
            NavManager.NavigateTo("/admin/listings");
        }
    }

    private string GetArchitectDisplayName(ArchitectDto arch)
    {
        var name = arch.Name ?? arch.UserName ?? "Sin nombre";
        var surname = arch.Surname ?? "";
        return string.IsNullOrWhiteSpace(surname) ? name : $"{name} {surname}";
    }

    private void HandleInvalidSubmit()
    {
        Snackbar.Add("Por favor corrige los errores en el formulario", Severity.Warning);
    }

    private async Task HandleSubmit()
    {
        // Validar que tenemos un arquitecto asignado
        if (Model.ArchitectId == Guid.Empty)
        {
            if (CurrentArchitect != null)
            {
                Model.ArchitectId = CurrentArchitect.Id;
            }
            else if (Architects?.Any() == true)
            {
                Model.ArchitectId = Architects.First().Id;
            }
            else
            {
                Snackbar.Add("Debes seleccionar un arquitecto", Severity.Error);
                return;
            }
        }

        try
        {
            IsSubmitting = true;
            StateHasChanged();

            if (IsEditMode && Id.HasValue)
            {
                await ListingService.UpdateAsync(Id.Value, Model);
                Snackbar.Add("Propiedad actualizada correctamente", Severity.Success);
                NavManager.NavigateTo("/admin/listings");
            }
            else
            {
                var created = await ListingService.CreateAsync(Model);
                ExistingListing = created; // Para poder cargar imágenes inmediatamente
                Snackbar.Add("Propiedad creada. Ahora puedes agregar imagenes.", Severity.Success);
                
                // Redirigir a modo edición para poder agregar imágenes
                NavManager.NavigateTo($"/admin/listings/edit/{created.Id}", replace: true);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al guardar: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsSubmitting = false;
            StateHasChanged();
        }
    }

    private void HandleImagesChanged(List<ListingImageDto> images)
    {
        if (ExistingListing != null)
        {
            ExistingListing.Images = images;
            StateHasChanged();
        }
    }

    private async Task PublishListing()
    {
        if (!Id.HasValue) return;
        
        try
        {
            ExistingListing = await ListingService.PublishAsync(Id.Value);
            Snackbar.Add("Propiedad publicada correctamente", Severity.Success);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al publicar: {ex.Message}", Severity.Error);
        }
    }

    private async Task ArchiveListing()
    {
        var result = await DialogService.ShowMessageBox(
            "Archivar Propiedad", 
            "¿Estás seguro de archivar esta propiedad? Ya no será visible públicamente.",
            yesText: "Archivar", cancelText: "Cancelar");
        
        if (result == true && Id.HasValue)
        {
            try
            {
                ExistingListing = await ListingService.ArchiveAsync(Id.Value);
                Snackbar.Add("Propiedad archivada", Severity.Success);
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error al archivar: {ex.Message}", Severity.Error);
            }
        }
    }

    private Color GetStatusColor(ListingStatus status) => status switch
    {
        ListingStatus.Published => Color.Success,
        ListingStatus.Draft => Color.Warning,
        ListingStatus.Archived => Color.Default,
        ListingStatus.Portfolio => Color.Info,
        _ => Color.Default
    };
}
