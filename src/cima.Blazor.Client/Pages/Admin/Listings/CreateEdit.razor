@page "/admin/listings/create"
@page "/admin/listings/edit/{Id:guid}"
@rendermode InteractiveAuto
@using cima.Listings
@using cima.Listings.Inputs
@using cima.Listings.Outputs
@using cima.Architects
@using cima.Domain.Shared
@using cima.Blazor.Client.Services
@using cima.Blazor.Client.Components.Admin
@using cima.Permissions
@using MudBlazor
@using System.Globalization
@attribute [Authorize(cimaPermissions.Listings.Default)]
@inject IListingAppService ListingService
@inject IArchitectAppService ArchitectService
@inject EnumLocalizationService EnumLocalizer
@inject NavigationManager NavManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inherits cimaComponentBase

<PageTitle>@PageTitle - @L["CompanyName"]</PageTitle>

<div class="min-h-screen bg-neutral-50 pt-20"> @* pt-20 para compensar el navbar fixed *@
    <div class="bg-white border-b border-neutral-200">
        <div class="cima-container py-6">
            <div class="flex items-center gap-4 mb-2">
                <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.ArrowBack" Href="/admin/listings">
                    @L["Common:Back"]
                </MudButton>
            </div>
            <h1 class="text-2xl md:text-3xl font-display font-bold text-neutral-900">@PageTitle</h1>
        </div>
    </div>

    <div class="cima-container py-8">
        @if (IsLoading)
        {
            <MudCard Class="p-8">
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
                <p class="text-center mt-4">@L["Common:Loading"]</p>
            </MudCard>
        }
        else if (!CanCreateListings)
        {
            <MudAlert Severity="Severity.Warning" Class="mb-4">
                <strong>@L["Admin:Listings:Form:NoArchitectProfileTitle"]</strong>
                <p>@L["Admin:Listings:Form:NoArchitectProfileBody"]</p>
            </MudAlert>
        }
        else if (IsAdmin && (Architects == null || !Architects.Any()))
        {
            <MudAlert Severity="Severity.Warning" Class="mb-4">
                <strong>@L["Admin:Listings:Form:NoArchitectsTitle"]</strong>
                <p>@L["Admin:Listings:Form:NoArchitectsBody"]</p>
                <MudButton Variant="Variant.Text" Color="Color.Primary" Href="/admin/architects/create" Class="mt-2">
                    @L["Admin:Architects:Create"]
                </MudButton>
            </MudAlert>
        }
        else
        {
            <EditForm Model="@Model" OnValidSubmit="HandleSubmit" OnInvalidSubmit="HandleInvalidSubmit">
                <DataAnnotationsValidator />
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        <MudCard Class="p-6">
                            <h2 class="text-xl font-semibold text-neutral-900 mb-6">@L["Admin:Listings:Form:BasicInfo"]</h2>
                            <div class="space-y-4">
                                <MudTextField @bind-Value="Model.Title" Label="@L["Admin:Listings:Form:Title"]" Required="true" 
                                    Variant="Variant.Outlined" Class="mb-4"
                                    For="@(() => Model.Title)" />
                                <MudTextField @bind-Value="Model.Description" Label="@L["Admin:Listings:Form:Description"]" 
                                    Lines="4" Variant="Variant.Outlined" Class="mb-4"
                                    For="@(() => Model.Description)" />
                                <MudTextField @bind-Value="Model.Location" Label="@L["Admin:Listings:Form:Location"]" Required="true" 
                                    Variant="Variant.Outlined"
                                    For="@(() => Model.Location)" />
                            </div>
                        </MudCard>

                        <MudCard Class="p-6">
                            <h2 class="text-xl font-semibold text-neutral-900 mb-6">@L["Admin:Listings:Form:Details"]</h2>
                            <div class="grid grid-cols-2 gap-4">
                                <MudNumericField @bind-Value="Model.Price" Label="@L["Admin:Listings:Form:Price"]" 
                                    Variant="Variant.Outlined" 
                                    Culture="@MexicoCulture"
                                    Format="N0"
                                    For="@(() => Model.Price)" />
                                <MudNumericField @bind-Value="Model.LandArea" Label="@L["Admin:Listings:Form:LandArea"]" 
                                    Variant="Variant.Outlined" 
                                    Culture="@MexicoCulture"
                                    Format="N2"
                                    For="@(() => Model.LandArea)" />
                                <MudNumericField @bind-Value="Model.ConstructionArea" Label="@L["Admin:Listings:Form:ConstructionArea"]" 
                                    Variant="Variant.Outlined" 
                                    Culture="@MexicoCulture"
                                    Format="N2"
                                    For="@(() => Model.ConstructionArea)" />
                                <MudNumericField @bind-Value="Model.Bedrooms" Label="@L["Admin:Listings:Form:Bedrooms"]" 
                                    Variant="Variant.Outlined"
                                    For="@(() => Model.Bedrooms)" />
                                <MudNumericField @bind-Value="Model.Bathrooms" Label="@L["Admin:Listings:Form:Bathrooms"]" 
                                    Variant="Variant.Outlined"
                                    For="@(() => Model.Bathrooms)" />
                                
                                <MudSelect T="PropertyCategory" @bind-Value="Model.Category" Label="@L["Admin:Listings:Form:Category"]" 
                                    Variant="Variant.Outlined" Required="true"
                                    For="@(() => Model.Category)">
                                    <MudSelectItem Value="PropertyCategory.Residential">@EnumLocalizer.GetPropertyCategoryName(PropertyCategory.Residential)</MudSelectItem>
                                    <MudSelectItem Value="PropertyCategory.Commercial">@EnumLocalizer.GetPropertyCategoryName(PropertyCategory.Commercial)</MudSelectItem>
                                    <MudSelectItem Value="PropertyCategory.Mixed">@EnumLocalizer.GetPropertyCategoryName(PropertyCategory.Mixed)</MudSelectItem>
                                    <MudSelectItem Value="PropertyCategory.Land">@EnumLocalizer.GetPropertyCategoryName(PropertyCategory.Land)</MudSelectItem>
                                </MudSelect>

                                <MudSelect T="PropertyType" @bind-Value="Model.Type" Label="@L["Admin:Listings:Form:Type"]" 
                                    Variant="Variant.Outlined" Required="true"
                                    For="@(() => Model.Type)">
                                    <MudSelectItem Value="PropertyType.House">@EnumLocalizer.GetPropertyTypeName(PropertyType.House)</MudSelectItem>
                                    <MudSelectItem Value="PropertyType.Apartment">@EnumLocalizer.GetPropertyTypeName(PropertyType.Apartment)</MudSelectItem>
                                    <MudSelectItem Value="PropertyType.Condo">@EnumLocalizer.GetPropertyTypeName(PropertyType.Condo)</MudSelectItem>
                                    <MudSelectItem Value="PropertyType.Townhouse">@EnumLocalizer.GetPropertyTypeName(PropertyType.Townhouse)</MudSelectItem>
                                    <MudSelectItem Value="PropertyType.Villa">@EnumLocalizer.GetPropertyTypeName(PropertyType.Villa)</MudSelectItem>
                                    <MudSelectItem Value="PropertyType.Office">@EnumLocalizer.GetPropertyTypeName(PropertyType.Office)</MudSelectItem>
                                </MudSelect>
                            </div>
                        </MudCard>

                        @* Galería de imágenes - disponible siempre que tengamos un ID *@
                        @if (CurrentListingId.HasValue)
                        {
                            <MudCard Class="p-6">
                                <ImageGalleryManager ListingId="@CurrentListingId.Value" 
                                    InitialImages="@(ExistingListing?.Images ?? new())" 
                                    ImagesChanged="HandleImagesChanged" />
                            </MudCard>
                        }
                        else
                        {
                            <MudCard Class="p-6">
                                <div class="text-center py-8 text-neutral-500">
                                    <MudIcon Icon="@Icons.Material.Filled.PhotoLibrary" Size="Size.Large" Class="mb-4" />
                                    <p class="font-medium">@L["Admin:Listings:Form:GalleryPlaceholderTitle"]</p>
                                    <p class="text-sm mt-1">@L["Admin:Listings:Form:GalleryPlaceholderDescription"]</p>
                                </div>
                            </MudCard>
                        }
                    </div>

                    <div class="lg:col-span-1">
                        <div class="sticky top-24 space-y-6"> @* top-24 para navbar + padding *@
                            <MudCard Class="p-6">
                                <h3 class="font-semibold mb-4">@L["Common:Actions"]</h3>
                                
                                @* Mostrar errores de validación si los hay *@
                                <ValidationSummary class="text-red-600 text-sm mb-4" />
                                
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" 
                                    ButtonType="ButtonType.Submit" Disabled="@IsSubmitting" Class="mb-2">
                                    @if (IsSubmitting)
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                        <span>@L["Common:Saving"]</span>
                                    }
                                    else
                                    {
                                        <span>@L["Common:Save"]</span>
                                    }
                                </MudButton>
                                <MudButton Variant="Variant.Outlined" FullWidth="true" Href="/admin/listings">
                                    @L["Common:Cancel"]
                                </MudButton>
                            </MudCard>

                            @if (IsEditMode && ExistingListing != null)
                            {
                                <MudCard Class="p-6">
                                    <h3 class="font-semibold mb-4">@L["Common:Status"]</h3>
                                    <MudChip T="string" Color="@GetStatusColor(ExistingListing.Status)" Class="mb-4">
                                        @EnumLocalizer.GetListingStatusName(ExistingListing.Status)
                                    </MudChip>

                                    <div class="space-y-2">
                                        @if (ExistingListing.Status == ListingStatus.Draft)
                                        {
                                            <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true" 
                                                Size="Size.Small" OnClick="PublishListing">
                                                @L["Admin:Listings:Publish"]
                                            </MudButton>
                                        }
                                        @if (ExistingListing.Status == ListingStatus.Published)
                                        {
                                            <MudButton Variant="Variant.Filled" Color="Color.Info" FullWidth="true" 
                                                Size="Size.Small" OnClick="MoveToPortfolio">
                                                @L["Admin:Listings:Form:MoveToPortfolioAction"]
                                            </MudButton>
                                            <MudButton Variant="Variant.Outlined" Color="Color.Warning" FullWidth="true" 
                                                Size="Size.Small" OnClick="ArchiveListing">
                                                @L["Admin:Listings:Archive"]
                                            </MudButton>
                                        }
                                        @if (ExistingListing.Status == ListingStatus.Archived)
                                        {
                                            <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true" 
                                                Size="Size.Small" OnClick="UnarchiveListing">
                                                @L["Admin:Listings:Form:Reactivate"]
                                            </MudButton>
                                        }
                                        @if (ExistingListing.Status == ListingStatus.Portfolio)
                                        {
                                            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-2">
                                                @L["Admin:Listings:Form:PortfolioInfo"]
                                            </MudAlert>
                                            <MudButton Variant="Variant.Outlined" Color="Color.Warning" FullWidth="true" 
                                                Size="Size.Small" OnClick="ArchiveListing">
                                                @L["Admin:Listings:Archive"]
                                            </MudButton>
                                        }
                                    </div>
                                </MudCard>
                            }
                        </div>
                    </div>
                </div>
            </EditForm>
        }
    </div>
</div>

@code {
    [Parameter] public Guid? Id { get; set; }

    // Cultura mexicana para formato de números (comas para miles, punto para decimales)
    private static readonly CultureInfo MexicoCulture = new("es-MX");

    private bool IsEditMode => Id.HasValue && Id.Value != Guid.Empty;
    private string PageTitle => IsEditMode ? L["Admin:Listings:Edit"] : L["Admin:Listings:Create"];

    private bool IsLoading { get; set; } = true;
    private bool IsSubmitting { get; set; }
    private bool IsAdmin { get; set; }
    
    // Usuario puede crear listings si:
    // - Es arquitecto (tiene perfil propio), o
    // - Es admin Y hay arquitectos disponibles para asignar
    private bool CanCreateListings => CurrentArchitect != null || (IsAdmin && Architects?.Any() == true);
    
    private ListingViewModel Model { get; set; } = new();
    
    private List<ArchitectDto>? Architects { get; set; }
    private ArchitectDto? CurrentArchitect { get; set; }
    private ListingDetailDto? ExistingListing { get; set; }
    
    // ID actual del listing (para modo edición o después de crear)
    private Guid? CurrentListingId => ExistingListing?.Id ?? (IsEditMode ? Id : null);

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Verificar si es admin
            IsAdmin = CurrentUser.IsInRole("admin");
            
            // Siempre intentar obtener el arquitecto actual (puede ser null para admin puro)
            try
            {
                CurrentArchitect = await ArchitectService.GetCurrentAsync();
            }
            catch
            {
                CurrentArchitect = null;
            }
            
            // Si es admin, SIEMPRE cargar lista de arquitectos
            if (IsAdmin)
            {
                await LoadArchitects();
            }
            
            // Establecer el arquitecto por defecto
            if (CurrentArchitect != null)
            {
                // Si el usuario tiene perfil de arquitecto, usarlo por defecto
                Model.ArchitectId = CurrentArchitect.Id;
            }
            else if (Architects?.Any() == true)
            {
                // Si es admin sin perfil propio, usar el primer arquitecto disponible
                Model.ArchitectId = Architects.First().Id;
            }
            
            // Si es modo edición, cargar el listing existente
            if (IsEditMode)
            {
                await LoadListing();
            }
        }
        catch (OperationCanceledException)
        {
            // Ignorar - navegación en progreso
        }
        catch (Exception ex)
        {
            Snackbar.Add(L["Admin:Listings:Form:InitError", ex.Message], Severity.Error);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task LoadArchitects()
    {
        try
        {
            var result = await ArchitectService.GetListAsync(
                new Volo.Abp.Application.Dtos.PagedAndSortedResultRequestDto { MaxResultCount = 100 });
            Architects = result.Items.ToList();
        }
        catch (OperationCanceledException)
        {
            // Ignorar - navegación en progreso
        }
        catch (Exception ex)
        {
            Snackbar.Add(L["Admin:Listings:Form:ArchitectsLoadError", ex.Message], Severity.Error);
        }
    }

    private async Task LoadListing()
    {
        try
        {
            if (!Id.HasValue) return;
            ExistingListing = await ListingService.GetAsync(Id.Value);
            
            Model = new ListingViewModel
            {
                Title = ExistingListing.Title,
                Description = ExistingListing.Description,
                Location = ExistingListing.Location?.Address ?? "", // Map from LocationDto
                Price = ExistingListing.Price,
                LandArea = ExistingListing.LandArea,
                ConstructionArea = ExistingListing.ConstructionArea,
                Bedrooms = ExistingListing.Bedrooms,
                Bathrooms = ExistingListing.Bathrooms,
                Category = ExistingListing.Category,
                Type = ExistingListing.Type,
                TransactionType = ExistingListing.TransactionType,
                ArchitectId = ExistingListing.ArchitectId
            };
        }
        catch (OperationCanceledException)
        {
            // Ignorar - navegación en progreso
        }
        catch (Exception ex)
        {
            Snackbar.Add(L["Admin:Listings:Form:LoadError", ex.Message], Severity.Error);
            NavManager.NavigateTo("/admin/listings");
        }
    }

    private string GetArchitectDisplayName(ArchitectDto arch)
    {
        var name = arch.Name ?? arch.UserName ?? "Sin nombre";
        var surname = arch.Surname ?? "";
        return string.IsNullOrWhiteSpace(surname) ? name : $"{name} {surname}";
    }

    private void HandleInvalidSubmit()
    {
        Snackbar.Add(L["Admin:Listings:Form:InvalidForm"], Severity.Warning);
    }

    private async Task HandleSubmit()
    {
        // Validar que tenemos un arquitecto asignado
        if (Model.ArchitectId == Guid.Empty)
        {
            if (CurrentArchitect != null)
            {
                Model.ArchitectId = CurrentArchitect.Id;
            }
            else if (Architects?.Any() == true)
            {
                Model.ArchitectId = Architects.First().Id;
            }
            else
            {
                Snackbar.Add(L["Admin:Listings:Form:ArchitectRequired"], Severity.Error);
                return;
            }
        }

        try
        {
            IsSubmitting = true;
            StateHasChanged();

            if (IsEditMode && Id.HasValue)
            {
                var input = new UpdateListingDto
                {
                    Title = Model.Title,
                    Description = Model.Description,
                    Address = new AddressDto { Value = Model.Location },
                    Price = Model.Price,
                    LandArea = Model.LandArea,
                    ConstructionArea = Model.ConstructionArea,
                    Bedrooms = Model.Bedrooms,
                    Bathrooms = Model.Bathrooms,
                    Category = Model.Category,
                    Type = Model.Type,
                    TransactionType = Model.TransactionType,
                    // ArchitectId is not updatable in UpdateListingDto usually, check logic.
                    // Assuming for now it logic stays same, but if removed from DTO, line below is invalid.
                    // The previous UpdateListingInput had it? Let's assume yes or benign if missing.
                    // Wait, UpdateListingDto usually doesn't allow changing architect.
                    // Checking UpdateListingDto in my memory... likely doesn't have it.
                    // Removing ArchitectId from Update mapping to be safe/correct DDD.
                };

                await ListingService.UpdateAsync(Id.Value, input);
                Snackbar.Add(L["Admin:Listings:Form:UpdateSuccess"], Severity.Success);
                NavManager.NavigateTo("/admin/listings");
            }
            else
            {
                var input = new CreateListingDto
                {
                    Title = Model.Title,
                    Description = Model.Description,
                    Address = new AddressDto { Value = Model.Location },
                    Price = Model.Price,
                    LandArea = Model.LandArea,
                    ConstructionArea = Model.ConstructionArea,
                    Bedrooms = Model.Bedrooms,
                    Bathrooms = Model.Bathrooms,
                    Category = Model.Category,
                    Type = Model.Type,
                    TransactionType = Model.TransactionType,
                    ArchitectId = Model.ArchitectId
                };

                var created = await ListingService.CreateAsync(input);
                ExistingListing = created; // ListingDetailDto
                Snackbar.Add(L["Admin:Listings:Form:CreateSuccess"], Severity.Success);
                
                // Redirigir a modo edición para poder agregar imágenes
                NavManager.NavigateTo($"/admin/listings/edit/{created.Id}", replace: true);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add(L["Admin:Listings:Form:SaveError", ex.Message], Severity.Error);
        }
        finally
        {
            IsSubmitting = false;
            StateHasChanged();
        }
    }

    private void HandleImagesChanged(List<ListingImageDto> images)
    {
        if (ExistingListing != null)
        {
            ExistingListing.Images = images;
            StateHasChanged();
        }
    }

    private async Task PublishListing()
    {
        if (!Id.HasValue) return;
        
        try
        {
            ExistingListing = await ListingService.PublishAsync(new PublishListingDto { ListingId = Id.Value });
            Snackbar.Add(L["Admin:Listings:Form:PublishSuccess"], Severity.Success);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add(L["Admin:Listings:Form:PublishError", ex.Message], Severity.Error);
        }
    }

    private async Task ArchiveListing()
    {
        var result = await DialogService.ShowMessageBox(
            L["Admin:Listings:Form:ArchiveTitle"], 
            L["Admin:Listings:Form:ArchiveConfirm"],
            yesText: L["Admin:Listings:Archive"], cancelText: L["Common:Cancel"]);
        
        if (result == true && Id.HasValue)
        {
            try
            {
                ExistingListing = await ListingService.ArchiveAsync(Id.Value);
                Snackbar.Add(L["Admin:Listings:Form:ArchiveSuccess"], Severity.Success);
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Snackbar.Add(L["Admin:Listings:Form:ArchiveError", ex.Message], Severity.Error);
            }
        }
    }

    private async Task UnarchiveListing()
    {
        if (!Id.HasValue) return;
        
        try
        {
            ExistingListing = await ListingService.UnarchiveAsync(Id.Value);
            Snackbar.Add(L["Admin:Listings:Form:UnarchiveSuccess"], Severity.Success);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add(L["Admin:Listings:Form:UnarchiveError", ex.Message], Severity.Error);
        }
    }

    private async Task MoveToPortfolio()
    {
        var result = await DialogService.ShowMessageBox(
            L["Admin:Listings:Form:MoveToPortfolioTitle"], 
            L["Admin:Listings:Form:MoveToPortfolioConfirm"],
            yesText: L["Admin:Listings:Form:MoveToPortfolioAction"], cancelText: L["Common:Cancel"]);
        
        if (result == true && Id.HasValue)
        {
            try
            {
                ExistingListing = await ListingService.MoveToPortfolioAsync(Id.Value);
                Snackbar.Add(L["Admin:Listings:Form:MoveToPortfolioSuccess"], Severity.Success);
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Snackbar.Add(L["Admin:Listings:Form:MoveToPortfolioError", ex.Message], Severity.Error);
            }
        }
    }

    private Color GetStatusColor(ListingStatus status) => status switch
    {
        ListingStatus.Draft => Color.Warning,
        ListingStatus.Published => Color.Success,
        ListingStatus.Archived => Color.Default,
        ListingStatus.Portfolio => Color.Info,
        _ => Color.Default
    };

    public class ListingViewModel
    {
        [Required]
        public string Title { get; set; } = string.Empty;
        [Required]
        public string Description { get; set; } = string.Empty;
        public string Location { get; set; } = string.Empty;
        public decimal Price { get; set; }
        public decimal LandArea { get; set; }
        public decimal ConstructionArea { get; set; }
        public int Bedrooms { get; set; }
        public int Bathrooms { get; set; }
        public PropertyCategory Category { get; set; } = PropertyCategory.Residential;
        public PropertyType Type { get; set; } = PropertyType.House;
        public TransactionType TransactionType { get; set; } = TransactionType.Sale;
        public Guid ArchitectId { get; set; }
    }
}
