@page "/admin/listings/create"
@page "/admin/listings/edit/{Id:guid}"
@rendermode InteractiveAuto
@using cima.Listings
@using cima.Listings.Inputs
@using cima.Listings.Outputs
@using cima.Portfolio
@using cima.Architects
@using cima.Categories
@using cima.Domain.Shared
@using cima.Blazor.Client.Services
@using cima.Blazor.Client.Components.Admin
@using cima.Permissions
@using MudBlazor
@using System.Globalization
@using System.Collections.Generic
@attribute [Authorize(cimaPermissions.Listings.Default)]
@inject IListingAppService ListingService
@inject IPortfolioAppService PortfolioService
@inject IFeaturedListingAppService FeaturedListingService
@inject IArchitectAppService ArchitectService
@inject ICategoryAppService CategoryService
@inject EnumLocalizationService EnumLocalizer
@inject NavigationManager NavManager
@inject IDialogService DialogService
@inherits cimaComponentBase

<PageTitle>@PageTitle - @L["CompanyName"]</PageTitle>

<PageShell> @* offset global aplicado en layout *@
    <div class="bg-white border-b border-neutral-200">
        <div class="cima-container py-6">
            <div class="flex items-center gap-4 mb-2">
                <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.ArrowBack" Href="/admin/listings">
                    @L["Common:Back"]
                </MudButton>
            </div>
            <h1 class="text-2xl md:text-3xl font-display font-bold text-neutral-900">@PageTitle</h1>
        </div>
    </div>

    <div class="cima-container py-8">
        @if (IsLoading)
        {
            <MudCard Class="p-8">
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
                <p class="text-center mt-4">@L["Common:Loading"]</p>
            </MudCard>
        }
        else if (!CanCreateListings)
        {
            <MudAlert Severity="Severity.Warning" Class="mb-4">
                <strong>@L["Admin:Listings:Form:NoArchitectProfileTitle"]</strong>
                <p>@L["Admin:Listings:Form:NoArchitectProfileBody"]</p>
            </MudAlert>
        }
        else if (IsAdmin && (Architects == null || !Architects.Any()))
        {
            <MudAlert Severity="Severity.Warning" Class="mb-4">
                <strong>@L["Admin:Listings:Form:NoArchitectsTitle"]</strong>
                <p>@L["Admin:Listings:Form:NoArchitectsBody"]</p>
                <MudButton Variant="Variant.Text" Color="Color.Primary" Href="/admin/architects/create" Class="mt-2">
                    @L["Admin:Architects:Create"]
                </MudButton>
            </MudAlert>
        }
        else
        {
            <EditForm Model="@Model" OnValidSubmit="HandleSubmit" OnInvalidSubmit="HandleInvalidSubmit">
                <DataAnnotationsValidator />
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        <MudCard Class="p-6">
                            <h2 class="text-xl font-semibold text-neutral-900 mb-6">@L["Admin:Listings:Form:BasicInfo"]</h2>
                            <div class="space-y-4">
                                <MudTextField @bind-Value="Model.Title" Label="@L["Admin:Listings:Form:Title"]" Required="true" 
                                    Variant="Variant.Outlined" Class="mb-4"
                                    Counter="200" MaxLength="200"
                                    HelperText="@L["Common:Required"]"
                                    For="@(() => Model.Title)" />
                                <MudTextField @bind-Value="Model.Description" Label="@L["Admin:Listings:Form:Description"]" 
                                    Lines="4" Variant="Variant.Outlined" Class="mb-4"
                                    Counter="5000" MaxLength="5000"
                                    For="@(() => Model.Description)" />
                                <MudTextField @bind-Value="Model.Location" Label="@L["Admin:Listings:Form:Location"]" Required="true" 
                                    Variant="Variant.Outlined"
                                    HelperText="@L["Common:Required"]"
                                    For="@(() => Model.Location)" />
                            </div>
                        </MudCard>

                        <MudCard Class="p-6">
                            <h2 class="text-xl font-semibold text-neutral-900 mb-6">@L["Admin:Listings:Form:Details"]</h2>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2 flex items-center gap-4 mb-2">
                                    <MudCheckBox @bind-Value="Model.IsPriceOnRequest" 
                                        Label="@L["Admin:Listings:Form:PriceOnRequest"]"
                                        Color="Color.Primary" />
                                </div>
                                <MudNumericField @bind-Value="Model.Price" Label="@L["Admin:Listings:Form:Price"]" 
                                    Variant="Variant.Outlined" 
                                    Culture="@MexicoCulture"
                                    Format="N0"
                                    Disabled="@Model.IsPriceOnRequest"
                                    For="@(() => Model.Price)" />
                                <MudNumericField @bind-Value="Model.LandArea" Label="@L["Admin:Listings:Form:LandArea"]" 
                                    Variant="Variant.Outlined" 
                                    Culture="@MexicoCulture"
                                    Format="N2"
                                    For="@(() => Model.LandArea)" />
                                <MudNumericField @bind-Value="Model.ConstructionArea" Label="@L["Admin:Listings:Form:ConstructionArea"]" 
                                    Variant="Variant.Outlined" 
                                    Culture="@MexicoCulture"
                                    Format="N2"
                                    For="@(() => Model.ConstructionArea)" />
                                <MudNumericField @bind-Value="Model.Bedrooms" Label="@L["Admin:Listings:Form:Bedrooms"]" 
                                    Variant="Variant.Outlined"
                                    For="@(() => Model.Bedrooms)" />
                                <MudNumericField @bind-Value="Model.Bathrooms" Label="@L["Admin:Listings:Form:Bathrooms"]" 
                                    Variant="Variant.Outlined"
                                    For="@(() => Model.Bathrooms)" />
                                
                                <MudSelect T="Guid"
                                           Value="Model.CategoryId"
                                           ValueChanged="OnCategoryChanged"
                                           Label="@L["Admin:Listings:Form:Category"]"
                                           Variant="Variant.Outlined"
                                           Required="true"
                                           For="@(() => Model.CategoryId)">
                                    @foreach (var category in Categories)
                                    {
                                        <MudSelectItem Value="@category.Id">@category.Name</MudSelectItem>
                                    }
                                </MudSelect>

                                <MudSelect T="Guid" @bind-Value="Model.TypeId" Label="@L["Admin:Listings:Form:Type"]"
                                    Variant="Variant.Outlined" Required="true"
                                    For="@(() => Model.TypeId)">
                                    @foreach (var type in Types)
                                    {
                                        <MudSelectItem Value="@type.Id">@type.Name</MudSelectItem>
                                    }
                                </MudSelect>
                            </div>
                        </MudCard>

                        @* Galería de imágenes - usar staging antes de crear *@
                        @if (CurrentListingId.HasValue)
                        {
                            <MudCard Class="p-6">
                                <ImageGalleryManager ListingId="@CurrentListingId.Value" 
                                    InitialImages="@(ExistingListing?.Images ?? new())" 
                                    ImagesChanged="HandleImagesChanged" />
                            </MudCard>
                        }
                        else
                        {
                            <MudCard Class="p-6">
                                <ImageUploader InitialImages="PendingImages"    
                                               OnImagesChanged="HandlePendingImagesChanged" />
                            </MudCard>
                        }
                    </div>

                    <div class="lg:col-span-1">
                        <div class="sticky top-24 space-y-6"> @* top-24 para navbar + padding *@
                            <MudCard Class="p-6">
                                <h3 class="font-semibold mb-4">@L["Common:Actions"]</h3>
                                
                                @* Mostrar errores de validación si los hay *@
                                <ValidationSummary class="text-red-600 text-sm mb-4" />
                                
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" 
                                    ButtonType="ButtonType.Submit" Disabled="@IsSubmitting" Class="mb-2">
                                    @if (IsSubmitting)
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                        <span>@L["Common:Saving"]</span>
                                    }
                                    else
                                    {
                                        <span>@L["Common:Save"]</span>
                                    }
                                </MudButton>
                                <MudButton Variant="Variant.Outlined" FullWidth="true" Href="/admin/listings">
                                    @L["Common:Cancel"]
                                </MudButton>
                            </MudCard>

                            @if (IsEditMode && ExistingListing != null)
                            {
                                <MudCard Class="p-6">
                                    <h3 class="font-semibold mb-4">@L["Common:Status"]</h3>
                                    <MudChip T="string" Color="@GetStatusColor(ExistingListing.Status)" Class="mb-4">
                                        @EnumLocalizer.GetListingStatusName(ExistingListing.Status)
                                    </MudChip>

                                    <div class="space-y-2">
                                        @if (ExistingListing.Status == ListingStatus.Portfolio)
                                        {
                                            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-2">
                                                @L["Admin:Listings:Form:PortfolioInfo"]
                                            </MudAlert>
                                        }

                                        @if (ExistingListing.Status != ListingStatus.Published)
                                        {
                                            <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true"
                                                Size="Size.Small" OnClick="PublishListing"
                                                Disabled="@(!CanPublishFromDetail)">
                                                @L["Admin:Listings:Publish"]
                                            </MudButton>
                                        }
                                        @if (ExistingListing.Status == ListingStatus.Published || ExistingListing.Status == ListingStatus.Portfolio)
                                        {
                                            <MudButton Variant="Variant.Outlined" Color="Color.Default" FullWidth="true"
                                                Size="Size.Small" OnClick="UnpublishListing">
                                                @L["Admin:Listings:Action:MoveToDraft"]
                                            </MudButton>
                                        }
                                        @if (ExistingListing.Status != ListingStatus.Portfolio)
                                        {
                                            <MudButton Variant="Variant.Filled" Color="Color.Info" FullWidth="true"
                                                Size="Size.Small" OnClick="MoveToPortfolio"
                                                Disabled="@(!CanMoveToPortfolioFromDetail)">
                                                @L["Admin:Listings:Form:MoveToPortfolioAction"]
                                            </MudButton>
                                        }
                                        @if (ExistingListing.Status != ListingStatus.Archived)
                                        {
                                            <MudButton Variant="Variant.Outlined" Color="Color.Warning" FullWidth="true"
                                                Size="Size.Small" OnClick="ArchiveListing">
                                                @L["Admin:Listings:Archive"]
                                            </MudButton>
                                        }
                                        @if (ExistingListing.Status == ListingStatus.Archived)
                                        {
                                            <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true"
                                                Size="Size.Small" OnClick="UnarchiveListing">
                                                @L["Admin:Listings:Form:Reactivate"]
                                            </MudButton>
                                        }
                                        @if (!HasImages)
                                        {
                                            <MudText Typo="Typo.caption" Class="text-neutral-500">
                                                @L["Listing:NoImages"]
                                            </MudText>
                                        }
                                    </div>
                                </MudCard>

                                <MudCard Class="p-6">
                                    <h3 class="font-semibold mb-4">@L["Admin:Listings:Featured:Title"]</h3>
                                    <MudStack Spacing="2">
                                        <MudText Typo="Typo.body2">@string.Format(L["Admin:Listings:Featured:CountHint"], FeaturedListingCount, MaxFeaturedListings)</MudText>
                                        <MudButton Variant="Variant.Filled"
                                                   Color="@(IsFeatured ? Color.Warning : Color.Primary)"
                                                   FullWidth="true"
                                                   Size="Size.Small"
                                                   Disabled="@(!CanToggleFeatured())"
                                                   OnClick="ToggleFeaturedFromDetail">
                                            @(IsFeatured ? L["Admin:Listings:Featured:Remove"] : L["Admin:Listings:Featured:Add"])
                                        </MudButton>
                                        <MudText Typo="Typo.caption" Class="mud-text-secondary">@GetFeaturedActionHint()</MudText>
                                    </MudStack>
                                </MudCard>
                            }
                        </div>
                    </div>
                </div>
            </EditForm>
        }
    </div>
</PageShell>

@code {
    [Parameter] public Guid? Id { get; set; }

    // Cultura mexicana para formato de números (comas para miles, punto para decimales)
    private static readonly CultureInfo MexicoCulture = new("es-MX");

    private bool IsEditMode => Id.HasValue && Id.Value != Guid.Empty;
    private string PageTitle => IsEditMode ? L["Admin:Listings:Edit"] : L["Admin:Listings:Create"];

    private bool IsLoading { get; set; } = true;
    private bool IsSubmitting { get; set; }
    private bool IsAdmin { get; set; }
    
    // Usuario puede crear listings si:
    // - Es arquitecto (tiene perfil propio), o
    // - Es admin Y hay arquitectos disponibles para asignar
    private bool CanCreateListings => CurrentArchitect != null || (IsAdmin && Architects?.Any() == true);
    
    private ListingViewModel Model { get; set; } = new();

    private List<PropertyCategoryDto> Categories { get; set; } = new();
    private List<PropertyTypeDto> Types { get; set; } = new();

    private List<ArchitectDto>? Architects { get; set; }
    private ArchitectDto? CurrentArchitect { get; set; }
    private ListingDetailDto? ExistingListing { get; set; }
    private List<AddListingImageDto> PendingImages { get; set; } = new();
    private bool IsFeatured { get; set; }
    private int FeaturedListingCount { get; set; }
    private bool IsFeaturedBusy { get; set; }
    private const int MaxFeaturedListings = 12;

    private bool HasImages => ExistingListing?.Images?.Any() == true;
    private bool CanPublishFromDetail => ExistingListing != null && ExistingListing.Status != ListingStatus.Published && HasImages;
    private bool CanMoveToPortfolioFromDetail => ExistingListing != null && ExistingListing.Status != ListingStatus.Portfolio && HasImages;
    
    // ID actual del listing (para modo edición o después de crear)
    private Guid? CurrentListingId => ExistingListing?.Id ?? (IsEditMode ? Id : null);

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Verificar si es admin
            IsAdmin = CurrentUser.IsInRole("admin");

            await LoadCategoriesAsync();
            
            // Siempre intentar obtener el arquitecto actual (puede ser null para admin puro)
            try
            {
                CurrentArchitect = await ArchitectService.GetCurrentAsync();
            }
            catch
            {
                CurrentArchitect = null;
            }
            
            // Si es admin, SIEMPRE cargar lista de arquitectos
            if (IsAdmin)
            {
                await LoadArchitects();
            }
            
            // Establecer el arquitecto por defecto
            if (CurrentArchitect != null)
            {
                // Si el usuario tiene perfil de arquitecto, usarlo por defecto
                Model.ArchitectId = CurrentArchitect.Id;
            }
            else if (Architects?.Any() == true)
            {
                // Si es admin sin perfil propio, usar el primer arquitecto disponible
                Model.ArchitectId = Architects.First().Id;
            }
            
            // Si es modo edición, cargar el listing existente
            if (IsEditMode)
            {
                await LoadListing();
            }
        }
        catch (OperationCanceledException)
        {
            // Ignorar - navegación en progreso
        }
        catch (Exception ex)
        {
            Snackbar.Add(L["Admin:Listings:Form:InitError", ex.Message], Severity.Error);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task LoadArchitects()
    {
        try
        {
            var result = await ArchitectService.GetListAsync(
                new Volo.Abp.Application.Dtos.PagedAndSortedResultRequestDto { MaxResultCount = 100 });
            Architects = result.Items.ToList();
        }
        catch (OperationCanceledException)
        {
            // Ignorar - navegación en progreso
        }
        catch (Exception ex)
        {
            Snackbar.Add(L["Admin:Listings:Form:ArchitectsLoadError", ex.Message], Severity.Error);
        }
    }

    private async Task LoadCategoriesAsync()
    {
        try
        {
            var categories = await CategoryService.GetCategoriesAsync();
            Categories = categories
                .Where(category => category.IsActive)
                .OrderBy(category => category.SortOrder)
                .ToList();

            if (Model.CategoryId == Guid.Empty && Categories.Any())
            {
                Model.CategoryId = Categories[0].Id;
            }

            await LoadTypesAsync(Model.CategoryId);
        }
        catch (OperationCanceledException)
        {
            // Ignorar - navegación en progreso
        }
        catch (Exception ex)
        {
            Snackbar.Add(L["Admin:Listings:Form:InitError", ex.Message], Severity.Error);
        }
    }

    private async Task LoadTypesAsync(Guid categoryId)
    {
        try
        {
            var types = await CategoryService.GetTypesAsync(categoryId, includeInactive: false);
            Types = types
                .Where(type => type.IsActive)
                .OrderBy(type => type.SortOrder)
                .ToList();

            if (Types.Count == 0)
            {
                Model.TypeId = Guid.Empty;
                return;
            }

            if (Model.TypeId == Guid.Empty || !Types.Any(type => type.Id == Model.TypeId))
            {
                Model.TypeId = Types[0].Id;
            }
        }
        catch (OperationCanceledException)
        {
            // Ignorar - navegación en progreso
        }
        catch (Exception ex)
        {
            Snackbar.Add(L["Admin:Listings:Form:InitError", ex.Message], Severity.Error);
        }
    }

    private async Task OnCategoryChanged(Guid categoryId)
    {
        Model.CategoryId = categoryId;
        await LoadTypesAsync(categoryId);
    }

    private async Task LoadListing()
    {
        try
        {
            if (!Id.HasValue) return;
            ExistingListing = await ListingService.GetAsync(Id.Value);
            
            Model = new ListingViewModel
            {
                Title = ExistingListing.Title,
                Description = ExistingListing.Description,
                Location = ExistingListing.Location?.Address ?? "", // Map from LocationDto
                Price = ExistingListing.Price,
                IsPriceOnRequest = ExistingListing.IsPriceOnRequest,
                LandArea = ExistingListing.LandArea,
                ConstructionArea = ExistingListing.ConstructionArea,
                Bedrooms = ExistingListing.Bedrooms,
                Bathrooms = ExistingListing.Bathrooms,
                CategoryId = ExistingListing.CategoryId,
                TypeId = ExistingListing.TypeId,
                TransactionType = ExistingListing.TransactionType,
                ArchitectId = ExistingListing.ArchitectId
            };

            await LoadTypesAsync(Model.CategoryId);

            await LoadFeaturedStatusAsync();
        }
        catch (OperationCanceledException)
        {
            // Ignorar - navegación en progreso
        }
        catch (Exception ex)
        {
            Snackbar.Add(L["Admin:Listings:Form:LoadError", ex.Message], Severity.Error);
            NavManager.NavigateTo("/admin/listings");
        }
    }

    private async Task LoadFeaturedStatusAsync()
    {
        if (CurrentListingId is not { } listingId)
        {
            return;
        }

        try
        {
            var isFeaturedTask = FeaturedListingService.IsListingFeaturedAsync(listingId);
            var countTask = FeaturedListingService.GetCountAsync();
            await Task.WhenAll(isFeaturedTask, countTask);
            IsFeatured = await isFeaturedTask;
            FeaturedListingCount = await countTask;
        }
        catch
        {
            IsFeatured = false;
            FeaturedListingCount = 0;
        }
    }

    private bool CanToggleFeatured()
    {
        if (ExistingListing == null)
        {
            return false;
        }

        if (IsFeatured)
        {
            return true;
        }

        var status = ExistingListing.Status;
        if (status != ListingStatus.Published && status != ListingStatus.Portfolio)
        {
            return false;
        }

        return FeaturedListingCount < MaxFeaturedListings;
    }

    private string GetFeaturedActionHint()
    {
        if (ExistingListing == null)
        {
            return string.Empty;
        }

        if (IsFeatured)
        {
            return L["Admin:Listings:Featured:Remove"];
        }

        if (ExistingListing.Status != ListingStatus.Published && ExistingListing.Status != ListingStatus.Portfolio)
        {
            return L["Admin:Listings:Featured:RequiresPublished"];
        }

        if (FeaturedListingCount >= MaxFeaturedListings)
        {
            return string.Format(L["Admin:Listings:Featured:LimitReached"], MaxFeaturedListings);
        }

        return L["Admin:Listings:Featured:Add"];
    }

    private async Task ToggleFeaturedFromDetail()
    {
        if (ExistingListing == null || CurrentListingId is not { } listingId || IsFeaturedBusy)
        {
            return;
        }

        if (!CanToggleFeatured())
        {
            Snackbar.Add(GetFeaturedActionHint(), Severity.Warning);
            return;
        }

        try
        {
            IsFeaturedBusy = true;
            if (IsFeatured)
            {
                await FeaturedListingService.RemoveByListingIdAsync(listingId);
                IsFeatured = false;
                FeaturedListingCount = Math.Max(0, FeaturedListingCount - 1);
                Snackbar.Add(L["Admin:Listings:Featured:Removed"], Severity.Success);
            }
            else
            {
                await FeaturedListingService.AddAsync(new CreateFeaturedListingDto { ListingId = listingId });
                IsFeatured = true;
                FeaturedListingCount++;
                Snackbar.Add(L["Admin:Listings:Featured:Added"], Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add(ex.Message, Severity.Error);
        }
        finally
        {
            IsFeaturedBusy = false;
        }
    }

    private string GetArchitectDisplayName(ArchitectDto arch)
    {
        var name = arch.Name ?? arch.UserName ?? "Sin nombre";
        var surname = arch.Surname ?? "";
        return string.IsNullOrWhiteSpace(surname) ? name : $"{name} {surname}";
    }

    private void HandleInvalidSubmit()
    {
        Snackbar.Add(L["Admin:Listings:Form:InvalidForm"], Severity.Warning);
    }

    private async Task HandleSubmit()
    {
        // Validar que tenemos un arquitecto asignado
        if (Model.ArchitectId == Guid.Empty)
        {
            if (CurrentArchitect != null)
            {
                Model.ArchitectId = CurrentArchitect.Id;
            }
            else if (Architects?.Any() == true)
            {
                Model.ArchitectId = Architects.First().Id;
            }
            else
            {
                Snackbar.Add(L["Admin:Listings:Form:ArchitectRequired"], Severity.Error);
                return;
            }
        }

        try
        {
            IsSubmitting = true;
            StateHasChanged();

            if (IsEditMode && Id.HasValue)
            {
                var price = Model.IsPriceOnRequest ? null : Model.Price;
                var input = new UpdateListingDto
                {
                    Id = Id.Value,
                    Title = Model.Title,
                    Description = Model.Description,
                    Address = new AddressDto { Value = Model.Location },
                    IsPriceOnRequest = Model.IsPriceOnRequest,
                    Price = price,
                    LandArea = Model.LandArea,
                    ConstructionArea = Model.ConstructionArea,
                    Bedrooms = Model.Bedrooms,
                    Bathrooms = Model.Bathrooms,
                    CategoryId = Model.CategoryId,
                    TypeId = Model.TypeId,
                    TransactionType = Model.TransactionType,
                };

                await ListingService.UpdateAsync(Id.Value, input);
                Snackbar.Add(L["Admin:Listings:Form:UpdateSuccess"], Severity.Success);
                NavManager.NavigateTo("/admin/listings");
            }
            else
            {
                var price = Model.IsPriceOnRequest ? null : Model.Price;
                var input = new CreateListingDto
                {
                    Title = Model.Title,
                    Description = Model.Description,
                    Address = new AddressDto { Value = Model.Location },
                    IsPriceOnRequest = Model.IsPriceOnRequest,
                    Price = price,
                    LandArea = Model.LandArea,
                    ConstructionArea = Model.ConstructionArea,
                    Bedrooms = Model.Bedrooms,
                    Bathrooms = Model.Bathrooms,
                    CategoryId = Model.CategoryId,
                    TypeId = Model.TypeId,
                    TransactionType = Model.TransactionType,
                    ArchitectId = Model.ArchitectId
                };

                var created = await ListingService.CreateAsync(input);
                ExistingListing = created; // ListingDetailDto
                Snackbar.Add(L["Admin:Listings:Form:CreateSuccess"], Severity.Success);

                await UploadPendingImagesAsync(created.Id);

                // Redirigir a modo edición para poder agregar imágenes
                NavManager.NavigateTo($"/admin/listings/edit/{created.Id}", replace: true);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add(L["Admin:Listings:Form:SaveError", ex.Message], Severity.Error);
        }
        finally
        {
            IsSubmitting = false;
            StateHasChanged();
        }
    }

    private void HandleImagesChanged(List<ListingImageDto> images)
    {
        if (ExistingListing != null)
        {
            ExistingListing.Images = images;
            StateHasChanged();
        }
    }

    private void HandlePendingImagesChanged(List<AddListingImageDto> images)
    {
        PendingImages = images;
    }

    private async Task UploadPendingImagesAsync(Guid listingId)
    {
        if (!PendingImages.Any())
        {
            return;
        }

        var success = 0;
        var failed = 0;
        var uploadedImages = new List<ListingImageDto>();

        foreach (var image in PendingImages.ToList())
        {
            var input = new AddListingImageDto
            {
                ListingId = listingId,
                Url = image.Url,
                AltText = image.AltText,
                FileSize = image.FileSize,
                ContentType = image.ContentType
            };

            try
            {
                var createdImage = await ListingService.AddImageAsync(input);
                success++;
                uploadedImages.Add(createdImage);
            }
            catch
            {
                failed++;
            }
        }

        PendingImages.Clear();

        if (ExistingListing != null && uploadedImages.Count > 0)
        {
            ExistingListing.Images.AddRange(uploadedImages);
            ExistingListing.Images = ExistingListing.Images
                .OrderBy(image => image.SortOrder)
                .ToList();
            StateHasChanged();
        }

        if (success > 0)
        {
            Snackbar.Add(L["GalleryManager:UploadSuccess"], Severity.Success);  
        }

        if (failed > 0)
        {
            Snackbar.Add($"Se encontraron {failed} errores al subir imagenes.", Severity.Warning);
        }
    }

    private async Task PublishListing()
    {
        if (!Id.HasValue) return;

        try
        {
            ExistingListing = await ListingService.PublishAsync(new PublishListingDto { ListingId = Id.Value });
            Snackbar.Add(L["Admin:Listings:Form:PublishSuccess"], Severity.Success);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add(L["Admin:Listings:Form:PublishError", ex.Message], Severity.Error);
        }
    }

    private async Task UnpublishListing()
    {
        if (!Id.HasValue) return;

        try
        {
            ExistingListing = await ListingService.UnpublishAsync(Id.Value);
            Snackbar.Add(L["Admin:Listings:Form:UnpublishSuccess"], Severity.Success);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add(L["Admin:Listings:Form:UnpublishError", ex.Message], Severity.Error);
        }
    }

    private async Task ArchiveListing()
    {
        var result = await DialogService.ShowMessageBox(
            L["Admin:Listings:Form:ArchiveTitle"],
            L["Admin:Listings:Form:ArchiveConfirm"],
            yesText: L["Admin:Listings:Archive"], cancelText: L["Common:Cancel"]);
        
        if (result == true && Id.HasValue)
        {
            try
            {
                ExistingListing = await ListingService.ArchiveAsync(Id.Value);
                Snackbar.Add(L["Admin:Listings:Form:ArchiveSuccess"], Severity.Success);
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Snackbar.Add(L["Admin:Listings:Form:ArchiveError", ex.Message], Severity.Error);
            }
        }
    }

    private async Task UnarchiveListing()
    {
        if (!Id.HasValue) return;
        
        try
        {
            ExistingListing = await ListingService.UnarchiveAsync(Id.Value);
            Snackbar.Add(L["Admin:Listings:Form:UnarchiveSuccess"], Severity.Success);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Snackbar.Add(L["Admin:Listings:Form:UnarchiveError", ex.Message], Severity.Error);
        }
    }

    private async Task MoveToPortfolio()
    {
        var result = await DialogService.ShowMessageBox(
            L["Admin:Listings:Form:MoveToPortfolioTitle"], 
            L["Admin:Listings:Form:MoveToPortfolioConfirm"],
            yesText: L["Admin:Listings:Form:MoveToPortfolioAction"], cancelText: L["Common:Cancel"]);
        
        if (result == true && Id.HasValue)
        {
            try
            {
                await PortfolioService.CreateFromListingAsync(Id.Value);
                ExistingListing = await ListingService.GetAsync(Id.Value);
                Snackbar.Add(L["Admin:Listings:Form:MoveToPortfolioSuccess"], Severity.Success);
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Snackbar.Add(L["Admin:Listings:Form:MoveToPortfolioError", ex.Message], Severity.Error);
            }
        }
    }

    private Color GetStatusColor(ListingStatus status) => status switch
    {
        ListingStatus.Draft => Color.Warning,
        ListingStatus.Published => Color.Success,
        ListingStatus.Archived => Color.Default,
        ListingStatus.Portfolio => Color.Info,
        _ => Color.Default
    };

    public class ListingViewModel : IValidatableObject
    {
        [Required]
        public string Title { get; set; } = string.Empty;
        [Required]
        public string Description { get; set; } = string.Empty;
        public string Location { get; set; } = string.Empty;
        public decimal? Price { get; set; }
        public bool IsPriceOnRequest { get; set; }
        public decimal LandArea { get; set; }
        public decimal ConstructionArea { get; set; }
        public int Bedrooms { get; set; }
        public int Bathrooms { get; set; }
        public Guid CategoryId { get; set; }
        public Guid TypeId { get; set; }
        public TransactionType TransactionType { get; set; } = TransactionType.Sale;
        public Guid ArchitectId { get; set; }

        public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
        {
            if (!IsPriceOnRequest && !Price.HasValue)
            {
                yield return new ValidationResult(
                    "Price es requerido cuando IsPriceOnRequest es false.",
                    new[] { nameof(Price) });
            }
        }
    }
}
