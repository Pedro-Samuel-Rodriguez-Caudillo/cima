@page "/admin"
@page "/admin/dashboard"
@using cima.Statistics
@using MudBlazor
@attribute [Authorize]
@inject IStatisticsAppService StatisticsService
@inject ISnackbar Snackbar
@inherits cimaComponentBase

<PageTitle>@L["Dashboard:Title"] - @L["CompanyName"]</PageTitle>

<div class="min-h-screen bg-neutral-50 pt-20"> @* pt-20 para compensar el navbar fixed *@
    <div class="bg-white border-b border-neutral-200">
        <div class="cima-container py-6">
            <h1 class="text-2xl md:text-3xl font-display font-bold text-neutral-900">
                @L["Dashboard:Welcome"]
            </h1>
            <p class="text-neutral-600 mt-1">@L["Dashboard:Subtitle"]</p>
        </div>
    </div>

    <div class="cima-container py-8">
        @if (IsLoading)
        {
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                @for (int i = 0; i < 4; i++)
                {
                    <MudCard Class="p-6">
                        <MudSkeleton Width="60%" Height="20px" Class="mb-2" />
                        <MudSkeleton Width="40%" Height="32px" />
                    </MudCard>
                }
            </div>
        }
        else if (Stats != null)
        {
            @* Stats Cards *@
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <MudCard Class="p-6 hover:shadow-lg transition-shadow">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-neutral-600">@L["Dashboard:TotalListings"]</span>
                        <MudIcon Icon="@Icons.Material.Filled.Home" Size="Size.Large" Color="Color.Primary" />
                    </div>
                    <div class="text-3xl font-bold text-neutral-900 mb-1">@Stats.TotalListings</div>
                    <div class="text-xs text-neutral-500">
                        <span class="text-green-600 font-medium">@Stats.PublishedListings</span> publicadas
                    </div>
                </MudCard>

                <MudCard Class="p-6 hover:shadow-lg transition-shadow">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-neutral-600">@L["Dashboard:TotalArchitects"]</span>
                        <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Large" Color="Color.Primary" />
                    </div>
                    <div class="text-3xl font-bold text-neutral-900 mb-1">@Stats.TotalArchitects</div>
                    <div class="text-xs text-neutral-500">
                        <span class="text-green-600 font-medium">@Stats.ActiveArchitects</span> activos
                    </div>
                </MudCard>

                <MudCard Class="p-6 hover:shadow-lg transition-shadow">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-neutral-600">@L["Dashboard:ContactRequests"]</span>
                        <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Large" Color="Color.Primary" />
                    </div>
                    <div class="text-3xl font-bold text-neutral-900 mb-1">@Stats.TotalContactRequests</div>
                    <div class="text-xs text-neutral-500">
                        <span class="text-yellow-600 font-medium">@Stats.PendingContactRequests</span> pendientes
                    </div>
                </MudCard>

                <MudCard Class="p-6 hover:shadow-lg transition-shadow">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-neutral-600">@L["Dashboard:DraftListings"]</span>
                        <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Large" Color="Color.Primary" />
                    </div>
                    <div class="text-3xl font-bold text-neutral-900 mb-1">@Stats.DraftListings</div>
                    <div class="text-xs text-neutral-500">
                        <span class="text-red-600 font-medium">@Stats.ArchivedListings</span> archivadas
                    </div>
                </MudCard>
            </div>

            @* Quick Actions *@
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <MudCard Class="p-6 hover:shadow-lg hover:border-primary transition-all cursor-pointer" @onclick="@(() => NavTo("/admin/listings/create"))">
                    <div class="flex items-center gap-4">
                        <MudAvatar Color="Color.Primary" Variant="Variant.Outlined" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.Add" />
                        </MudAvatar>
                        <div>
                            <div class="font-semibold text-neutral-900">@L["Dashboard:NewListing"]</div>
                            <div class="text-sm text-neutral-600">@L["Dashboard:NewListingDesc"]</div>
                        </div>
                    </div>
                </MudCard>

                <MudCard Class="p-6 hover:shadow-lg hover:border-primary transition-all cursor-pointer" @onclick="@(() => NavTo("/admin/architects/create"))">
                    <div class="flex items-center gap-4">
                        <MudAvatar Color="Color.Primary" Variant="Variant.Outlined" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.PersonAdd" />
                        </MudAvatar>
                        <div>
                            <div class="font-semibold text-neutral-900">@L["Dashboard:NewArchitect"]</div>
                            <div class="text-sm text-neutral-600">@L["Dashboard:NewArchitectDesc"]</div>
                        </div>
                    </div>
                </MudCard>

                <MudCard Class="p-6 hover:shadow-lg hover:border-primary transition-all cursor-pointer" @onclick="@(() => NavTo("/admin/listings"))">
                    <div class="flex items-center gap-4">
                        <MudAvatar Color="Color.Primary" Variant="Variant.Outlined" Size="Size.Large">
                            <MudIcon Icon="@Icons.Material.Filled.List" />
                        </MudAvatar>
                        <div>
                            <div class="font-semibold text-neutral-900">Ver Propiedades</div>
                            <div class="text-sm text-neutral-600">Gestionar catalogo de propiedades</div>
                        </div>
                    </div>
                </MudCard>
            </div>

            @* System Status *@
            <MudCard Class="p-6">
                <h3 class="text-lg font-semibold text-neutral-900 mb-4">@L["Dashboard:SystemStatus"]</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                        <div class="flex items-center gap-3">
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <span class="text-sm font-medium">@L["Dashboard:DatabaseConnection"]</span>
                        </div>
                        <MudChip T="string" Size="Size.Small" Color="Color.Success">@L["Common:Active"]</MudChip>
                    </div>

                    <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                        <div class="flex items-center gap-3">
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <span class="text-sm font-medium">@L["Dashboard:ApiStatus"]</span>
                        </div>
                        <MudChip T="string" Size="Size.Small" Color="Color.Success">@L["Common:Active"]</MudChip>
                    </div>

                    <div class="flex items-center justify-between p-3 bg-neutral-50 rounded-lg">
                        <span class="text-sm text-neutral-600">@L["Dashboard:LastUpdate"]</span>
                        <span class="text-sm font-medium">@Stats.LastUpdated.ToLocalTime().ToString("g")</span>
                    </div>
                </div>
            </MudCard>
        }
        else
        {
            <MudCard Class="p-16 text-center">
                <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Large" Color="Color.Error" Class="mb-4" />
                <h3 class="text-xl font-semibold text-neutral-900 mb-2">@L["Dashboard:ErrorLoading"]</h3>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadStats" Class="mt-4">
                    @L["Common:Retry"]
                </MudButton>
            </MudCard>
        }
    </div>
</div>

@code {
    [Inject] private NavigationManager Navigation { get; set; } = null!;

    private bool IsLoading { get; set; } = true;
    private DashboardStatsDto? Stats { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadStats();
    }

    private async Task LoadStats()
    {
        try
        {
            IsLoading = true;
            Stats = await StatisticsService.GetDashboardAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error al cargar estadísticas: {ex.Message}", Severity.Error);
            Stats = null;
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void NavTo(string url) => Navigation.NavigateTo(url);
}
