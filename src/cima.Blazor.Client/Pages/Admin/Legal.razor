@page "/admin/settings/legal"
@rendermode InteractiveAuto
@using cima.Settings
@using cima.Permissions
@attribute [Authorize(cimaPermissions.Settings.Manage)]
@inject ISiteSettingsAppService SettingsService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inherits cimaComponentBase

<PageTitle>@L["Admin:Settings:Legal:PageTitle"]</PageTitle>

<div class="min-h-screen bg-gray-50 pt-20">
    <div class="cima-container py-8">
        <div class="flex items-center gap-4 mb-8">
            <button @onclick="GoBack" class="w-10 h-10 flex items-center justify-center rounded-lg border border-gray-200 hover:bg-gray-100 transition-colors">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </button>
            <div>
                <h1 class="text-3xl font-display font-bold text-gray-900">@L["Admin:Settings:Legal:Title"]</h1>
                <p class="mt-1 text-gray-600">@L["Admin:Settings:Legal:Subtitle"]</p>
            </div>
        </div>

        @if (IsLoading)
        {
            <div class="flex justify-center py-12">
                <div class="cima-spinner"></div>
            </div>
        }
        else
        {
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900">@L["Admin:Settings:Legal:ContentTitle"]</h2>
                        <p class="text-sm text-gray-500">@L["Admin:Settings:Legal:ContentSubtitle"]</p>
                    </div>
                </div>

                <div class="space-y-6">
                    @* Privacy Policy *@
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            @L["Admin:Settings:Legal:Privacy"]
                            <span class="text-xs text-gray-500 ml-2">(Markdown)</span>
                        </label>
                        <textarea @bind="LegalContent.PrivacyContent" 
                                  class="cima-input font-mono text-sm" 
                                  rows="12"
                                  placeholder="# Política de Privacidad&#10;&#10;Escribe aquí el contenido en formato Markdown..."></textarea>
                    </div>

                    @* Terms & Conditions *@
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            @L["Admin:Settings:Legal:Terms"]
                            <span class="text-xs text-gray-500 ml-2">(Markdown)</span>
                        </label>
                        <textarea @bind="LegalContent.TermsContent" 
                                  class="cima-input font-mono text-sm" 
                                  rows="12"
                                  placeholder="# Términos y Condiciones&#10;&#10;Escribe aquí el contenido en formato Markdown..."></textarea>
                    </div>

                    <div class="pt-4 flex justify-end">
                        <button type="button" @onclick="SaveLegalContent" class="cima-btn cima-btn-primary" disabled="@IsSaving">
                            @if (IsSaving)
                            {
                                <span class="cima-spinner-sm mr-2"></span>
                            }
                            @L["Admin:Settings:Legal:Save"]
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private bool IsLoading { get; set; } = true;
    private bool IsSaving { get; set; }
    private LegalContentModel LegalContent { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadSettings();
    }

    private async Task LoadSettings()
    {
        try
        {
            IsLoading = true;
            var legalData = await SettingsService.GetLegalContentAsync();
            
            LegalContent = new LegalContentModel
            {
                PrivacyContent = legalData.PrivacyContent ?? "",
                TermsContent = legalData.TermsContent ?? ""
            };
        }
        catch (Exception ex)
        {
            await HandleErrorAsync(ex);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task SaveLegalContent()
    {
        try
        {
            IsSaving = true;
            await SettingsService.UpdateLegalContentAsync(new UpdateLegalContentDto
            {
                PrivacyContent = LegalContent.PrivacyContent,
                TermsContent = LegalContent.TermsContent
            });
            Snackbar.Add(L["Admin:Settings:Legal:Saved"], Severity.Success);
        }
        catch (Exception ex)
        {
            await HandleErrorAsync(ex);
        }
        finally
        {
            IsSaving = false;
        }
    }

    private void GoBack() => Navigation.NavigateTo("/admin/settings");

    private class LegalContentModel
    {
        public string PrivacyContent { get; set; } = "";
        public string TermsContent { get; set; } = "";
    }
}
