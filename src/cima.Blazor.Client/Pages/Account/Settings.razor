@page "/account/settings"
@attribute [Authorize]
@using Volo.Abp.Users
@using Microsoft.JSInterop

@inject NavigationManager Navigation
@inject IJSRuntime JS
@inherits cimaComponentBase

<PageTitle>@L["AccountSettings:Subtitle"] - @L["CompanyName"]</PageTitle>

<PageShell Variant="PageShellVariant.ContainerPadded" ContainerClass="cima-container max-w-4xl" Class="pb-12">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl md:text-4xl font-display font-bold text-neutral-900 mb-2">
                @L["Profile:Settings"]
            </h1>
            <p class="text-neutral-600">
                @L["AccountSettings:Subtitle"]
            </p>
        </div>

        <!-- Settings Sections -->
        <div class="space-y-6">
            <!-- Language Settings -->
            <div class="cima-card p-6">
                <h3 class="text-lg font-semibold text-neutral-900 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 21l5.25-11.25L21 21m-9-3h7.5M3 5.621a48.474 48.474 0 016-.371m0 0c1.12 0 2.233.038 3.334.114M9 5.25V3m3.334 2.364C11.176 10.658 7.69 15.08 3 17.502m9.334-12.138c.896.061 1.785.147 2.666.257m-4.589 8.495a18.023 18.023 0 01-3.827-5.802" />
                    </svg>
                    @L["AccountSettings:LanguageTitle"]
                </h3>
                <p class="text-neutral-600 mb-4">
                    @L["AccountSettings:LanguageSubtitle"]
                </p>
                <LanguageSelector ButtonClass="cima-btn cima-btn-secondary" />
            </div>

            <!-- Notifications (Placeholder) -->
            <div class="cima-card p-6">
                <h3 class="text-lg font-semibold text-neutral-900 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" />
                    </svg>
                    @L["AccountSettings:NotificationsTitle"]
                </h3>
                <p class="text-neutral-600 mb-4">
                    @L["AccountSettings:NotificationsSubtitle"]
                </p>
                <div class="space-y-3">
                    <div class="flex items-center justify-between p-3 bg-neutral-50 rounded">
                        <div>
                            <p class="font-medium text-neutral-900">@L["AccountSettings:EmailNotifications"]</p>
                            <p class="text-sm text-neutral-600">@L["AccountSettings:EmailNotificationsDesc"]</p>
                        </div>
                        <button class="@EmailNotificationsToggleClass"
                                type="button"
                                aria-pressed="@_emailNotificationsEnabled"
                                @onclick="ToggleEmailNotificationsAsync">
                            <span class="@EmailNotificationsToggleKnobClass"></span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Privacy (Placeholder) -->
            <div class="cima-card p-6">
                <h3 class="text-lg font-semibold text-neutral-900 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" />
                    </svg>
                    @L["AccountSettings:PrivacyTitle"]
                </h3>
                <p class="text-neutral-600 mb-4">
                    @L["AccountSettings:PrivacySubtitle"]
                </p>
                <div class="space-y-2">
                    <a href="/account/change-password" class="w-full text-left px-4 py-3 bg-neutral-50 hover:bg-neutral-100 rounded transition-colors block">
                        <p class="font-medium text-neutral-900">@L["ChangePassword:Title"]</p>
                        <p class="text-sm text-neutral-600">@L["AccountSettings:ChangePasswordDesc"]</p>
                    </a>
                    
                </div>
            </div>

            <!-- Account Actions -->
            <div class="cima-card p-6">
                <h3 class="text-lg font-semibold text-neutral-900 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
                    </svg>
                    @L["AccountSettings:AccountActions"]
                </h3>
                <div class="flex gap-3">
                    <a href="/account/profile" class="cima-btn cima-btn-secondary">
                        @L["AccountSettings:ViewProfile"]
                    </a>
                    <a href="/account/sales" class="cima-btn cima-btn-secondary">
                        @L["AccountSettings:ViewSales"]
                    </a>
                    <a href="/Account/Logout" class="cima-btn cima-btn-danger">
                        @L["Menu:Account:Logout"]
                    </a>
                </div>
            </div>
        </div>

        <!-- Back Button -->
        <div class="mt-6">
            <a href="/" class="cima-btn cima-btn-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                </svg>
                @L["Profile:BackToHome"]
            </a>
        </div>
</PageShell>

@code {
    private const string EmailNotificationsStorageKey = "account.emailNotifications";
    private bool _emailNotificationsEnabled = true;
    private bool _preferencesLoaded;

    private string EmailNotificationsToggleClass =>
        _emailNotificationsEnabled
            ? "relative inline-flex h-6 w-11 items-center rounded-full bg-emerald-500"
            : "relative inline-flex h-6 w-11 items-center rounded-full bg-neutral-300";

    private string EmailNotificationsToggleKnobClass =>
        _emailNotificationsEnabled
            ? "inline-block h-4 w-4 transform rounded-full bg-white transition translate-x-6"
            : "inline-block h-4 w-4 transform rounded-full bg-white transition translate-x-1";

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        if (!firstRender || _preferencesLoaded)
        {
            return;
        }

        var stored = await JS.InvokeAsync<string?>("localStorage.getItem", EmailNotificationsStorageKey);
        if (bool.TryParse(stored, out var enabled))
        {
            _emailNotificationsEnabled = enabled;
        }

        _preferencesLoaded = true;
        StateHasChanged();
    }

    private async Task ToggleEmailNotificationsAsync()
    {
        _emailNotificationsEnabled = !_emailNotificationsEnabled;
        await JS.InvokeVoidAsync("localStorage.setItem", EmailNotificationsStorageKey, _emailNotificationsEnabled.ToString().ToLowerInvariant());
    }
}
