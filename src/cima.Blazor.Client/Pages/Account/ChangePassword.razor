@page "/account/change-password"
@using cima.Listings.DTOs
@using Volo.Abp
@attribute [Authorize]
@inject IArchitectAppService ArchitectService
@inject NavigationManager NavManager
@inject ISnackbar Snackbar
@inherits cimaComponentBase

<PageTitle>@L["ChangePassword:PageTitle"] - @L["CompanyName"]</PageTitle>

<div class="min-h-screen bg-neutral-50 flex items-center justify-center p-4">
    <MudCard Class="w-full max-w-md p-6">
        <div class="text-center mb-6">
            <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Large" Color="Color.Primary" Class="mb-2" />
            <MudText Typo="Typo.h5">@L["ChangePassword:Title"]</MudText>

            @if (IsMandatoryChange)
            {
                <MudAlert Severity="Severity.Warning" Class="mt-4">
                    @L["ChangePassword:MandatoryAlert"]
                </MudAlert>
            }
            else
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                    @L["ChangePassword:Subtitle"]
                </MudText>
            }
        </div>

        <EditForm Model="@Model" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />

            <div class="space-y-4">
                <MudTextField @bind-Value="Model.CurrentPassword" Label="@L["ChangePassword:CurrentPassword"]" Required="true"
                    Variant="Variant.Outlined" InputType="@CurrentPasswordType"
                    Adornment="Adornment.End" AdornmentIcon="@CurrentPasswordIcon"
                    OnAdornmentClick="ToggleCurrentPassword" Disabled="@IsSubmitting" />

                <MudTextField @bind-Value="Model.NewPassword" Label="@L["ChangePassword:NewPassword"]" Required="true"
                    Variant="Variant.Outlined" InputType="@NewPasswordType"
                    Adornment="Adornment.End" AdornmentIcon="@NewPasswordIcon"
                    OnAdornmentClick="ToggleNewPassword" Disabled="@IsSubmitting"
                    HelperText="@L["ChangePassword:NewPasswordHint"]" />

                <MudTextField @bind-Value="Model.ConfirmPassword" Label="@L["ChangePassword:ConfirmPassword"]" Required="true"
                    Variant="Variant.Outlined" InputType="@ConfirmPasswordType"
                    Adornment="Adornment.End" AdornmentIcon="@ConfirmPasswordIcon"
                    OnAdornmentClick="ToggleConfirmPassword" Disabled="@IsSubmitting" />

                @if (!string.IsNullOrEmpty(ErrorMessage))
                {
                    <MudAlert Severity="Severity.Error">@ErrorMessage</MudAlert>
                }

                <MudButton Variant="Variant.Filled" Color="Color.Primary"
                    ButtonType="ButtonType.Submit" Disabled="@IsSubmitting" FullWidth="true" Class="mt-4">
                    @if (IsSubmitting)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <span>@L["ChangePassword:Submitting"]</span>
                    }
                    else
                    {
                        <span>@L["ChangePassword:Submit"]</span>
                    }
                </MudButton>

                @if (!IsMandatoryChange)
                {
                    <MudButton Variant="Variant.Text" FullWidth="true" Href="/" Class="mt-2">
                        @L["Common:Cancel"]
                    </MudButton>
                }
            </div>
        </EditForm>
    </MudCard>
</div>

@code {
    private ChangeArchitectPasswordDto Model { get; set; } = new();
    private bool IsSubmitting { get; set; }
    private bool IsMandatoryChange { get; set; }
    private string? ErrorMessage { get; set; }

    // Password visibility toggles
    private bool ShowCurrentPassword { get; set; }
    private bool ShowNewPassword { get; set; }
    private bool ShowConfirmPassword { get; set; }

    private InputType CurrentPasswordType => ShowCurrentPassword ? InputType.Text : InputType.Password;
    private InputType NewPasswordType => ShowNewPassword ? InputType.Text : InputType.Password;
    private InputType ConfirmPasswordType => ShowConfirmPassword ? InputType.Text : InputType.Password;

    private string CurrentPasswordIcon => ShowCurrentPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility;
    private string NewPasswordIcon => ShowNewPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility;
    private string ConfirmPasswordIcon => ShowConfirmPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility;

    private void ToggleCurrentPassword() => ShowCurrentPassword = !ShowCurrentPassword;
    private void ToggleNewPassword() => ShowNewPassword = !ShowNewPassword;
    private void ToggleConfirmPassword() => ShowConfirmPassword = !ShowConfirmPassword;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            IsMandatoryChange = await ArchitectService.MustChangePasswordAsync();
        }
        catch
        {
            IsMandatoryChange = false;
        }
    }

    private async Task HandleSubmit()
    {
        ErrorMessage = null;

        // Validaciones del lado del cliente
        if (string.IsNullOrWhiteSpace(Model.CurrentPassword))
        {
            ErrorMessage = L["ChangePassword:Error:CurrentRequired"];
            return;
        }

        if (string.IsNullOrWhiteSpace(Model.NewPassword))
        {
            ErrorMessage = L["ChangePassword:Error:NewRequired"];
            return;
        }

        if (Model.NewPassword != Model.ConfirmPassword)
        {
            ErrorMessage = L["ChangePassword:Error:Mismatch"];
            return;
        }

        if (Model.NewPassword.Length < 6)
        {
            ErrorMessage = L["ChangePassword:Error:TooShort"];
            return;
        }

        if (Model.CurrentPassword == Model.NewPassword)
        {
            ErrorMessage = L["ChangePassword:Error:SameAsOld"];
            return;
        }

        try
        {
            IsSubmitting = true;
            await ArchitectService.ChangePasswordAsync(Model);

            Snackbar.Add(L["ChangePassword:Success"], Severity.Success);
            NavManager.NavigateTo("/");
        }
        catch (UserFriendlyException ex)
        {
            // Errores amigables de ABP
            ErrorMessage = ex.Message;
        }
        catch (Volo.Abp.Validation.AbpValidationException ex)
        {
            // Errores de validaciÃ³n
            var firstError = ex.ValidationErrors.FirstOrDefault();
            ErrorMessage = firstError?.ErrorMessage ?? L["Validation:InvalidCharacters"];
        }
        catch (BusinessException ex)
        {
            // Errores de negocio
            ErrorMessage = TranslateBusinessError(ex.Code, ex.Message);
        }
        catch (Exception ex) when (ex.Message.Contains("incorrect", StringComparison.OrdinalIgnoreCase) ||
                                   ex.Message.Contains("password", StringComparison.OrdinalIgnoreCase))
        {
            ErrorMessage = L["ChangePassword:Error:Incorrect"];
        }
        catch (Exception)
        {
            ErrorMessage = L["ChangePassword:Error:Generic"];
        }
        finally
        {
            IsSubmitting = false;
        }
    }

    private string TranslateBusinessError(string? code, string defaultMessage)
    {
        return code switch
        {
            "Volo.Abp.Identity:PasswordMismatch" => L["ChangePassword:Error:Incorrect"],
            "Volo.Abp.Identity:PasswordTooShort" => L["ChangePassword:Error:TooShort"],
            "Volo.Abp.Identity:PasswordRequiresNonAlphanumeric" => L["Validation:InvalidCharacters"],
            "Volo.Abp.Identity:PasswordRequiresDigit" => L["Validation:InvalidCharacters"],
            "Volo.Abp.Identity:PasswordRequiresLower" => L["Validation:InvalidCharacters"],
            "Volo.Abp.Identity:PasswordRequiresUpper" => L["Validation:InvalidCharacters"],
            _ => defaultMessage
        };
    }
}
