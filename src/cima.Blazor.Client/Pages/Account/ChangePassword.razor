@page "/account/change-password"
@using cima.Architects
@using MudBlazor
@using Volo.Abp
@attribute [Authorize]
@inject IArchitectAppService ArchitectService
@inject NavigationManager NavManager
@inject ISnackbar Snackbar
@inherits cimaComponentBase

<PageTitle>Cambiar Contraseña - @L["CompanyName"]</PageTitle>

<div class="min-h-screen bg-neutral-50 flex items-center justify-center p-4">
    <MudCard Class="w-full max-w-md p-6">
        <div class="text-center mb-6">
            <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Large" Color="Color.Primary" Class="mb-2" />
            <MudText Typo="Typo.h5">Cambiar Contraseña</MudText>
            
            @if (IsMandatoryChange)
            {
                <MudAlert Severity="Severity.Warning" Class="mt-4">
                    Debes cambiar tu contraseña temporal antes de continuar.
                </MudAlert>
            }
            else
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                    Actualiza tu contraseña de acceso
                </MudText>
            }
        </div>

        <EditForm Model="@Model" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />
            
            <div class="space-y-4">
                <MudTextField @bind-Value="Model.CurrentPassword" Label="Contraseña Actual" Required="true"
                    Variant="Variant.Outlined" InputType="@CurrentPasswordType"
                    Adornment="Adornment.End" AdornmentIcon="@CurrentPasswordIcon"
                    OnAdornmentClick="ToggleCurrentPassword" Disabled="@IsSubmitting" />

                <MudTextField @bind-Value="Model.NewPassword" Label="Nueva Contraseña" Required="true"
                    Variant="Variant.Outlined" InputType="@NewPasswordType"
                    Adornment="Adornment.End" AdornmentIcon="@NewPasswordIcon"
                    OnAdornmentClick="ToggleNewPassword" Disabled="@IsSubmitting"
                    HelperText="Mínimo 6 caracteres, incluir mayúsculas, minúsculas y números" />

                <MudTextField @bind-Value="Model.ConfirmPassword" Label="Confirmar Nueva Contraseña" Required="true"
                    Variant="Variant.Outlined" InputType="@ConfirmPasswordType"
                    Adornment="Adornment.End" AdornmentIcon="@ConfirmPasswordIcon"
                    OnAdornmentClick="ToggleConfirmPassword" Disabled="@IsSubmitting" />

                @if (!string.IsNullOrEmpty(ErrorMessage))
                {
                    <MudAlert Severity="Severity.Error">@ErrorMessage</MudAlert>
                }

                <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                    ButtonType="ButtonType.Submit" Disabled="@IsSubmitting" FullWidth="true" Class="mt-4">
                    @if (IsSubmitting)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <span>Cambiando...</span>
                    }
                    else
                    {
                        <span>Cambiar Contraseña</span>
                    }
                </MudButton>

                @if (!IsMandatoryChange)
                {
                    <MudButton Variant="Variant.Text" FullWidth="true" Href="/" Class="mt-2">
                        Cancelar
                    </MudButton>
                }
            </div>
        </EditForm>
    </MudCard>
</div>

@code {
    private ChangeArchitectPasswordDto Model { get; set; } = new();
    private bool IsSubmitting { get; set; }
    private bool IsMandatoryChange { get; set; }
    private string? ErrorMessage { get; set; }

    // Password visibility toggles
    private bool ShowCurrentPassword { get; set; }
    private bool ShowNewPassword { get; set; }
    private bool ShowConfirmPassword { get; set; }

    private InputType CurrentPasswordType => ShowCurrentPassword ? InputType.Text : InputType.Password;
    private InputType NewPasswordType => ShowNewPassword ? InputType.Text : InputType.Password;
    private InputType ConfirmPasswordType => ShowConfirmPassword ? InputType.Text : InputType.Password;

    private string CurrentPasswordIcon => ShowCurrentPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility;
    private string NewPasswordIcon => ShowNewPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility;
    private string ConfirmPasswordIcon => ShowConfirmPassword ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility;

    private void ToggleCurrentPassword() => ShowCurrentPassword = !ShowCurrentPassword;
    private void ToggleNewPassword() => ShowNewPassword = !ShowNewPassword;
    private void ToggleConfirmPassword() => ShowConfirmPassword = !ShowConfirmPassword;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            IsMandatoryChange = await ArchitectService.MustChangePasswordAsync();
        }
        catch
        {
            IsMandatoryChange = false;
        }
    }

    private async Task HandleSubmit()
    {
        ErrorMessage = null;

        // Validaciones del lado del cliente
        if (string.IsNullOrWhiteSpace(Model.CurrentPassword))
        {
            ErrorMessage = "Ingresa tu contraseña actual";
            return;
        }

        if (string.IsNullOrWhiteSpace(Model.NewPassword))
        {
            ErrorMessage = "Ingresa la nueva contraseña";
            return;
        }

        if (Model.NewPassword != Model.ConfirmPassword)
        {
            ErrorMessage = "Las contraseñas no coinciden";
            return;
        }

        if (Model.NewPassword.Length < 6)
        {
            ErrorMessage = "La contraseña debe tener al menos 6 caracteres";
            return;
        }

        if (Model.CurrentPassword == Model.NewPassword)
        {
            ErrorMessage = "La nueva contraseña debe ser diferente a la actual";
            return;
        }

        try
        {
            IsSubmitting = true;
            await ArchitectService.ChangePasswordAsync(Model);
            
            Snackbar.Add("Contraseña cambiada exitosamente", Severity.Success);
            NavManager.NavigateTo("/");
        }
        catch (UserFriendlyException ex)
        {
            // Errores amigables de ABP
            ErrorMessage = ex.Message;
        }
        catch (Volo.Abp.Validation.AbpValidationException ex)
        {
            // Errores de validación
            var firstError = ex.ValidationErrors.FirstOrDefault();
            ErrorMessage = firstError?.ErrorMessage ?? "Por favor verifica los datos ingresados";
        }
        catch (BusinessException ex)
        {
            // Errores de negocio
            ErrorMessage = TranslateBusinessError(ex.Code, ex.Message);
        }
        catch (Exception ex) when (ex.Message.Contains("incorrect", StringComparison.OrdinalIgnoreCase) ||
                                   ex.Message.Contains("password", StringComparison.OrdinalIgnoreCase))
        {
            ErrorMessage = "La contraseña actual es incorrecta";
        }
        catch (Exception)
        {
            ErrorMessage = "No se pudo cambiar la contraseña. Intenta de nuevo.";
        }
        finally
        {
            IsSubmitting = false;
        }
    }

    private string TranslateBusinessError(string? code, string defaultMessage)
    {
        return code switch
        {
            "Volo.Abp.Identity:PasswordMismatch" => "La contraseña actual es incorrecta",
            "Volo.Abp.Identity:PasswordTooShort" => "La contraseña debe tener al menos 6 caracteres",
            "Volo.Abp.Identity:PasswordRequiresNonAlphanumeric" => "La contraseña debe incluir al menos un carácter especial",
            "Volo.Abp.Identity:PasswordRequiresDigit" => "La contraseña debe incluir al menos un número",
            "Volo.Abp.Identity:PasswordRequiresLower" => "La contraseña debe incluir al menos una letra minúscula",
            "Volo.Abp.Identity:PasswordRequiresUpper" => "La contraseña debe incluir al menos una letra mayúscula",
            _ => defaultMessage
        };
    }
}
