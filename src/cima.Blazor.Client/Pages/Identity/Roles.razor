@page "/admin/identity/roles"
@using cima.Identity
@using Volo.Abp.Authorization.Permissions
@using Volo.Abp.PermissionManagement
@attribute [Authorize(IdentityPermissions.Roles.Default)]
@inherits cimaComponentBase

<PageTitle>@L["Identity:Roles:Title"]</PageTitle>

<PageShell Variant="PageShellVariant.ContainerWide" Class="py-6 md:py-8">
    @* Contenedor de página (ancho máximo y padding consistente) *@

        @* Encabezado: título + acciones *@
        <MudPaper Class="p-4 mb-4 w-full" Elevation="1">
            <MudStack Row="true"
                      AlignItems="AlignItems.Center"
                      Justify="Justify.SpaceBetween"
                      Spacing="2"
                      Class="w-full flex-wrap">
                <MudStack Class="min-w-[220px]">
                    <MudText Typo="Typo.h5">@L["Identity:Roles:Title"]</MudText>
                    <MudText Typo="Typo.body2" Class="mud-text-secondary">
                        @L["Identity:Roles:Subtitle"]
                    </MudText>
                </MudStack>

                @* Acciones (en móvil se envuelven) *@
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="flex-wrap justify-end">
                    <MudTextField T="string"
                                  Value="@_filter"
                                  ValueChanged="OnFilterChanged"
                                  Placeholder="@L["Identity:Roles:SearchPlaceholder"]"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  Immediate="true"
                                  DebounceInterval="300"
                                  Class="min-w-48" />

                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Secondary"
                               StartIcon="@Icons.Material.Filled.Clear"
                               OnClick="ClearFilters"
                               Disabled="_loading">
                        @L["Common:Clear"]
                    </MudButton>

                    <MudButton Color="Color.Primary"
                               Variant="Variant.Filled"
                               StartIcon="@Icons.Material.Filled.Refresh"
                               OnClick="LoadRoles"
                               Disabled="_loading">
                        @L["Common:Refresh"]
                    </MudButton>

                    <MudButton Color="Color.Secondary"
                               Variant="Variant.Outlined"
                               StartIcon="@Icons.Material.Filled.Add"
                               OnClick="OpenCreateRoleDialog"
                               Disabled="_loading">
                        @L["Identity:Roles:Create"]
                    </MudButton>
                </MudStack>
            </MudStack>

            @* Filtros secundarios *@
            <MudStack Row="true"
                      AlignItems="AlignItems.Center"
                      Justify="Justify.Center"
                      Spacing="1"
                      Class="mt-3 w-full flex-wrap">
                <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Common:Filter"]:</MudText>

                <MudButton Variant="@(_roleFilter == RoleFilterAll ? Variant.Filled : Variant.Outlined)"
                           Color="Color.Primary"
                           Size="Size.Small"
                           OnClick="@(() => SetRoleFilter(RoleFilterAll))">
                    @L["Common:All"]
                </MudButton>

                <MudButton Variant="@(_roleFilter == RoleFilterDefault ? Variant.Filled : Variant.Outlined)"
                           Color="Color.Info"
                           Size="Size.Small"
                           OnClick="@(() => SetRoleFilter(RoleFilterDefault))">
                    @L["Identity:Roles:Filters:Default"]
                </MudButton>

                <MudButton Variant="@(_roleFilter == RoleFilterPublic ? Variant.Filled : Variant.Outlined)"
                           Color="Color.Success"
                           Size="Size.Small"
                           OnClick="@(() => SetRoleFilter(RoleFilterPublic))">
                    @L["Identity:Roles:Filters:Public"]
                </MudButton>
            </MudStack>
        </MudPaper>

        @* Resumen: 3 tarjetas (stack en móvil, 3 columnas en md+) *@
        <MudGrid Spacing="4" Class="mb-4">
            <MudItem xs="12" md="4">
                <MudPaper Class="p-4 w-full" Elevation="1">
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Common:Total"]</MudText>
                    <MudText Typo="Typo.h6">@_roles.Count</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudPaper Class="p-4 w-full" Elevation="1">
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Identity:Roles:Summary:Default"]</MudText>
                    <MudText Typo="Typo.h6">@DefaultRolesCount</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudPaper Class="p-4 w-full" Elevation="1">
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Identity:Roles:Summary:Public"]</MudText>
                    <MudText Typo="Typo.h6">@PublicRolesCount</MudText>
                </MudPaper>
            </MudItem>
        </MudGrid>

        @* Contenido principal: tabla (más ancha) + panel derecho *@
        <MudGrid Spacing="4" Class="items-start">
            <MudItem xs="12">
                <MudPaper Class="p-0 w-full" Elevation="1" Style="min-width:0;">
                    <MudTable T="IdentityRoleDto" Items="FilteredRoles"
                              Dense="true"
                              Hover="true"
                              Striped="true"
                              RowClick="OnRoleRowClick"
                              Loading="_loading"
                              Class="w-full">
                        <ToolBarContent>
                            <MudText Typo="Typo.subtitle2">@L["Identity:Roles:Count", FilteredRoles.Count]</MudText>
                        </ToolBarContent>

                        <LoadingContent>
                            <div class="p-6 text-center text-sm text-neutral-500">
                                @L["Identity:Roles:Loading"]
                            </div>
                        </LoadingContent>

                        <HeaderContent>
                            <MudTh>@L["Identity:Roles:Table:Name"]</MudTh>
                            <MudTh>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudText Typo="Typo.subtitle2">@L["Identity:Roles:Table:Default"]</MudText>
                                    <MudTooltip Text="@L["Identity:Roles:Tooltip:Default"]">
                                        <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="text-neutral-400" />
                                    </MudTooltip>
                                </MudStack>
                            </MudTh>
                            <MudTh>
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                    <MudText Typo="Typo.subtitle2">@L["Identity:Roles:Table:Public"]</MudText>
                                    <MudTooltip Text="@L["Identity:Roles:Tooltip:Public"]">
                                        <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Class="text-neutral-400" />
                                    </MudTooltip>
                                </MudStack>
                            </MudTh>
                            <MudTh>@L["Identity:Roles:Table:Created"]</MudTh>
                            <MudTh></MudTh>
                        </HeaderContent>

                        <RowTemplate>
                            
                            <MudTd DataLabel="@L["Identity:Roles:Table:Name"]"
                                   @ondblclick="() => OpenRoleDialog(context)">
                                <MudText Typo="Typo.subtitle2">@context.Name</MudText>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@context.Id</MudText>
                            </MudTd>

                            <MudTd DataLabel="@L["Identity:Roles:Table:Default"]"
                                   @ondblclick="() => OpenRoleDialog(context)">
                                <MudChip T="string" Color="@(context.IsDefault? Color.Info: Color.Default)" Size="Size.Small">
                                    @(context.IsDefault? L["Common:Yes"] : L["Common:No"])
                                </MudChip>
                            </MudTd>

                            <MudTd DataLabel="@L["Identity:Roles:Table:Public"]"
                                   @ondblclick="() => OpenRoleDialog(context)">
                                <MudChip T="string" Color="@(context.IsPublic? Color.Success: Color.Default)" Size="Size.Small">
                                    @(context.IsPublic? L["Common:Yes"] : L["Common:No"])
                                </MudChip>
                            </MudTd>

                            <MudTd DataLabel="@L["Identity:Roles:Table:Created"]"
                                   @ondblclick="() => OpenRoleDialog(context)">
                                @context.CreationTime.ToLocalTime().ToString("g")
                            </MudTd>

                            <MudTd DataLabel="@L["Common:Actions"]"
                                   @ondblclick="() => OpenRoleDialog(context)">
                                <MudMenu Icon="@Icons.Material.Filled.MoreVert"
                                         Dense="true"
                                         Color="Color.Default"
                                         @onclick:stopPropagation="true">
                                    <MudMenuItem Icon="@Icons.Material.Filled.ManageAccounts"
                                                 OnClick="@(() => OpenRoleDialog(context))">
                                        @L["Identity:Roles:Dialog:Open"]
                                    </MudMenuItem>
                                    <MudMenuItem Icon="@Icons.Material.Filled.ContentCopy"
                                                 OnClick="@(() => CopyRoleIdAsync(context))">
                                        @L["Common:CopyId"]
                                    </MudMenuItem>
                                </MudMenu>
                            </MudTd>
                            
                        </RowTemplate>

                        <NoRecordsContent>
                            <MudText class="p-4">@L["Identity:Roles:Empty"]</MudText>
                        </NoRecordsContent>
                    </MudTable>
                </MudPaper>
            </MudItem>

        </MudGrid>
</PageShell>

@code {
    [Inject] public IIdentityRoleAppService RoleAppService { get; set; } = default!;
    [Inject] public IJSRuntime JS { get; set; } = default!;
    [Inject] public IDialogService DialogService { get; set; } = default!;

    private IReadOnlyList<IdentityRoleDto> _roles = Array.Empty<IdentityRoleDto>();
    private string? _filter;
    private bool _loading;
    private string _roleFilter = RoleFilterAll;
    private bool _openingDialog;

    private const string RoleFilterAll = "all";
    private const string RoleFilterDefault = "default";
    private const string RoleFilterPublic = "public";

    private IReadOnlyList<IdentityRoleDto> FilteredRoles =>
        _roleFilter switch
        {
            RoleFilterDefault => _roles.Where(role => role.IsDefault).ToList(),
            RoleFilterPublic => _roles.Where(role => role.IsPublic).ToList(),
            _ => _roles
        };

    private int DefaultRolesCount => _roles.Count(role => role.IsDefault);
    private int PublicRolesCount => _roles.Count(role => role.IsPublic);

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadRoles();
    }

    private async Task LoadRoles()
    {
        try
        {
            _loading = true;
            var result = await RoleAppService.GetListAsync(new GetIdentityRolesInput
            {
                MaxResultCount = 128,
                Sorting = "Name",
                Filter = _filter
            });

            _roles = result.Items;
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(L["Identity:Roles:Error:Load"], GetUserFriendlyErrorMessage(ex)), Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OnFilterChanged(string value)
    {
        _filter = value;
        await LoadRoles();
    }

    private void SetRoleFilter(string filter)
    {
        _roleFilter = filter;
    }

    private async Task ClearFilters()
    {
        _filter = null;
        _roleFilter = RoleFilterAll;
        await LoadRoles();
    }

    private async Task OnRoleRowClick(TableRowClickEventArgs<IdentityRoleDto> args)
    {
        if (args?.Item is null)
        {
            return;
        }

        await OpenRoleDialog(args.Item);
    }

    private async Task CopyRoleIdAsync(IdentityRoleDto role)
    {
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", role.Id.ToString());
        Snackbar.Add(L["Common:Copied"], Severity.Success);
    }

    private async Task OpenRoleDialog(IdentityRoleDto role)
    {
        if (_openingDialog)
        {
            return;
        }

        _openingDialog = true;
        try
        {
            var parameters = new DialogParameters
            {
                ["RoleId"] = role.Id
            };
            var options = new DialogOptions
            {
                CloseOnEscapeKey = true,
                MaxWidth = MaxWidth.Large,
                FullWidth = true
            };

            var dialog = await DialogService.ShowAsync<RoleDetailsDialog>(string.Empty, parameters, options);
            var result = await dialog.Result;
            if (!result.Canceled)
            {
                await LoadRoles();
            }
        }
        finally
        {
            _openingDialog = false;
        }
    }

    private async Task OpenCreateRoleDialog()
    {
        if (_openingDialog)
        {
            return;
        }

        _openingDialog = true;
        try
        {
            var parameters = new DialogParameters
            {
                ["IsCreate"] = true
            };
            var options = new DialogOptions
            {
                CloseOnEscapeKey = true,
                MaxWidth = MaxWidth.Large,
                FullWidth = true
            };

            var dialog = await DialogService.ShowAsync<RoleDetailsDialog>(string.Empty, parameters, options);
            var result = await dialog.Result;
            if (!result.Canceled)
            {
                await LoadRoles();
            }
        }
        finally
        {
            _openingDialog = false;
        }
    }
}
