@page "/admin/identity/users"
@using System.Text
@using cima.Identity
@attribute [Authorize(IdentityPermissions.Users.Default)]
@inherits cimaComponentBase

<PageTitle>@L["Identity:Users:Title"]</PageTitle>

<PageShell Variant="PageShellVariant.ContainerWide" Class="py-6 md:py-8">
    @* Contenedor de p�gina: controla el ancho m�ximo y elimina el �vac�o� lateral *@

        @* Encabezado: t�tulo + acciones (wrap en m�vil) *@
        <MudPaper Class="p-4 mb-4 w-full" Elevation="1">
            <MudStack Row="true"
                      AlignItems="AlignItems.Center"
                      Justify="Justify.SpaceBetween"
                      Spacing="2"
                      Class="w-full flex-wrap">
                <MudStack Class="min-w-[220px]">
                    <MudText Typo="Typo.h5">@L["Identity:Users:Title"]</MudText>
                    <MudText Typo="Typo.body2" Class="mud-text-secondary">
                        @L["Identity:Users:Subtitle"]
                    </MudText>
                </MudStack>

                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="flex-wrap justify-end">
                    <MudTextField T="string"
                                  Value="@_filter"
                                  ValueChanged="OnFilterChanged"
                                  Placeholder="@L["Identity:Users:SearchPlaceholder"]"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  Immediate="true"
                                  DebounceInterval="300"
                                  Class="min-w-56" />

                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Secondary"
                               StartIcon="@Icons.Material.Filled.Clear"
                               OnClick="ClearFilters"
                               Disabled="_loading">
                        @L["Common:Clear"]
                    </MudButton>

                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Info"
                               StartIcon="@Icons.Material.Filled.FileDownload"
                               OnClick="ExportUsersAsync"
                               Disabled="_loading">
                        @L["Common:Export"]
                    </MudButton>

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Secondary"
                               StartIcon="@Icons.Material.Filled.PersonAdd"
                               OnClick="OpenCreateUserDialog"
                               Disabled="_loading">
                        @L["Identity:Users:Create"]
                    </MudButton>

                    <MudButton Color="Color.Primary"
                               Variant="Variant.Filled"
                               StartIcon="@Icons.Material.Filled.Refresh"
                               OnClick="LoadUsers"
                               Disabled="_loading">
                        @L["Common:Refresh"]
                    </MudButton>
                </MudStack>
            </MudStack>

            @* Filtros secundarios (wrap en m�vil) *@
            <MudStack Row="true"
                      AlignItems="AlignItems.Center"
                      Justify="Justify.Center"
                      Spacing="1"
                      Class="mt-3 w-full flex-wrap">
                <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Common:Filter"]:</MudText>

                <MudButton Variant="@(_statusFilter == StatusAll ? Variant.Filled : Variant.Outlined)"
                           Color="Color.Primary"
                           Size="Size.Small"
                           OnClick="@(() => SetStatusFilter(StatusAll))">
                    @L["Common:All"]
                </MudButton>

                <MudButton Variant="@(_statusFilter == StatusActive ? Variant.Filled : Variant.Outlined)"
                           Color="Color.Success"
                           Size="Size.Small"
                           OnClick="@(() => SetStatusFilter(StatusActive))">
                    @L["Common:Active"]
                </MudButton>

                <MudButton Variant="@(_statusFilter == StatusInactive ? Variant.Filled : Variant.Outlined)"
                           Color="Color.Error"
                           Size="Size.Small"
                           OnClick="@(() => SetStatusFilter(StatusInactive))">
                    @L["Common:Inactive"]
                </MudButton>
            </MudStack>
        </MudPaper>

        @* Resumen: 3 tarjetas (stack en m�vil, 3 columnas en md+) *@
        <MudGrid Spacing="4" Class="mb-4">
            <MudItem xs="12" md="4">
                <MudPaper Class="p-4 w-full" Elevation="1">
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Common:Total"]</MudText>
                    <MudText Typo="Typo.h6">@_users.Count</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudPaper Class="p-4 w-full" Elevation="1">
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Common:Active"]</MudText>
                    <MudText Typo="Typo.h6">@ActiveUsersCount</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudPaper Class="p-4 w-full" Elevation="1">
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Common:Inactive"]</MudText>
                    <MudText Typo="Typo.h6">@InactiveUsersCount</MudText>
                </MudPaper>
            </MudItem>
        </MudGrid>

        @* Contenido principal: tabla (m�s ancha) + panel derecho *@
        <MudGrid Spacing="4" Class="items-start">
            <MudItem xs="12">
                <MudPaper Class="p-0 w-full" Elevation="1" Style="min-width:0;">
                    <MudTable T="IdentityUserDto" Items="FilteredUsers"
                              Dense="true"
                              Hover="true"
                              Striped="true"
                              RowClick="OnUserRowClick"
                              Loading="_loading"
                              Class="w-full">
                        <ToolBarContent>
                            <MudText Typo="Typo.subtitle2">
                                @L["Identity:Users:Count", FilteredUsers.Count]
                            </MudText>
                        </ToolBarContent>

                        <LoadingContent>
                            <div class="p-6 text-center text-sm text-neutral-500">
                                @L["Identity:Users:Loading"]
                            </div>
                        </LoadingContent>

                        <HeaderContent>
                            <MudTh>@L["Identity:Users:Table:UserName"]</MudTh>
                            <MudTh>@L["Identity:Users:Table:Email"]</MudTh>
                            <MudTh>@L["Identity:Users:Table:Phone"]</MudTh>
                            <MudTh>@L["Identity:Users:Table:Active"]</MudTh>
                            <MudTh>@L["Identity:Users:Table:Created"]</MudTh>
                            <MudTh>@L["Identity:Users:Table:Roles"]</MudTh>
                            <MudTh></MudTh>
                        </HeaderContent>

                        <RowTemplate>
                            
                            <MudTd DataLabel="@L["Identity:Users:Table:UserName"]"
                                   @ondblclick="() => OpenUserDialog(context)">
                                <MudText Typo="Typo.subtitle2">@context.UserName</MudText>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@context.Id</MudText>
                            </MudTd>

                            <MudTd DataLabel="@L["Identity:Users:Table:Email"]"
                                   @ondblclick="() => OpenUserDialog(context)">
                                @if (!string.IsNullOrWhiteSpace(context.Email))
                                {
                                    <MudText>@context.Email</MudText>
                                }
                                else
                                {
                                    <MudText Class="mud-text-secondary">@L["Identity:Users:Table:NoEmail"]</MudText>
                                }
                            </MudTd>

                            <MudTd DataLabel="@L["Identity:Users:Table:Phone"]"
                                   @ondblclick="() => OpenUserDialog(context)">
                                @if (!string.IsNullOrWhiteSpace(context.PhoneNumber))
                                {
                                    <MudText>@context.PhoneNumber</MudText>
                                }
                                else
                                {
                                    <MudText Class="mud-text-secondary">-</MudText>
                                }
                            </MudTd>

                            <MudTd DataLabel="@L["Identity:Users:Table:Active"]"
                                   @ondblclick="() => OpenUserDialog(context)">
                                <MudChip T="string" Color="@(context.IsActive? Color.Success: Color.Error)" Size="Size.Small">
                                    @(context.IsActive? L["Common:Yes"] : L["Common:No"])
                                </MudChip>
                            </MudTd>

                            <MudTd DataLabel="@L["Identity:Users:Table:Created"]"
                                   @ondblclick="() => OpenUserDialog(context)">
                                @context.CreationTime.ToLocalTime().ToString("g")
                            </MudTd>

                            <MudTd DataLabel="@L["Identity:Users:Table:Roles"]"
                                   @ondblclick="() => OpenUserDialog(context)">
                                @if (_userRolesById.TryGetValue(context.Id, out var roles) && roles.Any())
                                {
                                    <MudChipSet T="string" SelectionMode="SelectionMode.MultiSelection" ReadOnly="true" Class="flex flex-wrap gap-1">
                                        @foreach (var role in roles)
                                        {
                                            <MudChip T="string" Color="Color.Primary" Variant="Variant.Outlined" Size="Size.Small">
                                                @role.Name
                                            </MudChip>
                                        }
                                    </MudChipSet>
                                }
                                else
                                {
                                    <MudText Class="mud-text-secondary">@L["Identity:Users:Table:NoRoles"]</MudText>
                                }
                            </MudTd>

                            <MudTd DataLabel="@L["Common:Actions"]"
                                   @ondblclick="() => OpenUserDialog(context)">
                                <MudMenu Icon="@Icons.Material.Filled.MoreVert"
                                         Dense="true"
                                         Color="Color.Default"
                                         @onclick:stopPropagation="true">
                                    <MudMenuItem Icon="@Icons.Material.Filled.ManageAccounts"
                                                 OnClick="@(() => OpenUserDialog(context))">
                                        @L["Identity:Users:Dialog:Open"]
                                    </MudMenuItem>
                                    <MudMenuItem Icon="@Icons.Material.Filled.ContentCopy" OnClick="@(() => CopyUserIdAsync(context))">
                                        @L["Common:CopyId"]
                                    </MudMenuItem>
                                    <MudMenuItem Icon="@Icons.Material.Filled.Key" OnClick="@(() => OpenResetDialog(context))">
                                        @L["Identity:Users:ResetPassword"]
                                    </MudMenuItem>
                                </MudMenu>
                            </MudTd>
                            
                        </RowTemplate>

                        <NoRecordsContent>
                            <MudText class="p-4">@L["Identity:Users:Empty"]</MudText>
                        </NoRecordsContent>
                    </MudTable>
                </MudPaper>
            </MudItem>

        </MudGrid>
</PageShell>


@code {
    [Inject] public IIdentityUserAppService UserAppService { get; set; } = default!;
    [Inject] public IJSRuntime JS { get; set; } = default!;
    [Inject] public IDialogService DialogService { get; set; } = default!;

    private IReadOnlyList<IdentityUserDto> _users = Array.Empty<IdentityUserDto>();
    private Dictionary<Guid, IReadOnlyList<IdentityRoleDto>> _userRolesById = new();
    private string? _filter;
    private bool _loading;
    private string _statusFilter = StatusAll;
    private bool _openingDialog;

    private const string StatusAll = "all";
    private const string StatusActive = "active";
    private const string StatusInactive = "inactive";

    private IReadOnlyList<IdentityUserDto> FilteredUsers =>
        _statusFilter switch
        {
            StatusActive => _users.Where(user => user.IsActive).ToList(),
            StatusInactive => _users.Where(user => !user.IsActive).ToList(),
            _ => _users
        };

    private int ActiveUsersCount => _users.Count(user => user.IsActive);
    private int InactiveUsersCount => _users.Count - ActiveUsersCount;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        try
        {
            _loading = true;
            var result = await UserAppService.GetListAsync(new GetIdentityUsersInput
            {
                MaxResultCount = 64,
                Sorting = "CreationTime DESC",
                Filter = _filter
            });

            var users = result.Items;
            _userRolesById = await LoadUserRolesAsync(users);
            _users = users;
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(L["Identity:Users:Error:Load"], GetUserFriendlyErrorMessage(ex)), Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OnFilterChanged(string value)
    {
        _filter = value;
        await LoadUsers();
    }

    private async Task OnUserRowClick(TableRowClickEventArgs<IdentityUserDto> args)
    {
        if (args?.Item is null)
        {
            return;
        }

        await OpenUserDialog(args.Item);
    }

    private async Task OpenUserDialog(IdentityUserDto user, string? initialTab = null)
    {
        if (_openingDialog)
        {
            return;
        }

        _openingDialog = true;
        try
        {
            var parameters = new DialogParameters
            {
                ["UserId"] = user.Id,
                ["InitialTab"] = initialTab
            };
            var options = new DialogOptions
            {
                CloseOnEscapeKey = false,
                MaxWidth = MaxWidth.Large,
                FullWidth = true
            };

            var dialog = await DialogService.ShowAsync<UserDetailsDialog>(string.Empty, parameters, options);
            var result = await dialog.Result;
            if (!result.Canceled)
            {
                await LoadUsers();
            }
        }
        finally
        {
            _openingDialog = false;
        }
    }

    private async Task OpenCreateUserDialog()
    {
        if (_openingDialog)
        {
            return;
        }

        _openingDialog = true;
        try
        {
            var parameters = new DialogParameters
            {
                ["IsCreate"] = true
            };
            var options = new DialogOptions
            {
                CloseOnEscapeKey = false,
                MaxWidth = MaxWidth.Large,
                FullWidth = true
            };

            var dialog = await DialogService.ShowAsync<UserDetailsDialog>(string.Empty, parameters, options);
            var result = await dialog.Result;
            if (!result.Canceled)
            {
                await LoadUsers();
            }
        }
        finally
        {
            _openingDialog = false;
        }
    }

    private async Task CopyUserIdAsync(IdentityUserDto user)
    {
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", user.Id.ToString());
        Snackbar.Add(L["Common:Copied"], Severity.Success);
    }

    private Task OpenResetDialog(IdentityUserDto user)
    {
        return OpenUserDialog(user, "security");
    }

    private async Task ExportUsersAsync()
    {
        try
        {
            var sb = new StringBuilder();
            sb.AppendLine(L["Identity:Users:Export:Header"]);

            foreach (var user in FilteredUsers)
            {
                var roles = _userRolesById.TryGetValue(user.Id, out var userRoles)
                    ? string.Join("|", userRoles.Select(role => role.Name))
                    : string.Empty;

                sb.AppendLine(string.Join(",",
                    EscapeCsv(user.Id.ToString()),
                    EscapeCsv(user.UserName),
                    EscapeCsv(user.Email),
                    EscapeCsv(user.PhoneNumber),
                    EscapeCsv(user.IsActive ? "Si" : "No"),
                    EscapeCsv(user.CreationTime.ToLocalTime().ToString("g")),
                    EscapeCsv(roles)));
            }

            var csv = sb.ToString();
            var base64 = Convert.ToBase64String(Encoding.UTF8.GetBytes(csv));
            var fileName = $"usuarios-{DateTime.Now:yyyyMMdd-HHmm}.csv";
            await JS.InvokeVoidAsync("downloadFileFromBase64", fileName, base64, "text/csv");
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(L["Identity:Users:Error:Export"], GetUserFriendlyErrorMessage(ex)), Severity.Error);
        }
    }

    private static string EscapeCsv(string? value)
    {
        if (string.IsNullOrEmpty(value))
        {
            return "";
        }

        var escaped = value.Replace("\"", "\"\"");
        return $"\"{escaped}\"";
    }

    private void SetStatusFilter(string status)
    {
        _statusFilter = status;
    }

    private async Task ClearFilters()
    {
        _filter = null;
        _statusFilter = StatusAll;
        await LoadUsers();
    }

    private async Task<Dictionary<Guid, IReadOnlyList<IdentityRoleDto>>> LoadUserRolesAsync(
        IReadOnlyList<IdentityUserDto> users)
    {
        if (users.Count == 0)
        {
            return new Dictionary<Guid, IReadOnlyList<IdentityRoleDto>>();
        }

        var roleTasks = users.Select(async user =>
        {
            var roles = await UserAppService.GetRolesAsync(user.Id);
            return (user.Id, roles.Items);
        });

        var roleResults = await Task.WhenAll(roleTasks);
        return roleResults.ToDictionary(result => result.Id, result => (IReadOnlyList<IdentityRoleDto>)result.Items);
    }

}




