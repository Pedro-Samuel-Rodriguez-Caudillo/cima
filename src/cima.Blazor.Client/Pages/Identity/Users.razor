@page "/admin/identity/users"
@using System.Text
@using cima.Identity
@attribute [Authorize(IdentityPermissions.Users.Default)]
@inherits cimaComponentBase

<PageTitle>@L["Identity:Users:Title"]</PageTitle>

<div class="min-h-screen bg-neutral-50 pt-20">
    @* Contenedor de p�gina: controla el ancho m�ximo y elimina el �vac�o� lateral *@
    <div class="cima-container mx-auto w-full !max-w-screen-2xl px-4 sm:px-6 lg:px-8 py-6 md:py-8">

        @* Encabezado: t�tulo + acciones (wrap en m�vil) *@
        <MudPaper Class="p-4 mb-4 w-full" Elevation="1">
            <MudStack Row="true"
                      AlignItems="AlignItems.Center"
                      Justify="Justify.SpaceBetween"
                      Spacing="2"
                      Class="w-full flex-wrap">
                <MudStack Class="min-w-[220px]">
                    <MudText Typo="Typo.h5">@L["Identity:Users:Title"]</MudText>
                    <MudText Typo="Typo.body2" Class="mud-text-secondary">
                        @L["Identity:Users:Subtitle"]
                    </MudText>
                </MudStack>

                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="flex-wrap justify-end">
                    <MudTextField T="string"
                                  Value="@_filter"
                                  ValueChanged="OnFilterChanged"
                                  Placeholder="@L["Identity:Users:SearchPlaceholder"]"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  Immediate="true"
                                  DebounceInterval="300"
                                  Class="min-w-56" />

                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Secondary"
                               StartIcon="@Icons.Material.Filled.Clear"
                               OnClick="ClearFilters"
                               Disabled="_loading">
                        @L["Common:Clear"]
                    </MudButton>

                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Info"
                               StartIcon="@Icons.Material.Filled.FileDownload"
                               OnClick="ExportUsersAsync"
                               Disabled="_loading">
                        @L["Common:Export"]
                    </MudButton>

                    <MudButton Variant="Variant.Filled"
                               Color="Color.Secondary"
                               StartIcon="@Icons.Material.Filled.PersonAdd"
                               OnClick="OpenCreateDialog"
                               Disabled="_loading">
                        @L["Identity:Users:Create"]
                    </MudButton>

                    <MudButton Color="Color.Primary"
                               Variant="Variant.Filled"
                               StartIcon="@Icons.Material.Filled.Refresh"
                               OnClick="LoadUsers"
                               Disabled="_loading">
                        @L["Common:Refresh"]
                    </MudButton>
                </MudStack>
            </MudStack>

            @* Filtros secundarios (wrap en m�vil) *@
            <MudStack Row="true"
                      AlignItems="AlignItems.Center"
                      Justify="Justify.Center"
                      Spacing="1"
                      Class="mt-3 w-full flex-wrap">
                <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Common:Filter"]:</MudText>

                <MudButton Variant="@(_statusFilter == StatusAll ? Variant.Filled : Variant.Outlined)"
                           Color="Color.Primary"
                           Size="Size.Small"
                           OnClick="@(() => SetStatusFilter(StatusAll))">
                    @L["Common:All"]
                </MudButton>

                <MudButton Variant="@(_statusFilter == StatusActive ? Variant.Filled : Variant.Outlined)"
                           Color="Color.Success"
                           Size="Size.Small"
                           OnClick="@(() => SetStatusFilter(StatusActive))">
                    @L["Common:Active"]
                </MudButton>

                <MudButton Variant="@(_statusFilter == StatusInactive ? Variant.Filled : Variant.Outlined)"
                           Color="Color.Error"
                           Size="Size.Small"
                           OnClick="@(() => SetStatusFilter(StatusInactive))">
                    @L["Common:Inactive"]
                </MudButton>
            </MudStack>
        </MudPaper>

        @* Resumen: 3 tarjetas (stack en m�vil, 3 columnas en md+) *@
        <MudGrid Spacing="4" Class="mb-4">
            <MudItem xs="12" md="4">
                <MudPaper Class="p-4 w-full" Elevation="1">
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Common:Total"]</MudText>
                    <MudText Typo="Typo.h6">@_users.Count</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudPaper Class="p-4 w-full" Elevation="1">
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Common:Active"]</MudText>
                    <MudText Typo="Typo.h6">@ActiveUsersCount</MudText>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudPaper Class="p-4 w-full" Elevation="1">
                    <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Common:Inactive"]</MudText>
                    <MudText Typo="Typo.h6">@InactiveUsersCount</MudText>
                </MudPaper>
            </MudItem>
        </MudGrid>

        @* Hint *@
        <MudAlert Severity="Severity.Info" Class="mb-4 w-full">
            @L["Identity:Users:ArchitectsHint"]
        </MudAlert>

        @* Contenido principal: tabla (m�s ancha) + panel derecho *@
        <MudGrid Spacing="4" Class="items-start">
            <MudItem xs="12" md="7" lg="8">
                <MudPaper Class="p-0 w-full" Elevation="1" Style="min-width:0;">
                    <MudTable T="IdentityUserDto" Items="FilteredUsers"
                              Dense="true"
                              Hover="true"
                              Striped="true"
                              SelectOnRowClick="true"
                              SelectedItemChanged="OnSelectedUserChanged"
                              Loading="_loading"
                              Class="w-full">
                        <ToolBarContent>
                            <MudText Typo="Typo.subtitle2">
                                @L["Identity:Users:Count", FilteredUsers.Count]
                            </MudText>
                        </ToolBarContent>

                        <LoadingContent>
                            <div class="p-6 text-center text-sm text-neutral-500">
                                @L["Identity:Users:Loading"]
                            </div>
                        </LoadingContent>

                        <HeaderContent>
                            <MudTh>@L["Identity:Users:Table:UserName"]</MudTh>
                            <MudTh>@L["Identity:Users:Table:Email"]</MudTh>
                            <MudTh>@L["Identity:Users:Table:Phone"]</MudTh>
                            <MudTh>@L["Identity:Users:Table:Active"]</MudTh>
                            <MudTh>@L["Identity:Users:Table:Created"]</MudTh>
                            <MudTh>@L["Identity:Users:Table:Roles"]</MudTh>
                            <MudTh></MudTh>
                        </HeaderContent>

                        <RowTemplate>
                            <MudTd DataLabel="@L["Identity:Users:Table:UserName"]">
                                <MudText Typo="Typo.subtitle2">@context.UserName</MudText>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@context.Id</MudText>
                            </MudTd>

                            <MudTd DataLabel="@L["Identity:Users:Table:Email"]">
                                @if (!string.IsNullOrWhiteSpace(context.Email))
                                {
                                    <MudText>@context.Email</MudText>
                                }
                                else
                                {
                                    <MudText Class="mud-text-secondary">@L["Identity:Users:Table:NoEmail"]</MudText>
                                }
                            </MudTd>

                            <MudTd DataLabel="@L["Identity:Users:Table:Phone"]">
                                @if (!string.IsNullOrWhiteSpace(context.PhoneNumber))
                                {
                                    <MudText>@context.PhoneNumber</MudText>
                                }
                                else
                                {
                                    <MudText Class="mud-text-secondary">-</MudText>
                                }
                            </MudTd>

                            <MudTd DataLabel="@L["Identity:Users:Table:Active"]">
                                <MudChip T="string" Color="@(context.IsActive? Color.Success: Color.Error)" Size="Size.Small">
                                    @(context.IsActive? L["Common:Yes"] : L["Common:No"])
                                </MudChip>
                            </MudTd>

                            <MudTd DataLabel="@L["Identity:Users:Table:Created"]">
                                @context.CreationTime.ToLocalTime().ToString("g")
                            </MudTd>

                            <MudTd DataLabel="@L["Identity:Users:Table:Roles"]">
                                @if (_userRolesById.TryGetValue(context.Id, out var roles) && roles.Any())
                                {
                                    <MudChipSet T="string" MultiSelection="true" ReadOnly="true" Class="flex flex-wrap gap-1">
                                        @foreach (var role in roles)
                                        {
                                            <MudChip T="string" Color="Color.Primary" Variant="Variant.Outlined" Size="Size.Small">
                                                @role.Name
                                            </MudChip>
                                        }
                                    </MudChipSet>
                                }
                                else
                                {
                                    <MudText Class="mud-text-secondary">@L["Identity:Users:Table:NoRoles"]</MudText>
                                }
                            </MudTd>

                            <MudTd DataLabel="@L["Common:Actions"]">
                                <MudMenu Icon="@Icons.Material.Filled.MoreVert" Dense="true" Color="Color.Default">
                                    <MudMenuItem Icon="@Icons.Material.Filled.ContentCopy" OnClick="@(() => CopyUserIdAsync(context))">
                                        @L["Common:CopyId"]
                                    </MudMenuItem>
                                    <MudMenuItem Icon="@Icons.Material.Filled.Key" OnClick="@(() => OpenResetDialog(context))">
                                        @L["Identity:Users:ResetPassword"]
                                    </MudMenuItem>
                                </MudMenu>
                            </MudTd>
                        </RowTemplate>

                        <NoRecordsContent>
                            <MudText class="p-4">@L["Identity:Users:Empty"]</MudText>
                        </NoRecordsContent>
                    </MudTable>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="5" lg="4">
                @if (_selectedUser is not null)
                {
                    var selectedUser = _selectedUser;

                    <MudPaper Class="p-4 w-full" Elevation="1" Style="min-width:0;">
                        @if (_loadingUserDetail)
                        {
                            <MudStack Spacing="1" AlignItems="AlignItems.Center" Class="py-6">
                                <MudProgressCircular Indeterminate="true" />
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">
                                    @L["Common:Loading"]
                                </MudText>
                            </MudStack>
                        }
                        else
                        {
                            <MudStack Spacing="2">
                            <MudText Typo="Typo.h6">@selectedUser.UserName</MudText>
                            <MudText Typo="Typo.caption" Class="mud-text-secondary">@L["Common:Id"] @selectedUser.Id</MudText>

                            <MudTextField @bind-Value="_userForm.UserName" Label="@L["Identity:Users:Form:UserName"]" Required="true" />
                            <MudTextField @bind-Value="_userForm.Name" Label="@L["Identity:Users:Form:Name"]" />
                            <MudTextField @bind-Value="_userForm.Surname" Label="@L["Identity:Users:Form:Surname"]" />
                            <MudTextField @bind-Value="_userForm.Email" Label="@L["Identity:Users:Form:Email"]" Required="true" />
                            <MudTextField @bind-Value="_userForm.PhoneNumber" Label="@L["Identity:Users:Form:Phone"]" />

                            <MudSwitch T="bool" @bind-Checked="_userForm.IsActive" Color="Color.Success" Label="@L["Identity:Users:Form:Active"]" />

                            <MudSelect T="string"
                                       Label="@L["Identity:Users:Form:AssignedRoles"]"
                                       MultiSelection="true"
                                       SelectedValues="@_selectedRoleNames"
                                       SelectedValuesChanged="OnRolesSelectionChanged">
                                @foreach (var role in _allRoles)
                                {
                                    <MudSelectItem T="string" Value="@role.Name">@role.Name</MudSelectItem>
                                }
                            </MudSelect>

                            <MudStack Row="true" Spacing="1" Justify="Justify.FlexEnd" Class="flex-wrap">
                                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="ResetSelection">
                                    @L["Common:Cancel"]
                                </MudButton>

                                <MudButton Color="Color.Primary"
                                           Variant="Variant.Filled"
                                           Disabled="_savingUser"
                                           OnClick="SaveUserAsync">
                                    @if (_savingUser)
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                    }
                                    @L["Common:Save"]
                                </MudButton>
                            </MudStack>
                        </MudStack>
                        }
                    </MudPaper>
                }
                else
                {
                    <MudPaper Class="p-6 text-center mud-text-secondary w-full" Elevation="1" Style="min-width:0;">
                        @L["Identity:Users:EmptySelection"]
                    </MudPaper>
                }
            </MudItem>
        </MudGrid>
    </div>
</div>


@code {
    [Inject] public IIdentityUserAppService UserAppService { get; set; } = default!;
    [Inject] public IIdentityRoleAppService RoleAppService { get; set; } = default!;
    [Inject] public IAdminIdentityAppService AdminIdentityAppService { get; set; } = default!;
    [Inject] public IJSRuntime JS { get; set; } = default!;
    [Inject] public ISnackbar Snackbar { get; set; } = default!;

    private IReadOnlyList<IdentityUserDto> _users = Array.Empty<IdentityUserDto>();
    private IReadOnlyList<IdentityRoleDto> _allRoles = Array.Empty<IdentityRoleDto>();
    private Dictionary<Guid, IReadOnlyList<IdentityRoleDto>> _userRolesById = new();
    private IdentityUserDto? _selectedUser;
    private bool _loadingUserDetail;
    private int _userSelectionVersion;
    private readonly UserFormModel _userForm = new();
    private HashSet<string> _selectedRoleNames = new(StringComparer.OrdinalIgnoreCase);
    private string? _filter;
    private bool _loading;
    private bool _savingUser;
    private string _statusFilter = StatusAll;
    private bool _resettingPassword;
    private bool ShowCreateDialog { get; set; }
    private bool ShowResetDialog { get; set; }
    private string ResetUserName { get; set; } = "";
    private Guid ResetUserId { get; set; }
    private string? NewTempPassword { get; set; }
    private string? CreatedPassword { get; set; }
    private bool UseCustomPassword { get; set; }
    private bool UseCustomResetPassword { get; set; }
    private string? CustomResetPassword { get; set; }
    private readonly CreateUserModel _createUser = new();
    private HashSet<string> _createRoleNames = new(StringComparer.OrdinalIgnoreCase);

    private const string StatusAll = "all";
    private const string StatusActive = "active";
    private const string StatusInactive = "inactive";

    private IReadOnlyList<IdentityUserDto> FilteredUsers =>
        _statusFilter switch
        {
            StatusActive => _users.Where(user => user.IsActive).ToList(),
            StatusInactive => _users.Where(user => !user.IsActive).ToList(),
            _ => _users
        };

    private int ActiveUsersCount => _users.Count(user => user.IsActive);
    private int InactiveUsersCount => _users.Count - ActiveUsersCount;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadRolesAsync();
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        try
        {
            _loading = true;
            var result = await UserAppService.GetListAsync(new GetIdentityUsersInput
            {
                MaxResultCount = 64,
                Sorting = "CreationTime DESC",
                Filter = _filter
            });

            var users = result.Items;
            _userRolesById = await LoadUserRolesAsync(users);
            _users = users;
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(L["Identity:Users:Error:Load"], GetUserFriendlyErrorMessage(ex)), Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadRolesAsync()
    {
        var result = await RoleAppService.GetListAsync(new GetIdentityRolesInput
        {
            MaxResultCount = 128,
            Sorting = "Name"
        });

        _allRoles = result.Items;
    }

    private async Task OnFilterChanged(string value)
    {
        _filter = value;
        await LoadUsers();
    }

    private void OpenCreateDialog()
    {
        _createUser.Reset();
        _createRoleNames = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        UseCustomPassword = false;
        CreatedPassword = null;
        ShowCreateDialog = true;
    }

    private Task OnCreateRolesSelectionChanged(IEnumerable<string> values)
    {
        _createRoleNames = values.ToHashSet(StringComparer.OrdinalIgnoreCase);
        return Task.CompletedTask;
    }

    private async Task CreateUserAsync()
    {
        if (string.IsNullOrWhiteSpace(_createUser.UserName) || string.IsNullOrWhiteSpace(_createUser.Email))
        {
            Snackbar.Add(L["Identity:Users:Validation:UserEmailRequired"], Severity.Warning);
            return;
        }

        var password = _createUser.Password;
        if (!UseCustomPassword)
        {
            password = GenerateTemporaryPassword();
        }

        if (string.IsNullOrWhiteSpace(password))
        {
            Snackbar.Add(L["Identity:Users:Validation:TempPasswordRequired"], Severity.Warning);
            return;
        }

        try
        {
            _savingUser = true;
            CreatedPassword = null;

            var createDto = new IdentityUserCreateDto
            {
                UserName = _createUser.UserName,
                Email = _createUser.Email,
                Name = _createUser.Name,
                Surname = _createUser.Surname,
                PhoneNumber = _createUser.PhoneNumber,
                IsActive = _createUser.IsActive,
                Password = password
            };

            var created = await UserAppService.CreateAsync(createDto);
            if (_createRoleNames.Any())
            {
                await UserAppService.UpdateRolesAsync(created.Id, new IdentityUserUpdateRolesDto
                {
                    RoleNames = _createRoleNames.ToArray()
                });
            }

            CreatedPassword = password;
            Snackbar.Add(L["Identity:Users:Success:Created"], Severity.Success);
            await LoadUsers();
            await BeginUserSelectionAsync(created);
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(L["Identity:Users:Error:Create"], GetUserFriendlyErrorMessage(ex)), Severity.Error);
        }
        finally
        {
            _savingUser = false;
        }
    }

    private async Task CopyUserIdAsync(IdentityUserDto user)
    {
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", user.Id.ToString());
        Snackbar.Add(L["Common:Copied"], Severity.Success);
    }

    private async Task CopyCreatedPasswordAsync()
    {
        if (string.IsNullOrWhiteSpace(CreatedPassword))
        {
            return;
        }

        await JS.InvokeVoidAsync("navigator.clipboard.writeText", CreatedPassword);
            Snackbar.Add(L["Common:PasswordCopied"], Severity.Success);
    }

    private void OpenResetDialog(IdentityUserDto user)
    {
        ResetUserId = user.Id;
        ResetUserName = user.UserName;
        NewTempPassword = null;
        CustomResetPassword = null;
        UseCustomResetPassword = false;
        ShowResetDialog = true;
    }

    private async Task ResetPasswordAsync()
    {
        if (ResetUserId == Guid.Empty)
        {
            return;
        }

        if (UseCustomResetPassword && string.IsNullOrWhiteSpace(CustomResetPassword))
        {
            Snackbar.Add(L["Identity:Users:Validation:TempPasswordRequired"], Severity.Warning);
            return;
        }

        try
        {
            _resettingPassword = true;
            var result = await AdminIdentityAppService.ResetPasswordAsync(ResetUserId, new ResetIdentityUserPasswordDto
            {
                NewTemporaryPassword = UseCustomResetPassword ? CustomResetPassword : null
            });
            NewTempPassword = result;
            Snackbar.Add(L["Identity:Users:Success:PasswordReset"], Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(L["Identity:Users:Error:ResetPassword"], GetUserFriendlyErrorMessage(ex)), Severity.Error);
        }
        finally
        {
            _resettingPassword = false;
        }
    }

    private async Task CopyResetPasswordAsync()
    {
        if (string.IsNullOrWhiteSpace(NewTempPassword))
        {
            return;
        }

        await JS.InvokeVoidAsync("navigator.clipboard.writeText", NewTempPassword);
        Snackbar.Add(L["Common:PasswordCopied"], Severity.Success);
    }

    private async Task ExportUsersAsync()
    {
        try
        {
            var sb = new StringBuilder();
            sb.AppendLine(L["Identity:Users:Export:Header"]);

            foreach (var user in FilteredUsers)
            {
                var roles = _userRolesById.TryGetValue(user.Id, out var userRoles)
                    ? string.Join("|", userRoles.Select(role => role.Name))
                    : string.Empty;

                sb.AppendLine(string.Join(",",
                    EscapeCsv(user.Id.ToString()),
                    EscapeCsv(user.UserName),
                    EscapeCsv(user.Email),
                    EscapeCsv(user.PhoneNumber),
                    EscapeCsv(user.IsActive ? "Si" : "No"),
                    EscapeCsv(user.CreationTime.ToLocalTime().ToString("g")),
                    EscapeCsv(roles)));
            }

            var csv = sb.ToString();
            var base64 = Convert.ToBase64String(Encoding.UTF8.GetBytes(csv));
            var fileName = $"usuarios-{DateTime.Now:yyyyMMdd-HHmm}.csv";
            await JS.InvokeVoidAsync("downloadFileFromBase64", fileName, base64, "text/csv");
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(L["Identity:Users:Error:Export"], GetUserFriendlyErrorMessage(ex)), Severity.Error);
        }
    }

    private static string EscapeCsv(string? value)
    {
        if (string.IsNullOrEmpty(value))
        {
            return "";
        }

        var escaped = value.Replace("\"", "\"\"");
        return $"\"{escaped}\"";
    }

    private static string GenerateTemporaryPassword()
    {
        var random = new Random();
        var digits = random.Next(1000, 9999);
        return $"Cima{digits}!";
    }

    private void SetStatusFilter(string status)
    {
        _statusFilter = status;
    }

    private async Task ClearFilters()
    {
        _filter = null;
        _statusFilter = StatusAll;
        await LoadUsers();
    }

    private Task OnRolesSelectionChanged(IEnumerable<string> values)
    {
        _selectedRoleNames = values.ToHashSet(StringComparer.OrdinalIgnoreCase);
        return Task.CompletedTask;
    }

    private async Task OnSelectedUserChanged(IdentityUserDto? user)
    {
        if (user is null)
        {
            return;
        }

        await BeginUserSelectionAsync(user);
    }

    private async Task BeginUserSelectionAsync(IdentityUserDto user)
    {
        var requestId = ++_userSelectionVersion;
        _selectedUser = user;
        _loadingUserDetail = true;
        _selectedRoleNames = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        _userForm.Reset();
        await InvokeAsync(StateHasChanged);
        await SelectUserAsync(user.Id, requestId);
    }

    private async Task SelectUserAsync(Guid userId, int requestId)
    {
        try
        {
            var detailTask = UserAppService.GetAsync(userId);
            var rolesTask = UserAppService.GetRolesAsync(userId);

            await Task.WhenAll(detailTask, rolesTask);

            if (requestId != _userSelectionVersion)
            {
                return;
            }

            var detail = detailTask.Result;
            ApplyUserDetail(detail);

            _selectedRoleNames = rolesTask.Result.Items
                .Select(r => r.Name)
                .ToHashSet(StringComparer.OrdinalIgnoreCase);
        }
        catch (Exception ex)
        {
            if (requestId != _userSelectionVersion)
            {
                return;
            }

            Snackbar.Add($"Error al obtener detalle del usuario: {GetUserFriendlyErrorMessage(ex)}", Severity.Error);
        }
        finally
        {
            if (requestId == _userSelectionVersion)
            {
                _loadingUserDetail = false;
            }
        }
    }

    private void ApplyUserDetail(IdentityUserDto detail)
    {
        _selectedUser = detail;
        _userForm.UserName = detail.UserName;
        _userForm.Name = detail.Name;
        _userForm.Surname = detail.Surname;
        _userForm.Email = detail.Email;
        _userForm.PhoneNumber = detail.PhoneNumber;
        _userForm.IsActive = detail.IsActive;

        if (_users.Count == 0)
        {
            return;
        }

        var users = _users.ToList();
        var index = users.FindIndex(item => item.Id == detail.Id);
        if (index >= 0)
        {
            users[index] = detail;
            _users = users;
        }
    }

    private async Task SaveUserAsync()
    {
        if (_selectedUser == null)
        {
            return;
        }

        try
        {
            _savingUser = true;
            var updateDto = new IdentityUserUpdateDto
            {
                UserName = _userForm.UserName,
                Name = _userForm.Name,
                Surname = _userForm.Surname,
                Email = _userForm.Email,
                PhoneNumber = _userForm.PhoneNumber,
                IsActive = _userForm.IsActive
            };

            await UserAppService.UpdateAsync(_selectedUser.Id, updateDto);
            await UserAppService.UpdateRolesAsync(_selectedUser.Id, new IdentityUserUpdateRolesDto
            {
                RoleNames = _selectedRoleNames.ToArray()
            });

            Snackbar.Add(L["Identity:Users:Success:Updated"], Severity.Success);
            await LoadUsers();
            var refreshed = _users.FirstOrDefault(user => user.Id == _selectedUser.Id) ?? _selectedUser;
            await BeginUserSelectionAsync(refreshed);
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(L["Identity:Users:Error:Save"], GetUserFriendlyErrorMessage(ex)), Severity.Error);
        }
        finally
        {
            _savingUser = false;
        }
    }

    private void ResetSelection()
    {
        _userSelectionVersion++;
        _selectedUser = null;
        _loadingUserDetail = false;
        _selectedRoleNames = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        _userForm.Reset();
    }


    private async Task<Dictionary<Guid, IReadOnlyList<IdentityRoleDto>>> LoadUserRolesAsync(
        IReadOnlyList<IdentityUserDto> users)
    {
        if (users.Count == 0)
        {
            return new Dictionary<Guid, IReadOnlyList<IdentityRoleDto>>();
        }

        var roleTasks = users.Select(async user =>
        {
            var roles = await UserAppService.GetRolesAsync(user.Id);
            return (user.Id, roles.Items);
        });

        var roleResults = await Task.WhenAll(roleTasks);
        return roleResults.ToDictionary(result => result.Id, result => (IReadOnlyList<IdentityRoleDto>)result.Items);
    }

    private sealed class UserFormModel
    {
        public string? UserName { get; set; }
        public string? Name { get; set; }
        public string? Surname { get; set; }
        public string? Email { get; set; }
        public string? PhoneNumber { get; set; }
        public bool IsActive { get; set; }

        public void Reset()
        {
            UserName = Name = Surname = Email = PhoneNumber = null;
            IsActive = false;
        }
    }

    private sealed class CreateUserModel
    {
        public string? UserName { get; set; }
        public string? Name { get; set; }
        public string? Surname { get; set; }
        public string? Email { get; set; }
        public string? PhoneNumber { get; set; }
        public bool IsActive { get; set; } = true;
        public string? Password { get; set; }

        public void Reset()
        {
            UserName = Name = Surname = Email = PhoneNumber = Password = null;
            IsActive = true;
        }
    }
}




