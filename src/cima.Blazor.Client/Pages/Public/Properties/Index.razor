@page "/properties"
@page "/propiedades"
@using cima.Domain.Shared.Dtos
@using cima.Listings
@inject IListingAppService ListingService
@inject NavigationManager NavManager
@inherits cimaComponentBase

<PageTitle>@L["Properties:Title"] - @L["CompanyName"]</PageTitle>

<div class="min-h-screen bg-white">
    @* Header Section *@
    <section class="cima-section bg-navy-600 text-white">
        <div class="cima-container">
            <h1 class="text-3xl md:text-4xl font-display font-bold mb-4">
                @L["Properties:Title"]
            </h1>
            <p class="text-lg text-navy-100 max-w-2xl">
                @L["Properties:Subtitle"]
            </p>
        </div>
    </section>

    @* Filters Section *@
    <section class="cima-section-alt py-6">
        <div class="cima-container">
            <PropertySearchFilters 
                OnSearch="HandleSearch"
                OnClear="HandleClearFilters" />
        </div>
    </section>

    @* Results Section *@
    <section class="cima-section">
        <div class="cima-container">
            @if (IsLoading)
            {
                <div class="mb-6">
                    <div class="cima-skeleton-text w-48 mb-4"></div>
                </div>
                
                <div class="cima-grid">
                    @for (int i = 0; i < 6; i++)
                    {
                        <div class="cima-card">
                            <div class="cima-skeleton-image"></div>
                            <div class="p-5 space-y-3">
                                <div class="cima-skeleton-text w-3/4"></div>
                                <div class="cima-skeleton-text w-1/2"></div>
                                <div class="cima-skeleton-text w-full"></div>
                            </div>
                        </div>
                    }
                </div>
            }
            else if (Listings?.Any() == true)
            {
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <p class="text-neutral-600">
                        @L["Search:ResultsFound", TotalCount]
                    </p>
                    
                    <select 
                        class="cima-input w-full md:w-auto"
                        value="@SortOption"
                        @onchange="@(e => { SortOption = e.Value?.ToString() ?? "CreatedAt DESC"; HandleSortChange(); })">
                        <option value="CreatedAt DESC">@L["Properties:Newest"]</option>
                        <option value="Price ASC">@L["Properties:PriceLowToHigh"]</option>
                        <option value="Price DESC">@L["Properties:PriceHighToLow"]</option>
                        <option value="Area DESC">@L["Properties:AreaLargeToSmall"]</option>
                    </select>
                </div>

                <div class="cima-grid">
                    @foreach (var listing in Listings)
                    {
                        <ListingCard 
                            Listing="listing" 
                            OnCardFlipped="HandleCardFlipped"
                            @ref="@_cardRefs[listing.Id]" />
                    }
                </div>

                @* Paginación *@
                @if (TotalPages > 1)
                {
                    <div class="mt-12 flex justify-center items-center gap-2">
                        <button 
                            @onclick="PreviousPage"
                            disabled="@(CurrentPage == 1)"
                            class="cima-btn cima-btn-secondary disabled:opacity-50 disabled:cursor-not-allowed">
                            @L["Common:Previous"]
                        </button>

                        <div class="flex gap-1">
                            @{
                                var maxVisiblePages = Math.Min(TotalPages, 5);
                                var startPage = Math.Max(1, CurrentPage - 2);
                                var endPage = Math.Min(TotalPages, startPage + maxVisiblePages - 1);
                                
                                for (int i = startPage; i <= endPage; i++)
                                {
                                    var pageNum = i;
                                    <button 
                                        @onclick="@(() => GoToPage(pageNum))"
                                        class="@GetPageButtonClass(pageNum)">
                                        @pageNum
                                    </button>
                                }
                            }
                        </div>

                        <button 
                            @onclick="NextPage"
                            disabled="@(CurrentPage == TotalPages)"
                            class="cima-btn cima-btn-secondary disabled:opacity-50 disabled:cursor-not-allowed">
                            @L["Common:Next"]
                        </button>
                    </div>
                }
            }
            else
            {
                <div class="text-center py-16">
                    <svg class="w-20 h-20 mx-auto text-neutral-400 mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <h3 class="text-xl font-semibold text-neutral-900 mb-2">
                        @L["Search:NoResults"]
                    </h3>
                    <p class="text-neutral-600 mb-6">
                        Intenta ajustar tus filtros de búsqueda
                    </p>
                    <button 
                        @onclick="HandleClearFilters"
                        class="cima-btn cima-btn-outline">
                        @L["Search:ClearFilters"]
                    </button>
                </div>
            }
        </div>
    </section>
</div>

@code {
    private bool IsLoading { get; set; } = true;
    private List<ListingDto>? Listings { get; set; }
    private int TotalCount { get; set; }
    private int CurrentPage { get; set; } = 1;
    private const int PageSize = 12;
    private int TotalPages => (int)Math.Ceiling((double)TotalCount / PageSize);
    
    private Dictionary<Guid, ListingCard> _cardRefs = new();
    private Guid? _currentFlippedCardId;
    
    private PropertySearchDto SearchFilters { get; set; } = new();
    private string SortOption { get; set; } = "CreatedAt DESC";

    protected override async Task OnInitializedAsync()
    {
        // Leer parámetros de query string
        var uri = NavManager.ToAbsoluteUri(NavManager.Uri);
        var queryParams = System.Web.HttpUtility.ParseQueryString(uri.Query);
        
        if (queryParams["search"] != null)
        {
            SearchFilters.Location = queryParams["search"];
        }

        await LoadListings();
    }

    private async Task LoadListings()
    {
        try
        {
            IsLoading = true;

            var input = new GetListingsInput
            {
                SkipCount = (CurrentPage - 1) * PageSize,
                MaxResultCount = PageSize,
                Sorting = SortOption,
                MinPrice = SearchFilters.MinPrice,
                MaxPrice = SearchFilters.MaxPrice,
                MinBedrooms = SearchFilters.MinBedrooms,
                MinBathrooms = SearchFilters.MinBathrooms,
                PropertyType = SearchFilters.Type.HasValue ? (int)SearchFilters.Type.Value : null,
                PropertyCategory = SearchFilters.Category.HasValue ? (int)SearchFilters.Category.Value : null,
                TransactionType = SearchFilters.TransactionType.HasValue ? (int)SearchFilters.TransactionType.Value : null
            };

            var result = await ListingService.GetPublishedAsync(input);
            
            Listings = result.Items.ToList();
            TotalCount = (int)result.TotalCount;
        }
        catch (Exception ex)
        {
            await HandleErrorAsync(ex);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task HandleSearch(PropertySearchDto filters)
    {
        SearchFilters = filters;
        CurrentPage = 1;
        await LoadListings();
    }

    private async Task HandleClearFilters()
    {
        SearchFilters = new();
        CurrentPage = 1;
        await LoadListings();
    }

    private async Task HandleSortChange()
    {
        await LoadListings();
    }

    private async Task GoToPage(int page)
    {
        CurrentPage = page;
        await LoadListings();
    }

    private async Task PreviousPage()
    {
        if (CurrentPage > 1)
        {
            await GoToPage(CurrentPage - 1);
        }
    }

    private async Task NextPage()
    {
        if (CurrentPage < TotalPages)
        {
            await GoToPage(CurrentPage + 1);
        }
    }

    private string GetPageButtonClass(int page)
    {
        var baseClass = "px-4 py-2 text-sm font-medium rounded transition-colors";
        
        if (page == CurrentPage)
        {
            return $"{baseClass} bg-navy-500 text-white";
        }
        
        return $"{baseClass} bg-neutral-100 text-neutral-700 hover:bg-neutral-200";
    }

    private void HandleCardFlipped(Guid listingId)
    {
        // Cerrar card previamente abierta
        if (_currentFlippedCardId.HasValue && 
            _currentFlippedCardId != listingId && 
            _cardRefs.TryGetValue(_currentFlippedCardId.Value, out var prevCard))
        {
            prevCard?.Close();
        }

        _currentFlippedCardId = listingId;
    }
}
