@inherits LayoutComponentBase
@implements IDisposable
@using cima.Blazor.Client.Components.Common
@using cima.Blazor.Client.Components.Auth
@using MudBlazor
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ICimaThemeService ThemeService

<MudThemeProvider Theme="@ThemeService.CurrentTheme" IsDarkMode="@ThemeService.IsDarkMode" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<MustChangePasswordGuard>
    <a href="#main-content"
       class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 focus:z-50 focus:px-4 focus:py-2 focus:bg-white focus:text-navy-900 focus:shadow-lg rounded">
        Saltar al contenido principal
    </a>
    <div class="flex flex-col min-h-screen bg-gray-50">
        <header class="sticky top-0 z-40 w-full">
            <Navbar />
        </header>

        <main id="main-content" class="flex-grow" tabindex="-1">
            <PageTransition>
                @Body
            </PageTransition>
        </main>

        <Footer />
    </div>
</MustChangePasswordGuard>

<EnvironmentToast />

@code {
    // La autorización se maneja por el atributo [Authorize] 
    // en las páginas y por AuthorizeRouteView en Routes.razor

    protected override void OnInitialized()
    {
        ThemeService.ThemeChanged += OnThemeChanged;
    }

    private void OnThemeChanged(MudTheme _)
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        ThemeService.ThemeChanged -= OnThemeChanged;
    }
}
