@using MudBlazor
@using cima.Listings
@using cima.Listings.Inputs
@using System.IO
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.Extensions.Localization
@using cima.Localization
@inject IStringLocalizer<cimaResource> L
@inject ISnackbar Snackbar

<MudPaper Class="p-4" Elevation="0" Outlined="true">
    <MudText Typo="Typo.h6" Class="mb-4">@L["ImageUploader:Title"]</MudText>

    <InputFile id="fileInput" OnChange="OnInputFileChange" multiple accept=".jpg, .jpeg, .png, .webp" hidden />
    
    <label for="fileInput" class="cima-btn cima-btn-primary inline-flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4-4m0 0l-4 4m4-4v12"/>
        </svg>
        @L["ImageUploader:Upload"]
    </label>

    @if (uploadedImages.Any())
    {
        <MudGrid Class="mt-4">
            @foreach (var image in uploadedImages)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudCard>
                        @if (!string.IsNullOrEmpty(image.Url))
                        {
                            <MudCardMedia Image="@image.Url" Height="200" />
                        }
                        <MudCardContent>
                            <MudText Typo="Typo.caption">@(image.AltText ?? L["ImageUploader:AltFallback"])</MudText>
                        </MudCardContent>
                        <MudCardActions>
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                           Color="Color.Error" 
                                           OnClick="@(() => RemoveImage(image))" />
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
    else
    {
        <MudAlert Severity="Severity.Info" Class="mt-4">@L["ImageUploader:NoImages"]</MudAlert>
    }
</MudPaper>

@code {
    private const long MaxFileSize = 5 * 1024 * 1024;

    [Parameter] public List<AddListingImageDto> InitialImages { get; set; } = new();
    [Parameter] public EventCallback<List<AddListingImageDto>> OnImagesChanged { get; set; }

    private List<AddListingImageDto> uploadedImages = new();

    protected override void OnInitialized()
    {
        if (InitialImages != null)
        {
            uploadedImages = new List<AddListingImageDto>(InitialImages);
        }
    }

    private async Task OnInputFileChange(InputFileChangeEventArgs e)
    {
        foreach (var file in e.GetMultipleFiles())
        {
            if (file.Size > MaxFileSize)
            {
                Snackbar.Add(L["GalleryManager:FileTooLarge", file.Name], Severity.Warning);
                continue;
            }

            await using var stream = file.OpenReadStream(maxAllowedSize: MaxFileSize);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            var base64 = Convert.ToBase64String(ms.ToArray());
            var url = $"data:{file.ContentType};base64,{base64}";
            
            uploadedImages.Add(new AddListingImageDto
            {
                ListingId = Guid.Empty,
                Url = url,
                AltText = Path.GetFileNameWithoutExtension(file.Name),
                FileSize = file.Size,
                ContentType = file.ContentType
            });
        }
        
        await OnImagesChanged.InvokeAsync(uploadedImages);
    }

    private async Task RemoveImage(AddListingImageDto image)
    {
        uploadedImages.Remove(image);
        await OnImagesChanged.InvokeAsync(uploadedImages);
    }
}
