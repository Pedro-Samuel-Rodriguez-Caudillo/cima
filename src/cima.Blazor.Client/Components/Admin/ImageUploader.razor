@using MudBlazor
@using cima.Domain.Shared.Dtos
@using Microsoft.AspNetCore.Components.Forms

<MudPaper Class="p-4" Elevation="0" Outlined="true">
    <MudText Typo="Typo.h6" Class="mb-4">Imágenes de la Propiedad</MudText>

    <InputFile id="fileInput" OnChange="OnInputFileChange" multiple accept=".jpg, .jpeg, .png, .webp" hidden />
    
    <MudButton HtmlTag="label"
               Variant="Variant.Filled"
               Color="Color.Primary"
               StartIcon="@Icons.Material.Filled.CloudUpload"
               for="fileInput">
        Subir Imágenes
    </MudButton>

    @if (uploadedImages.Any())
    {
        <MudGrid Class="mt-4">
            @foreach (var image in uploadedImages)
            {
                <MudItem xs="12" sm="6" md="4" lg="3">
                    <MudCard>
                        @if (!string.IsNullOrEmpty(image.Url))
                        {
                            <MudCardMedia Image="@image.Url" Height="200" />
                        }
                        <MudCardContent>
                            <MudText Typo="Typo.caption">@(image.AltText ?? "Sin nombre")</MudText>
                        </MudCardContent>
                        <MudCardActions>
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                           Color="Color.Error" 
                                           OnClick="@(() => RemoveImage(image))" />
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
    else
    {
        <MudAlert Severity="Severity.Info" Class="mt-4">No hay imágenes seleccionadas.</MudAlert>
    }
</MudPaper>

@code {
    [Parameter] public List<ListingImageDto> InitialImages { get; set; } = new();
    [Parameter] public EventCallback<List<ListingImageDto>> OnImagesChanged { get; set; }

    private List<ListingImageDto> uploadedImages = new();

    protected override void OnInitialized()
    {
        if (InitialImages != null)
        {
            uploadedImages = new List<ListingImageDto>(InitialImages);
        }
    }

    private async Task OnInputFileChange(InputFileChangeEventArgs e)
    {
        foreach (var file in e.GetMultipleFiles())
        {
            var buffer = new byte[file.Size];
            await file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024).ReadAsync(buffer);
            var base64 = Convert.ToBase64String(buffer);
            var url = $"data:{file.ContentType};base64,{base64}";
            
            uploadedImages.Add(new ListingImageDto 
            { 
                Url = url,
                AltText = file.Name
            });
        }
        
        await OnImagesChanged.InvokeAsync(uploadedImages);
    }

    private async Task RemoveImage(ListingImageDto image)
    {
        uploadedImages.Remove(image);
        await OnImagesChanged.InvokeAsync(uploadedImages);
    }
}
