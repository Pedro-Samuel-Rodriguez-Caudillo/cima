@using Microsoft.AspNetCore.Components.Authorization
@using Volo.Abp.Users
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ICurrentUser CurrentUser
@implements IDisposable

<header class="fixed top-0 left-0 right-0 z-50 transition-all duration-300 @(_isScrolled ? "bg-navy-950 shadow-lg" : "bg-transparent border-b border-white/10")">
    <div class="cima-container h-20 flex items-center justify-between">
        <!-- Brand -->
        <a href="/" class="text-white font-display font-semibold tracking-[0.35em] uppercase text-lg hover:opacity-80 transition-opacity">
            4cima
        </a>

        <!-- Desktop Menu -->
        <nav class="hidden md:flex items-center gap-8">
            <NavLink href="/" class="@GetLinkClass()" Match="NavLinkMatch.All">Inicio</NavLink>
            <NavLink href="/properties" class="@GetLinkClass()">Propiedades</NavLink>
            <NavLink href="/portfolio" class="@GetLinkClass()">Portafolio</NavLink>
            <NavLink href="/contact" class="@GetLinkClass()">Contacto</NavLink>
        </nav>

        <!-- Actions -->
        <div class="hidden md:flex items-center gap-6">
            <LanguageSelector ButtonClass="text-white/80 hover:text-white text-xs font-medium tracking-widest uppercase transition-colors flex items-center gap-1" />
            
            <AuthorizeView>
                <Authorized>
                    <a href="/account" class="text-white/80 hover:text-white text-xs font-medium tracking-widest uppercase transition-colors flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                        </svg>
                        @context.User.Identity?.Name
                    </a>
                </Authorized>
                <NotAuthorized>
                    <a href="Account/Login" class="text-white/80 hover:text-white text-xs font-medium tracking-widest uppercase transition-colors">
                        Acceso
                    </a>
                </NotAuthorized>
            </AuthorizeView>
        </div>

        <!-- Mobile Menu Button -->
        <button class="md:hidden text-white p-2" @onclick="ToggleMobileMenu">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
        </button>
    </div>
</header>

<!-- Mobile Menu Overlay -->
@if (_mobileMenuOpen)
{
    <div class="fixed inset-0 z-[60] bg-navy-950/95 backdrop-blur-xl flex flex-col items-center justify-center animate-fade-in">
        <button class="absolute top-6 right-6 text-white/60 hover:text-white p-2" @onclick="ToggleMobileMenu">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>

        <nav class="flex flex-col items-center gap-8 text-center">
            <a href="/" class="text-2xl font-display font-medium text-white hover:text-navy-300 transition-colors" @onclick="ToggleMobileMenu">Inicio</a>
            <a href="/properties" class="text-2xl font-display font-medium text-white hover:text-navy-300 transition-colors" @onclick="ToggleMobileMenu">Propiedades</a>
            <a href="/portfolio" class="text-2xl font-display font-medium text-white hover:text-navy-300 transition-colors" @onclick="ToggleMobileMenu">Portafolio</a>
            <a href="/contact" class="text-2xl font-display font-medium text-white hover:text-navy-300 transition-colors" @onclick="ToggleMobileMenu">Contacto</a>
            
            <AuthorizeView>
                <Authorized>
                    <a href="/account" class="text-xl font-display font-medium text-white/80 hover:text-white transition-colors mt-4" @onclick="ToggleMobileMenu">
                        Mi Cuenta (@context.User.Identity?.Name)
                    </a>
                </Authorized>
                <NotAuthorized>
                    <a href="Account/Login" class="text-xl font-display font-medium text-white/80 hover:text-white transition-colors mt-4" @onclick="ToggleMobileMenu">
                        Acceso
                    </a>
                </NotAuthorized>
            </AuthorizeView>
        </nav>
    </div>
}

@code {
    private bool _isScrolled = false;
    private bool _mobileMenuOpen = false;
    private DotNetObjectReference<Navbar>? _dotNetHelper;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetHelper = DotNetObjectReference.Create(this);
            
            // Retry logic para asegurar que JS esté cargado
            for (int i = 0; i < 5; i++)
            {
                try
                {
                    await JS.InvokeVoidAsync("cima.addScrollListener", _dotNetHelper);
                    break; // Éxito
                }
                catch (JSException)
                {
                    if (i == 4) // Último intento
                    {
                        Console.WriteLine("Warning: navbar-scroll.js no se cargó correctamente");
                    }
                    else
                    {
                        await Task.Delay(200); // Esperar 200ms antes de reintentar
                    }
                }
            }
        }
    }

    [JSInvokable]
    public void OnScroll(bool isScrolled)
    {
        if (_isScrolled != isScrolled)
        {
            _isScrolled = isScrolled;
            StateHasChanged();
        }
    }

    private string GetLinkClass()
    {
        return "text-sm font-medium tracking-wide transition-colors duration-200 " + 
               (_isScrolled ? "text-white/70 hover:text-white" : "text-white/80 hover:text-white");
    }

    private void ToggleMobileMenu()
    {
        _mobileMenuOpen = !_mobileMenuOpen;
    }

    public void Dispose()
    {
        _dotNetHelper?.Dispose();
    }
}
