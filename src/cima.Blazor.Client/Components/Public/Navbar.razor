@using Microsoft.AspNetCore.Components.Authorization
@using Volo.Abp.Users
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ICurrentUser CurrentUser
@implements IAsyncDisposable
@rendermode InteractiveAuto

<header id="main-navbar" class="fixed top-0 left-0 right-0 z-50 transition-all duration-300 @(_isScrolled ? "bg-navy-950 shadow-lg" : "bg-transparent border-b border-white/10")">
    <div class="cima-container h-20 flex items-center justify-between">
        <!-- Brand -->
        <a href="/" class="text-white font-display font-semibold tracking-[0.35em] uppercase text-lg hover:opacity-80 transition-opacity">
            4cima
        </a>

        <!-- Desktop Menu -->
        <nav class="hidden md:flex items-center gap-8">
            <NavLink href="/" class="@GetLinkClass()" Match="NavLinkMatch.All">Inicio</NavLink>
            <NavLink href="/properties" class="@GetLinkClass()">Propiedades</NavLink>
            <NavLink href="/portfolio" class="@GetLinkClass()">Portafolio</NavLink>
            
            <AuthorizeView>
                <Authorized>
                    <NavLink href="/listings" class="@GetLinkClass()">Listings</NavLink>
                    
                    @if (IsAdmin())
                    {
                        <!-- Admin Dropdown -->
                        <div class="relative" @onmouseenter="() => _adminMenuOpen = true" @onmouseleave="() => _adminMenuOpen = false">
                            <button class="@GetLinkClass() flex items-center gap-1">
                                Admin
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                                </svg>
                            </button>
                            
                            @if (_adminMenuOpen)
                            {
                                <div class="absolute top-full left-0 mt-2 w-48 bg-navy-950 border border-white/10 rounded-lg shadow-xl py-2 animate-fade-in">
                                    <a href="/admin/listings" class="block px-4 py-2 text-sm text-white/80 hover:text-white hover:bg-white/5 transition-colors">
                                        Gestionar Listings
                                    </a>
                                    <a href="/admin/architects" class="block px-4 py-2 text-sm text-white/80 hover:text-white hover:bg-white/5 transition-colors">
                                        Gestionar Arquitectos
                                    </a>
                                </div>
                            }
                        </div>
                    }
                </Authorized>
            </AuthorizeView>
        </nav>

        <!-- Actions -->
        <div class="hidden md:flex items-center gap-6">
            <LanguageSelector ButtonClass="text-white/80 hover:text-white text-xs font-medium tracking-widest uppercase transition-colors flex items-center gap-1" />
            
            <AuthorizeView>
                <Authorized>
                    <!-- User Menu Dropdown -->
                    <div class="relative" @onmouseenter="() => _userMenuOpen = true" @onmouseleave="() => _userMenuOpen = false">
                        <button class="@GetLinkClass() flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                            </svg>
                            @context.User.Identity?.Name
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                            </svg>
                        </button>
                        
                        @if (_userMenuOpen)
                        {
                            <div class="absolute top-full right-0 mt-2 w-48 bg-navy-950 border border-white/10 rounded-lg shadow-xl py-2 animate-fade-in">
                                <a href="/account/profile" class="block px-4 py-2 text-sm text-white/80 hover:text-white hover:bg-white/5 transition-colors">
                                    Mi Perfil
                                </a>
                                <a href="/account/settings" class="block px-4 py-2 text-sm text-white/80 hover:text-white hover:bg-white/5 transition-colors">
                                    Configuración
                                </a>
                                <hr class="my-2 border-white/10" />
                                <a href="/Account/Logout" class="block px-4 py-2 text-sm text-red-400 hover:text-red-300 hover:bg-white/5 transition-colors">
                                    Cerrar Sesión
                                </a>
                            </div>
                        }
                    </div>
                </Authorized>
                <NotAuthorized>
                    <a href="/Account/Login" class="@GetLinkClass()">
                        Acceso
                    </a>
                </NotAuthorized>
            </AuthorizeView>
        </div>

        <!-- Mobile Menu Button -->
        <button class="md:hidden text-white p-2" @onclick="ToggleMobileMenu">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
        </button>
    </div>
</header>

<!-- Mobile Menu Overlay -->
@if (_mobileMenuOpen)
{
    <div class="fixed inset-0 z-[60] bg-navy-950/95 backdrop-blur-xl flex flex-col items-center justify-center animate-fade-in">
        <button class="absolute top-6 right-6 text-white/60 hover:text-white p-2" @onclick="ToggleMobileMenu">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>

        <nav class="flex flex-col items-center gap-8 text-center">
            <a href="/" class="text-2xl font-display font-medium text-white hover:text-navy-300 transition-colors" @onclick="ToggleMobileMenu">Inicio</a>
            <a href="/properties" class="text-2xl font-display font-medium text-white hover:text-navy-300 transition-colors" @onclick="ToggleMobileMenu">Propiedades</a>
            <a href="/portfolio" class="text-2xl font-display font-medium text-white hover:text-navy-300 transition-colors" @onclick="ToggleMobileMenu">Portafolio</a>
            
            <AuthorizeView>
                <Authorized>
                    <a href="/listings" class="text-2xl font-display font-medium text-white hover:text-navy-300 transition-colors" @onclick="ToggleMobileMenu">Listings</a>
                    
                    @if (IsAdmin())
                    {
                        <div class="mt-4 pt-4 border-t border-white/10 w-full">
                            <p class="text-sm text-white/60 uppercase tracking-wider mb-3">Admin</p>
                            <a href="/admin/listings" class="block text-xl font-display font-medium text-white/80 hover:text-white transition-colors mb-3" @onclick="ToggleMobileMenu">
                                Gestionar Listings
                            </a>
                            <a href="/admin/architects" class="block text-xl font-display font-medium text-white/80 hover:text-white transition-colors" @onclick="ToggleMobileMenu">
                                Gestionar Arquitectos
                            </a>
                        </div>
                    }
                    
                    <div class="mt-4 pt-4 border-t border-white/10 w-full">
                        <a href="/account/profile" class="block text-xl font-display font-medium text-white/80 hover:text-white transition-colors mb-3" @onclick="ToggleMobileMenu">
                            Mi Perfil
                        </a>
                        <a href="/account/settings" class="block text-xl font-display font-medium text-white/80 hover:text-white transition-colors mb-3" @onclick="ToggleMobileMenu">
                            Configuración
                        </a>
                        <a href="/Account/Logout" class="block text-xl font-display font-medium text-red-400 hover:text-red-300 transition-colors" @onclick="ToggleMobileMenu">
                            Cerrar Sesión
                        </a>
                    </div>
                </Authorized>
                <NotAuthorized>
                    <a href="/Account/Login" class="text-xl font-display font-medium text-white/80 hover:text-white transition-colors mt-4" @onclick="ToggleMobileMenu">
                        Acceso
                    </a>
                </NotAuthorized>
            </AuthorizeView>
        </nav>
    </div>
}

@code {
    private bool _isScrolled = false;
    private bool _mobileMenuOpen = false;
    private bool _adminMenuOpen = false;
    private bool _userMenuOpen = false;
    private DotNetObjectReference<Navbar>? _dotNetHelper;
    private IJSObjectReference? _scrollListener;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                _dotNetHelper = DotNetObjectReference.Create(this);
                
                // Registrar el listener de scroll con retorno del objeto dispose
                _scrollListener = await JS.InvokeAsync<IJSObjectReference>(
                    "cima.addScrollListener", _dotNetHelper);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error inicializando navbar scroll: {ex.Message}");
            }
        }
    }

    [JSInvokable]
    public Task OnScroll(bool isScrolled)
    {
        if (_isScrolled != isScrolled)
        {
            _isScrolled = isScrolled;
            StateHasChanged();
        }
        return Task.CompletedTask;
    }

    private string GetLinkClass()
    {
        return "text-sm font-medium tracking-wide transition-colors duration-200 " + 
               (_isScrolled ? "text-white hover:text-navy-300" : "text-white/90 hover:text-white");
    }

    private void ToggleMobileMenu()
    {
        _mobileMenuOpen = !_mobileMenuOpen;
    }

    private bool IsAdmin()
    {
        return CurrentUser.IsInRole("admin");
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            // Llamar a dispose en JavaScript
            if (_scrollListener is not null)
            {
                await _scrollListener.InvokeVoidAsync("dispose");
                await _scrollListener.DisposeAsync();
            }
        }
        catch (JSDisconnectedException)
        {
            // El circuito ya está desconectado, esto es esperado
        }
        catch (Exception ex)
        {
            // Log pero no propagar el error durante dispose
            Console.WriteLine($"Error durante dispose del navbar: {ex.Message}");
        }
        finally
        {
            // Siempre liberar la referencia de .NET
            _dotNetHelper?.Dispose();
        }
    }
}
