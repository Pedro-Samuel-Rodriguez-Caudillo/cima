@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.Extensions.Localization
@using cima.Localization
@using System.Security.Claims
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject PersistentComponentState PersistentState
@inject IStringLocalizer<cimaResource> L
@implements IAsyncDisposable
@rendermode InteractiveAuto

<header id="main-navbar" class="fixed top-0 left-0 right-0 z-50 transition-all duration-300 @(GetNavbarBackgroundClass())">
    <div class="cima-container h-20 flex items-center justify-between">
        <!-- Brand -->
        <a href="/"
           class="text-white font-display font-semibold tracking-[0.35em] uppercase text-lg hover:opacity-80 transition-opacity"
           aria-label="Volver a inicio">
            <img src="@($"{Navigation.BaseUri}images/logo/4cima.svg")"
                 alt="CIMA"
                 class="h-16 w-auto drop-shadow-lg" />
        </a>

        <!-- Desktop Menu -->
        <nav class="hidden md:flex items-center gap-8">
            <NavLink href="/" class="@GetLinkClass()" Match="NavLinkMatch.All">@L["Menu:Home"]</NavLink>
            <NavLink href="/properties" class="@GetLinkClass()">@L["Menu:Properties"]</NavLink>
            <NavLink href="/portfolio" class="@GetLinkClass()">@L["Menu:Portfolio"]</NavLink>
            
            @if (_isAuthenticated)
            {
                @if (_isAdmin)
                {
                    <!-- Admin Dropdown -->
                    <div class="relative group">
                        <button class="@GetLinkClass() flex items-center gap-1 py-2"
                                @onclick="ToggleAdminMenu"
                                @onclick:stopPropagation="true">
                            @L["Menu:Admin"]
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" 
                                 class="w-4 h-4 transition-transform duration-200 @(_adminMenuOpen ? "rotate-180" : "")">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                            </svg>
                        </button>
                        
                        @if (_adminMenuOpen)
                        {
                            <div class="absolute top-full left-0 w-full h-2"></div>
                            <div class="absolute top-[calc(100%+0.5rem)] left-0 w-56 bg-navy-950 border border-white/10 rounded-lg shadow-xl py-2 animate-fade-in"
                                 @onmouseleave="CloseAdminMenuWithDelay">
                                <a href="/admin" class="block px-4 py-3 text-sm text-white/80 hover:text-white hover:bg-white/5 transition-colors"
                                   @onclick="CloseAdminMenu">
                                    <div class="flex items-center gap-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
                                        </svg>
                                        @L["Menu:Dashboard"]
                                    </div>
                                </a>
                                <hr class="my-1 border-white/10" />
                                <a href="/admin/listings" class="block px-4 py-3 text-sm text-white/80 hover:text-white hover:bg-white/5 transition-colors"
                                   @onclick="CloseAdminMenu">
                                    <div class="flex items-center gap-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                                        </svg>
                                        @L["Menu:Admin:Listings"]
                                    </div>
                                </a>
                                <a href="/admin/architects" class="block px-4 py-3 text-sm text-white/80 hover:text-white hover:bg-white/5 transition-colors"
                                   @onclick="CloseAdminMenu">
                                    <div class="flex items-center gap-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                                        </svg>
                                        @L["Menu:Admin:Architects"]
                                    </div>
                                </a>
                                <hr class="my-1 border-white/10" />
                                <a href="/admin/settings" class="block px-4 py-3 text-sm text-white/80 hover:text-white hover:bg-white/5 transition-colors"
                                   @onclick="CloseAdminMenu">
                                    <div class="flex items-center gap-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                        Configuración
                                    </div>
                                </a>
                            </div>
                        }
                    </div>
                }
            }
        </nav>

        <!-- Actions -->
        <div class="hidden md:flex items-center gap-6">
            @if (_isAuthenticated && !_isAdmin && _isArchitect)
            {
                <a href="/architect/listings" class="text-sm font-medium text-white/90 hover:text-white transition-colors">
                    Mis propiedades
                </a>
                <a href="/admin/listings/create" class="cima-btn cima-btn-primary">
                    Nueva propiedad
                </a>
            }

            <LanguageSelector ButtonClass="text-white/80 hover:text-white text-xs font-medium tracking-widest uppercase transition-colors flex items-center gap-1" />
            
            @if (_isAuthenticated)
            {
                <!-- User Menu Dropdown -->
                <div class="relative group">
                    <button class="@GetLinkClass() flex items-center gap-2 py-2"
                            @onclick="ToggleUserMenu"
                            @onclick:stopPropagation="true">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                        </svg>
                        @_userName
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" 
                             class="w-4 h-4 transition-transform duration-200 @(_userMenuOpen ? "rotate-180" : "")">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                        </svg>
                    </button>
                    
                    @if (_userMenuOpen)
                    {
                        <div class="absolute top-full right-0 w-full h-2"></div>
                        <div class="absolute top-[calc(100%+0.5rem)] right-0 w-56 bg-navy-950 border border-white/10 rounded-lg shadow-xl py-2 animate-fade-in"
                             @onmouseleave="CloseUserMenuWithDelay">
                            @* Dashboard según rol *@
                            @if (_isAdmin)
                            {
                                <a href="/admin" class="block px-4 py-3 text-sm text-white/80 hover:text-white hover:bg-white/5 transition-colors"
                                   @onclick="CloseUserMenu">
                                    <div class="flex items-center gap-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
                                        </svg>
                                        @L["Menu:Dashboard"]
                                    </div>
                                </a>
                            }
                            else
                            {
                                <a href="/architect/dashboard" class="block px-4 py-3 text-sm text-white/80 hover:text-white hover:bg-white/5 transition-colors"
                                   @onclick="CloseUserMenu">
                                    <div class="flex items-center gap-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
                                        </svg>
                                        @L["Menu:User:Dashboard"]
                                    </div>
                                </a>
                                <a href="/architect/listings" class="block px-4 py-3 text-sm text-white/80 hover:text-white hover:bg-white/5 transition-colors"
                                   @onclick="CloseUserMenu">
                                    <div class="flex items-center gap-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5h10.5M8.25 9h10.5m-10.5 4.5h10.5M8.25 18h10.5M3 4.5h.008v.008H3V4.5zm0 4.5h.008v.008H3V9zm0 4.5h.008v.008H3V13.5zm0 4.5h.008v.008H3V18z" />
                                        </svg>
                                        Mis propiedades
                                    </div>
                                </a>
                                <a href="/admin/listings/create" class="block px-4 py-3 text-sm text-white/80 hover:text-white hover:bg-white/5 transition-colors"
                                   @onclick="CloseUserMenu">
                                    <div class="flex items-center gap-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                                        </svg>
                                        Nueva propiedad
                                    </div>
                                </a>
                            }
                            <hr class="my-1 border-white/10" />
                            <a href="/account/change-password" class="block px-4 py-3 text-sm text-white/80 hover:text-white hover:bg-white/5 transition-colors"
                               @onclick="CloseUserMenu">
                                <div class="flex items-center gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                                    </svg>
                                    @L["Menu:User:ChangePassword"]
                                </div>
                            </a>
                            <hr class="my-1 border-white/10" />
                            <a href="/Account/Logout" class="block px-4 py-3 text-sm text-red-400 hover:text-red-300 hover:bg-white/5 transition-colors">
                                <div class="flex items-center gap-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" />
                                    </svg>
                                    @L["Menu:User:Logout"]
                                </div>
                            </a>
                        </div>
                    }
                </div>
            }
            else
            {
                <a href="/Account/Login" class="@GetLinkClass()">
                    @L["Menu:Login"]
                </a>
            }
        </div>

        <!-- Mobile Menu Button -->
        <button class="md:hidden text-white p-2" @onclick="ToggleMobileMenu">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
        </button>
    </div>
</header>

<!-- Overlay para cerrar menús al hacer clic fuera -->
@if (_adminMenuOpen || _userMenuOpen)
{
    <div class="fixed inset-0 z-40" @onclick="CloseAllMenus"></div>
}

<!-- Mobile Menu Overlay -->
@if (_mobileMenuOpen)
{
    <div class="fixed inset-0 z-[60] bg-navy-950/95 backdrop-blur-xl flex flex-col items-center justify-center animate-fade-in">
        <button class="absolute top-6 right-6 text-white/60 hover:text-white p-2" @onclick="ToggleMobileMenu">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>

        <nav class="flex flex-col items-center gap-8 text-center">
            <a href="/" class="text-2xl font-display font-medium text-white hover:text-navy-300 transition-colors" @onclick="ToggleMobileMenu">@L["Menu:Home"]</a>
            <a href="/properties" class="text-2xl font-display font-medium text-white hover:text-navy-300 transition-colors" @onclick="ToggleMobileMenu">@L["Menu:Properties"]</a>
            <a href="/portfolio" class="text-2xl font-display font-medium text-white hover:text-navy-300 transition-colors" @onclick="ToggleMobileMenu">@L["Menu:Portfolio"]</a>
            
            @if (_isAuthenticated)
            {
                @if (_isAdmin)
                {
                    <div class="mt-4 pt-4 border-t border-white/10 w-full">
                        <p class="text-sm text-white/60 uppercase tracking-wider mb-3">@L["Menu:Admin"]</p>
                        <a href="/admin" class="block text-xl font-display font-medium text-white/80 hover:text-white transition-colors mb-3" @onclick="ToggleMobileMenu">
                            @L["Menu:Dashboard"]
                        </a>
                        <a href="/admin/listings" class="block text-xl font-display font-medium text-white/80 hover:text-white transition-colors mb-3" @onclick="ToggleMobileMenu">
                            @L["Menu:Admin:Listings"]
                        </a>
                        <a href="/admin/architects" class="block text-xl font-display font-medium text-white/80 hover:text-white transition-colors" @onclick="ToggleMobileMenu">
                            @L["Menu:Admin:Architects"]
                        </a>
                        <a href="/admin/settings" class="block text-xl font-display font-medium text-white/80 hover:text-white transition-colors" @onclick="ToggleMobileMenu">
                            Configuración
                        </a>
                    </div>
                }
                else
                {
                    <div class="mt-4 pt-4 border-t border-white/10 w-full">
                        <a href="/architect/dashboard" class="block text-xl font-display font-medium text-white/80 hover:text-white transition-colors mb-3" @onclick="ToggleMobileMenu">
                            @L["Menu:User:Dashboard"]
                        </a>
                        <a href="/architect/listings" class="block text-xl font-display font-medium text-white/80 hover:text-white transition-colors" @onclick="ToggleMobileMenu">
                            @L["Menu:User:MyListings"]
                        </a>
                        <a href="/admin/listings/create" class="block text-xl font-display font-medium text-white/80 hover:text-white transition-colors" @onclick="ToggleMobileMenu">
                            Nueva propiedad
                        </a>
                    </div>
                }
                
                <div class="mt-4 pt-4 border-t border-white/10 w-full">
                    <a href="/account/change-password" class="block text-xl font-display font-medium text-white/80 hover:text-white transition-colors mb-3" @onclick="ToggleMobileMenu">
                        @L["Menu:User:ChangePassword"]
                    </a>
                    <a href="/Account/Logout" class="block text-xl font-display font-medium text-red-400 hover:text-red-300 transition-colors" @onclick="ToggleMobileMenu">
                        @L["Menu:User:Logout"]
                    </a>
                </div>
            }
            else
            {
                <a href="/Account/Login" class="text-xl font-display font-medium text-white/80 hover:text-white transition-colors mt-4" @onclick="ToggleMobileMenu">
                    @L["Menu:Login"]
                </a>
            }
        </nav>
    </div>
}

@code {
    private const string NavbarStatePersistenceKey = "NavbarAuthState";
    
    private bool _isScrolled = false;
    private bool _useTransparentNavbar = true;
    private bool _mobileMenuOpen = false;
    private bool _adminMenuOpen = false;
    private bool _userMenuOpen = false;
    private DotNetObjectReference<Navbar>? _dotNetHelper;
    private IJSObjectReference? _scrollListener;
    private PersistingComponentStateSubscription _persistingSubscription;
    private System.Timers.Timer? _closeMenuTimer;
    
    // Estado de autenticación cacheado - evita re-renders innecesarios
    private bool _isAuthenticated = false;
    private bool _isAdmin = false;
    private bool _isArchitect = false;
    private string _userName = "";
    private bool _authStateLoaded = false;

    protected override async Task OnInitializedAsync()
    {
        // Intentar restaurar estado persistido (de pre-renderizado)
        _persistingSubscription = PersistentState.RegisterOnPersisting(PersistNavbarState);
        
        if (PersistentState.TryTakeFromJson<NavbarPersistedState>(NavbarStatePersistenceKey, out var restoredState) && restoredState is not null)
        {
            // Usar estado restaurado del pre-renderizado
            _isAuthenticated = restoredState.IsAuthenticated;
            _isAdmin = restoredState.IsAdmin;
            _isArchitect = restoredState.IsArchitect;
            _userName = restoredState.UserName;
            _authStateLoaded = true;
        }
        else
        {
            // Cargar estado fresco
            await LoadAuthenticationState();
        }

        UpdateNavbarMode();
        
        // Solo suscribirse a cambios en WASM (no en servidor)
        AuthenticationStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;
    }

    private Task PersistNavbarState()
    {
        PersistentState.PersistAsJson(NavbarStatePersistenceKey, new NavbarPersistedState
        {
            IsAuthenticated = _isAuthenticated,
            IsAdmin = _isAdmin,
            IsArchitect = _isArchitect,
            UserName = _userName
        });
        return Task.CompletedTask;
    }

    private async Task LoadAuthenticationState()
    {
        if (_authStateLoaded) return;
        
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            
            _isAuthenticated = user.Identity?.IsAuthenticated ?? false;
            _userName = user.Identity?.Name ?? "";
            _isAdmin = user.IsInRole("admin");
            _isArchitect = user.IsInRole("architect");
            _authStateLoaded = true;
        }
        catch
        {
            _isAuthenticated = false;
            _isAdmin = false;
            _isArchitect = false;
            _userName = "";
        }
    }

    private void UpdateNavbarMode(string? absoluteUri = null)
    {
        var relative = Navigation.ToBaseRelativePath(absoluteUri ?? Navigation.Uri);
        var path = relative.Split('?', '#')[0].Trim('/').ToLowerInvariant();

        // Navbar transparente solo en Home (hero), listados públicos y portafolio; sólido en el resto
        _useTransparentNavbar = string.IsNullOrEmpty(path)
            || path.StartsWith("properties")
            || path.StartsWith("portfolio");
    }

    private void OnAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        _ = HandleAuthenticationStateChangedAsync(task);
    }

    private async Task HandleAuthenticationStateChangedAsync(Task<AuthenticationState> task)
    {
        try
        {
            var authState = await task;
            var user = authState.User;

            var newIsAuthenticated = user.Identity?.IsAuthenticated ?? false;
            var newIsAdmin = user.IsInRole("admin");
            var newIsArchitect = user.IsInRole("architect");
            var newUserName = user.Identity?.Name ?? "";

            // Solo actualizar si realmente cambió algo significativo
            if (newIsAuthenticated != _isAuthenticated || newIsAdmin != _isAdmin || newIsArchitect != _isArchitect || newUserName != _userName)
            {
                _isAuthenticated = newIsAuthenticated;
                _isAdmin = newIsAdmin;
                _isArchitect = newIsArchitect;
                _userName = newUserName;
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al manejar cambio de autenticación en Navbar: {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!System.OperatingSystem.IsBrowser())
        {
            return;
        }

        if (firstRender)
        {
            try
            {
                _dotNetHelper = DotNetObjectReference.Create(this);
                
                // Registrar el listener de scroll con retorno del objeto dispose
                _scrollListener = await JS.InvokeAsync<IJSObjectReference>(
                    "cima.addScrollListener", _dotNetHelper);
                
                // Resetear estado al navegar
                Navigation.LocationChanged += OnLocationChanged;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error inicializando navbar scroll: {ex.Message}");
            }
        }
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        UpdateNavbarMode(e.Location);
        _isScrolled = false;
        _adminMenuOpen = false;
        _userMenuOpen = false;
        StateHasChanged();
    }

    [JSInvokable]
    public Task OnScroll(bool isScrolled)
    {
        // En vistas con navbar sálido, el scroll no debe modificar el fondo
        if (!_useTransparentNavbar)
        {
            if (_isScrolled)
            {
                _isScrolled = false;
                StateHasChanged();
            }
            return Task.CompletedTask;
        }

        if (_isScrolled != isScrolled)
        {
            _isScrolled = isScrolled;
            StateHasChanged();
        }
        return Task.CompletedTask;
    }

    private string GetLinkClass()
    {
        var solidBackground = !_useTransparentNavbar || _isScrolled;
        return "text-sm font-medium tracking-wide transition-colors duration-200 " +
               (solidBackground ? "text-neutral-100 hover:text-white" : "text-white/90 hover:text-white");
    }

    private string GetNavbarBackgroundClass()
    {
        var solidBackground = !_useTransparentNavbar || _isScrolled;
        return solidBackground
            ? "bg-gradient-to-b from-navy-900/95 via-navy-900/90 to-navy-950/90 shadow-lg backdrop-blur-md border-b border-navy-900/40"
            : "bg-transparent border-b border-white/10";
    }

    private void ToggleMobileMenu()
    {
        _mobileMenuOpen = !_mobileMenuOpen;
    }

    private void ToggleAdminMenu()
    {
        _adminMenuOpen = !_adminMenuOpen;
        if (_adminMenuOpen)
        {
            _userMenuOpen = false;
        }
    }

    private void ToggleUserMenu()
    {
        _userMenuOpen = !_userMenuOpen;
        if (_userMenuOpen)
        {
            _adminMenuOpen = false;
        }
    }

    private void CloseAdminMenu()
    {
        _adminMenuOpen = false;
    }

    private void CloseUserMenu()
    {
        _userMenuOpen = false;
    }

    private void CloseAllMenus()
    {
        _adminMenuOpen = false;
        _userMenuOpen = false;
    }

    private void CloseAdminMenuWithDelay()
    {
        // Pequeño delay para permitir el movimiento del mouse hacia los items del menú
        _closeMenuTimer?.Dispose();
        _closeMenuTimer = new System.Timers.Timer(150);
        _closeMenuTimer.Elapsed += (s, e) =>
        {
            _closeMenuTimer?.Dispose();
            InvokeAsync(() =>
            {
                _adminMenuOpen = false;
                StateHasChanged();
            });
        };
        _closeMenuTimer.AutoReset = false;
        _closeMenuTimer.Start();
    }

    private void CloseUserMenuWithDelay()
    {
        _closeMenuTimer?.Dispose();
        _closeMenuTimer = new System.Timers.Timer(150);
        _closeMenuTimer.Elapsed += (s, e) =>
        {
            _closeMenuTimer?.Dispose();
            InvokeAsync(() =>
            {
                _userMenuOpen = false;
                StateHasChanged();
            });
        };
        _closeMenuTimer.AutoReset = false;
        _closeMenuTimer.Start();
    }

    public async ValueTask DisposeAsync()
    {
        _persistingSubscription.Dispose();
        _closeMenuTimer?.Dispose();
        
        try
        {
            Navigation.LocationChanged -= OnLocationChanged;
            AuthenticationStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;

            // Llamar a dispose en JavaScript
            if (_scrollListener is not null)
            {
                await _scrollListener.InvokeVoidAsync("dispose");
                await _scrollListener.DisposeAsync();
            }
        }
        catch (JSDisconnectedException)
        {
            // El circuito ya está desconectado, esto es esperado
        }
        catch (Exception ex)
        {
            // Log pero no propagar el error durante dispose
            Console.WriteLine($"Error durante dispose del navbar: {ex.Message}");
        }
        finally
        {
            // Siempre liberar la referencia de .NET
            _dotNetHelper?.Dispose();
        }
    }

    /// <summary>
    /// Estado persistido del navbar entre pre-renderizado y hidratación WASM
    /// </summary>
    private sealed class NavbarPersistedState
    {
        public bool IsAuthenticated { get; set; }
        public bool IsAdmin { get; set; }
        public bool IsArchitect { get; set; }
        public string UserName { get; set; } = "";
    }
}
