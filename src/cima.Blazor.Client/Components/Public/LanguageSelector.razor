@using Microsoft.Extensions.Localization
@using cima.Localization
@using Volo.Abp.Localization
@using Microsoft.Extensions.Options
@inject IStringLocalizer<cimaResource> L
@inject IOptions<AbpLocalizationOptions> LocalizationOptions
@inject NavigationManager Navigation
@inject IJSRuntime JS

<div class="language-selector">
    <button @onclick="ToggleDropdown" 
            class="flex items-center gap-2 px-3 py-2 text-gray-700 hover:text-blue-600 transition-colors rounded-lg hover:bg-gray-100">
        <i class="fas fa-globe"></i>
        <span class="hidden md:inline">@GetCurrentLanguageName()</span>
        <i class="fas fa-chevron-down text-xs"></i>
    </button>
    
    @if (showDropdown)
    {
        <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
            <div class="py-2">
                <button @onclick="@(() => ChangeLanguage("es"))"
                        class="@GetLanguageClass("es")">
                    <span class="flag-icon flag-icon-es mr-2"></span>
                    Español
                    @if (IsCurrentLanguage("es"))
                    {
                        <i class="fas fa-check ml-auto text-blue-600"></i>
                    }
                </button>
                
                <button @onclick="@(() => ChangeLanguage("en"))"
                        class="@GetLanguageClass("en")">
                    <span class="flag-icon flag-icon-us mr-2"></span>
                    English
                    @if (IsCurrentLanguage("en"))
                    {
                        <i class="fas fa-check ml-auto text-blue-600"></i>
                    }
                </button>
            </div>
        </div>
    }
</div>

@code {
    private bool showDropdown = false;
    private string currentCulture = "es";

    protected override async Task OnInitializedAsync()
    {
        // Obtener cultura actual desde localStorage o sistema
        try
        {
            var storedCulture = await JS.InvokeAsync<string>("localStorage.getItem", "selectedCulture");
            currentCulture = string.IsNullOrEmpty(storedCulture) ? "es" : storedCulture;
        }
        catch
        {
            currentCulture = "es";
        }
    }

    private void ToggleDropdown()
    {
        showDropdown = !showDropdown;
    }

    private async Task ChangeLanguage(string cultureName)
    {
        if (currentCulture == cultureName)
        {
            showDropdown = false;
            return;
        }

        currentCulture = cultureName;
        showDropdown = false;

        // Guardar preferencia en localStorage
        try
        {
            await JS.InvokeVoidAsync("localStorage.setItem", "selectedCulture", cultureName);
        }
        catch
        {
            // Ignorar si falla
        }

        // Recargar la página con la nueva cultura
        var uri = new Uri(Navigation.Uri)
            .GetComponents(UriComponents.PathAndQuery, UriFormat.Unescaped);
        var cultureEscaped = Uri.EscapeDataString(cultureName);
        var uriEscaped = Uri.EscapeDataString(uri);

        Navigation.NavigateTo(
            $"Culture/SetCulture?culture={cultureEscaped}&redirectUri={uriEscaped}",
            forceLoad: true);
    }

    private bool IsCurrentLanguage(string cultureName)
    {
        return currentCulture.Equals(cultureName, StringComparison.OrdinalIgnoreCase);
    }

    private string GetCurrentLanguageName()
    {
        return currentCulture.ToLower() switch
        {
            "es" => "Español",
            "en" => "English",
            _ => "Español"
        };
    }

    private string GetLanguageClass(string cultureName)
    {
        var baseClass = "w-full text-left px-4 py-2 hover:bg-gray-100 transition-colors flex items-center";
        if (IsCurrentLanguage(cultureName))
        {
            baseClass += " bg-blue-50 text-blue-600 font-semibold";
        }
        else
        {
            baseClass += " text-gray-700";
        }
        return baseClass;
    }
}

<style>
    .language-selector {
        position: relative;
        display: inline-block;
    }

    /* Flag icons - puedes agregar una librería de flags o usar emojis */
    .flag-icon {
        width: 20px;
        height: 15px;
        display: inline-block;
        border-radius: 2px;
    }

    .flag-icon-es::before {
        content: "????";
    }

    .flag-icon-us::before {
        content: "????";
    }
</style>
