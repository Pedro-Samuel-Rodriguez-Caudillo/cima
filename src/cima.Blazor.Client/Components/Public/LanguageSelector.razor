@using Microsoft.Extensions.Localization
@using cima.Localization
@using Volo.Abp.Localization
@using Microsoft.Extensions.Options
@inject IStringLocalizer<cimaResource> L
@inject IOptions<AbpLocalizationOptions> LocalizationOptions
@inject NavigationManager Navigation
@rendermode InteractiveAuto

<div class="language-selector">
    <button @onclick="ToggleDropdown" 
            class="@ButtonClass">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 21l5.25-11.25L21 21m-9-3h7.5M3 5.621a48.474 48.474 0 016-.371m0 0c1.12 0 2.233.038 3.334.114M9 5.25V3m3.334 2.364C11.176 10.658 7.69 15.08 3 17.502m9.334-12.138c.896.061 1.785.147 2.666.257m-4.589 8.495a18.023 18.023 0 01-3.827-5.802" />
        </svg>
        <span class="hidden md:inline">@GetCurrentLanguageName()</span>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
        </svg>
    </button>
    
    @if (showDropdown)
    {
        <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
            <div class="py-2">
                <button @onclick="@(() => ChangeLanguage("es"))"
                        class="@GetLanguageClass("es")">
                    <span class="mr-2">ðŸ‡ªðŸ‡¸</span>
                    EspaÃ±ol
                    @if (IsCurrentLanguage("es"))
                    {
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 ml-auto text-blue-600">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                        </svg>
                    }
                </button>
                
                <button @onclick="@(() => ChangeLanguage("en"))"
                        class="@GetLanguageClass("en")">
                    <span class="mr-2">ðŸ‡ºðŸ‡¸</span>
                    English
                    @if (IsCurrentLanguage("en"))
                    {
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 ml-auto text-blue-600">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                        </svg>
                    }
                </button>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public string ButtonClass { get; set; } = "flex items-center gap-2 px-3 py-2 text-gray-700 hover:text-blue-600 transition-colors rounded-lg hover:bg-gray-100";

    private bool showDropdown = false;
    private string currentCulture = "es";

    protected override void OnInitialized()
    {
        currentCulture = System.Globalization.CultureInfo.CurrentUICulture.TwoLetterISOLanguageName;
    }

    private void ToggleDropdown()
    {
        showDropdown = !showDropdown;
    }

    private void ChangeLanguage(string cultureName)
    {
        if (currentCulture == cultureName)
        {
            showDropdown = false;
            return;
        }

        try
        {
            // Construir URL con parÃ¡metro culture
            var uri = new Uri(Navigation.Uri);
            var baseUrl = $"{uri.Scheme}://{uri.Authority}{uri.AbsolutePath}";
            var newUrl = $"{baseUrl}?culture={cultureName}";
            
            // Navegar forzando reload completo
            Navigation.NavigateTo(newUrl, forceLoad: true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error changing language: {ex.Message}");
            showDropdown = false;
        }
    }

    private bool IsCurrentLanguage(string cultureName)
    {
        return currentCulture.Equals(cultureName, StringComparison.OrdinalIgnoreCase);
    }

    private string GetCurrentLanguageName()
    {
        return currentCulture.ToLower() switch
        {
            "es" => "ES",
            "en" => "EN",
            _ => "ES"
        };
    }

    private string GetLanguageClass(string cultureName)
    {
        var baseClass = "w-full text-left px-4 py-2 hover:bg-gray-100 transition-colors flex items-center";
        if (IsCurrentLanguage(cultureName))
        {
            baseClass += " bg-blue-50 text-blue-600 font-semibold";
        }
        else
        {
            baseClass += " text-gray-700";
        }
        return baseClass;
    }
}

<style>
    .language-selector {
        position: relative;
        display: inline-block;
    }
</style>
