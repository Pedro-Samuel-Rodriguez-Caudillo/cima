@using Microsoft.Extensions.Localization
@using cima.Localization
@using Volo.Abp.Localization
@using Microsoft.Extensions.Options
@inject IStringLocalizer<cimaResource> L
@inject IOptions<AbpLocalizationOptions> LocalizationOptions
@inject NavigationManager Navigation
@inject IJSRuntime JS

<div class="language-selector">
    <button @onclick="ToggleDropdown" 
            class="@ButtonClass">
        <i class="fas fa-globe"></i>
        <span class="hidden md:inline">@GetCurrentLanguageName()</span>
        <i class="fas fa-chevron-down text-xs"></i>
    </button>
    
    @if (showDropdown)
    {
        <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
            <div class="py-2">
                <button @onclick="@(() => ChangeLanguage("es"))"
                        class="@GetLanguageClass("es")">
                    <span class="flag-icon flag-icon-es mr-2"></span>
                    Espa침ol
                    @if (IsCurrentLanguage("es"))
                    {
                        <i class="fas fa-check ml-auto text-blue-600"></i>
                    }
                </button>
                
                <button @onclick="@(() => ChangeLanguage("en"))"
                        class="@GetLanguageClass("en")">
                    <span class="flag-icon flag-icon-us mr-2"></span>
                    English
                    @if (IsCurrentLanguage("en"))
                    {
                        <i class="fas fa-check ml-auto text-blue-600"></i>
                    }
                </button>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public string ButtonClass { get; set; } = "flex items-center gap-2 px-3 py-2 text-gray-700 hover:text-blue-600 transition-colors rounded-lg hover:bg-gray-100";

    private bool showDropdown = false;
    private string currentCulture = "es";

    protected override void OnInitialized()
    {
        // Obtener la cultura actual del sistema de ABP
        currentCulture = System.Globalization.CultureInfo.CurrentUICulture.TwoLetterISOLanguageName;
    }

    private void ToggleDropdown()
    {
        showDropdown = !showDropdown;
    }

    private void ChangeLanguage(string cultureName)
    {
        if (currentCulture == cultureName)
        {
            showDropdown = false;
            return;
        }

        // Cambiar cultura usando el mecanismo de ABP
        // ABP espera el par치metro 'culture' en la URL para cambiar la cultura
        var uri = new Uri(Navigation.Uri);
        var currentUrl = uri.PathAndQuery;
        
        // Construir nueva URL con par치metro culture
        var newUrl = Navigation.GetUriWithQueryParameter("culture", cultureName);
        
        // Navegar a la nueva URL - esto recargar치 la p치gina con la nueva cultura
        Navigation.NavigateTo(newUrl, forceLoad: true);
    }

    private bool IsCurrentLanguage(string cultureName)
    {
        return currentCulture.Equals(cultureName, StringComparison.OrdinalIgnoreCase);
    }

    private string GetCurrentLanguageName()
    {
        return currentCulture.ToLower() switch
        {
            "es" => "Espa침ol",
            "en" => "English",
            _ => "Espa침ol"
        };
    }

    private string GetLanguageClass(string cultureName)
    {
        var baseClass = "w-full text-left px-4 py-2 hover:bg-gray-100 transition-colors flex items-center";
        if (IsCurrentLanguage(cultureName))
        {
            baseClass += " bg-blue-50 text-blue-600 font-semibold";
        }
        else
        {
            baseClass += " text-gray-700";
        }
        return baseClass;
    }
}

<style>
    .language-selector {
        position: relative;
        display: inline-block;
    }

    /* Flag icons - emojis para banderas */
    .flag-icon {
        width: 20px;
        height: 15px;
        display: inline-block;
        border-radius: 2px;
    }

    .flag-icon-es::before {
        content: "游쀯릖";
    }

    .flag-icon-us::before {
        content: "游쥟릖";
    }
</style>
