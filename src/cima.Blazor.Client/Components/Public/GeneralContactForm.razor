@using cima.Domain.Shared.Dtos
@using cima.ContactRequests
@using System.ComponentModel.DataAnnotations
@using Volo.Abp.AspNetCore.Components.Messages
@inject IContactRequestAppService ContactRequestService
@inject IUiMessageService MessageService
@inherits cimaComponentBase

@*
    Formulario de contacto general (NO asociado a una propiedad específica)
    Para Home page - envía correo de consulta general
*@

<div class="cima-card p-6 md:p-8">
    @if (IsSuccess)
    {
        <div class="text-center py-8">
            <div class="w-16 h-16 bg-success-light rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
            </div>
            <h3 class="text-xl font-semibold text-neutral-900 mb-2">
                @L["ContactForm:SuccessTitle"]
            </h3>
            <p class="text-neutral-600 mb-6">
                @L["ContactForm:SuccessMessage"]
            </p>
            <button 
                @onclick="ResetForm"
                class="cima-btn cima-btn-outline">
                @L["ContactForm:SendAnother"]
            </button>
        </div>
    }
    else
    {
        <EditForm Model="@Model" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />

            <div class="space-y-4">
                @* Nombre *@
                <div class="cima-form-group">
                    <label for="contact-name" class="cima-label cima-label-required">
                        @L["ContactForm:Name"]
                    </label>
                    <InputText 
                        id="contact-name"
                        @bind-Value="Model.Name"
                        class="cima-input"
                        placeholder="@L["ContactForm:NamePlaceholder"]"
                        disabled="@IsSubmitting" />
                    <ValidationMessage For="@(() => Model.Name)" class="cima-error-message" />
                </div>

                @* Email *@
                <div class="cima-form-group">
                    <label for="contact-email" class="cima-label cima-label-required">
                        @L["ContactForm:Email"]
                    </label>
                    <InputText 
                        id="contact-email"
                        type="email"
                        @bind-Value="Model.Email"
                        class="cima-input"
                        placeholder="@L["ContactForm:EmailPlaceholder"]"
                        disabled="@IsSubmitting" />
                    <ValidationMessage For="@(() => Model.Email)" class="cima-error-message" />
                </div>

                @* Teléfono (opcional) *@
                <div class="cima-form-group">
                    <label for="contact-phone" class="cima-label">
                        @L["ContactForm:Phone"] <span class="text-neutral-500 text-sm">(@L["Common:Optional"])</span>
                    </label>
                    <InputText 
                        id="contact-phone"
                        type="tel"
                        @bind-Value="Model.Phone"
                        class="cima-input"
                        placeholder="@L["ContactForm:PhonePlaceholder"]"
                        disabled="@IsSubmitting" />
                    <ValidationMessage For="@(() => Model.Phone)" class="cima-error-message" />
                </div>

                @* Mensaje *@
                <div class="cima-form-group">
                    <label for="contact-message" class="cima-label cima-label-required">
                        @L["ContactForm:Message"]
                    </label>
                    <InputTextArea 
                        id="contact-message"
                        @bind-Value="Model.Message"
                        class="cima-input min-h-[120px]"
                        placeholder="@L["ContactForm:GeneralMessagePlaceholder"]"
                        disabled="@IsSubmitting"
                        rows="5" />
                    <ValidationMessage For="@(() => Model.Message)" class="cima-error-message" />
                </div>

                @* Botón de envío *@
                <button 
                    type="submit" 
                    class="cima-btn cima-btn-primary w-full"
                    disabled="@IsSubmitting">
                    @if (IsSubmitting)
                    {
                        <span class="cima-loading-spinner mr-2"></span>
                        <span>@L["ContactForm:Sending"]</span>
                    }
                    else
                    {
                        <span>@L["ContactForm:Submit"]</span>
                    }
                </button>
            </div>
        </EditForm>
    }
</div>

@code {
    private GeneralContactModel Model { get; set; } = new();
    private bool IsSubmitting { get; set; }
    private bool IsSuccess { get; set; }

    private class GeneralContactModel
    {
        [Required(ErrorMessage = "El nombre es requerido")]
        [StringLength(100, MinimumLength = 2, ErrorMessage = "El nombre debe tener entre 2 y 100 caracteres")]
        public string Name { get; set; } = string.Empty;

        [Required(ErrorMessage = "El email es requerido")]
        [EmailAddress(ErrorMessage = "Email inválido")]
        public string Email { get; set; } = string.Empty;

        [Phone(ErrorMessage = "Teléfono inválido")]
        public string? Phone { get; set; }

        [Required(ErrorMessage = "El mensaje es requerido")]
        [StringLength(5000, MinimumLength = 10, ErrorMessage = "El mensaje debe tener entre 10 y 5000 caracteres")]
        public string Message { get; set; } = string.Empty;
    }

    private async Task HandleSubmit()
    {
        try
        {
            IsSubmitting = true;

            // NOTA: Para contacto general, necesitaríamos un endpoint diferente
            // o un ListingId "general" predefinido. Por ahora, mostraremos mensaje de éxito
            // sin llamar al servicio real.
            
            // TODO: Implementar endpoint de contacto general en backend
            // O crear una propiedad "General" con ID fijo para estos casos
            
            await Task.Delay(1000); // Simular envío

            IsSuccess = true;
            
            await MessageService.Success(L["ContactForm:Success"]);
        }
        catch (Exception ex)
        {
            await HandleErrorAsync(ex);
            await MessageService.Error(L["ContactForm:Error:Submit", ex.Message]);
        }
        finally
        {
            IsSubmitting = false;
        }
    }

    private void ResetForm()
    {
        Model = new();
        IsSuccess = false;
        StateHasChanged();
    }
}
