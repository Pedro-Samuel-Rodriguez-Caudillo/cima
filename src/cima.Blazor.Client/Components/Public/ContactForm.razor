@using cima.ContactRequests
@using System.ComponentModel.DataAnnotations
@using Volo.Abp.AspNetCore.Components.Messages
@inject IContactRequestAppService ContactRequestService
@inject IUiMessageService MessageService
@inherits cimaComponentBase

@*
    Formulario de contacto asociado a una propiedad específica
    Para página de detalle de propiedad
*@

<div class="cima-card p-6">
    <h3 class="text-xl font-semibold text-neutral-900 mb-4">
        @L["ContactForm:Title"]
    </h3>

    @if (IsSuccess)
    {
        <div class="text-center py-8">
            <div class="w-16 h-16 bg-success-light rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
            </div>
            <h4 class="text-lg font-semibold text-neutral-900 mb-2">
                @L["ContactForm:SuccessTitle"]
            </h4>
            <p class="text-sm text-neutral-600 mb-6">
                @L["ContactForm:SuccessMessage"]
            </p>
            <button
                @onclick="ResetForm"
                class="cima-btn cima-btn-outline text-sm">
                @L["ContactForm:SendAnother"]
            </button>
        </div>
    }
    else
    {
        <EditForm Model="@Model" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />

            <div class="space-y-4">
                @* Nombre *@
                <div class="cima-form-group">
                    <label for="contact-name" class="cima-label cima-label-required">
                        @L["ContactForm:Name"]
                    </label>
                    <InputText
                        id="contact-name"
                        @bind-Value="Model.Name"
                        class="cima-input"
                        placeholder="@L["ContactForm:NamePlaceholder"]"
                        disabled="@IsSubmitting" />
                    <ValidationMessage For="@(() => Model.Name)" class="cima-error-message" />
                </div>

                @* Email *@
                <div class="cima-form-group">
                    <label for="contact-email" class="cima-label cima-label-required">
                        @L["ContactForm:Email"]
                    </label>
                    <InputText
                        id="contact-email"
                        type="email"
                        @bind-Value="Model.Email"
                        class="cima-input"
                        placeholder="@L["ContactForm:EmailPlaceholder"]"
                        disabled="@IsSubmitting" />
                    <ValidationMessage For="@(() => Model.Email)" class="cima-error-message" />
                </div>

                @* Teléfono (opcional) *@
                <div class="cima-form-group">
                    <label for="contact-phone" class="cima-label">
                        @L["ContactForm:Phone"] <span class="text-neutral-500 text-xs">(@L["Common:Optional"])</span>
                    </label>
                    <InputText
                        id="contact-phone"
                        type="tel"
                        @bind-Value="Model.Phone"
                        class="cima-input"
                        placeholder="@L["ContactForm:PhonePlaceholder"]"
                        disabled="@IsSubmitting" />
                    <ValidationMessage For="@(() => Model.Phone)" class="cima-error-message" />
                </div>

                @* Mensaje *@
                <div class="cima-form-group">
                    <label for="contact-message" class="cima-label cima-label-required">
                        @L["ContactForm:Message"]
                    </label>
                    <InputTextArea
                        id="contact-message"
                        @bind-Value="Model.Message"
                        class="cima-input min-h-[100px]"
                        placeholder="@L["ContactForm:MessagePlaceholder"]"
                        disabled="@IsSubmitting"
                        rows="4" />
                    <ValidationMessage For="@(() => Model.Message)" class="cima-error-message" />
                </div>

                @* Info de propiedad *@
                <div class="p-3 bg-navy-50 rounded-lg text-sm text-neutral-700">
                    <p class="font-medium mb-1">@L["ContactForm:InterestedInProperty", ListingTitle]</p>
                </div>

                @* Botón de envío *@
                <button
                    type="submit"
                    class="cima-btn cima-btn-primary w-full"
                    disabled="@IsSubmitting">
                    @if (IsSubmitting)
                    {
                        <span class="cima-loading-spinner mr-2"></span>
                        <span>@L["ContactForm:Sending"]</span>
                    }
                    else
                    {
                        <span>@L["ContactForm:Submit"]</span>
                    }
                </button>
            </div>
        </EditForm>
    }
</div>

@code {
    [Parameter, EditorRequired]
    public Guid ListingId { get; set; }

    [Parameter, EditorRequired]
    public string ListingTitle { get; set; } = string.Empty;

    private ContactModel Model { get; set; } = new();
    private bool IsSubmitting { get; set; }
    private bool IsSuccess { get; set; }

    private class ContactModel
    {
        [Required(ErrorMessage = "ContactForm:Error:NameRequired")]
        [StringLength(100, MinimumLength = 2, ErrorMessage = "ContactForm:Error:NameLength")]
        public string Name { get; set; } = string.Empty;

        [Required(ErrorMessage = "ContactForm:Error:EmailRequired")]
        [EmailAddress(ErrorMessage = "ContactForm:Error:EmailInvalid")]
        public string Email { get; set; } = string.Empty;

        [Phone(ErrorMessage = "ContactForm:Error:PhoneInvalid")]
        public string? Phone { get; set; }

        [Required(ErrorMessage = "ContactForm:Error:MessageRequired")]
        [StringLength(5000, MinimumLength = 10, ErrorMessage = "ContactForm:Error:MessageLength")]
        public string Message { get; set; } = string.Empty;
    }

    private async Task HandleSubmit()
    {
        try
        {
            IsSubmitting = true;

            var dto = new CreateContactRequestDto
            {
                Name = Model.Name,
                Email = Model.Email,
                Phone = Model.Phone ?? string.Empty,
                Message = Model.Message,
                ListingId = ListingId
            };

            await ContactRequestService.CreateAsync(dto);

            IsSuccess = true;

            await MessageService.Success(L["ContactForm:Success"]);
        }
        catch (Exception ex)
        {
            await HandleErrorAsync(ex);
            await MessageService.Error(L["ContactForm:Error:Submit", ex.Message]);
        }
        finally
        {
            IsSubmitting = false;
        }
    }

    private void ResetForm()
    {
        Model = new();
        IsSuccess = false;
        StateHasChanged();
    }
}
