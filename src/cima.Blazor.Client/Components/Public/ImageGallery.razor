@using Microsoft.Extensions.Localization
@using cima.Localization
@inject IJSRuntime JS
@inject IStringLocalizer<cimaResource> L
@implements IAsyncDisposable

<div class="image-gallery space-y-4">
    @* Imagen principal con altura responsive *@
    <div class="relative mb-2 aspect-[16/9] w-full max-w-[860px] mx-auto rounded-[24px] overflow-hidden shadow-xl border border-white/40 bg-neutral-100">
        <img src="@CurrentImage"
             alt="@GetMainAltText()"
             class="absolute inset-0 w-full h-full object-cover cursor-pointer transition-transform duration-500 hover:scale-[1.01]"
             loading="eager"
             @onclick="OpenLightbox" />
        
        @if (Images.Count > 1)
        {
            @* Botones de navegacion *@
            <button @onclick="PreviousImage" 
                    class="absolute left-3 sm:left-5 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white p-2 sm:p-3 rounded-full shadow-lg transition">
                <svg class="w-5 h-5 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </button>
            <button @onclick="NextImage" 
                    class="absolute right-3 sm:right-5 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white p-2 sm:p-3 rounded-full shadow-lg transition">
                <svg class="w-5 h-5 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </button>
            
            @* Contador *@
            <div class="absolute bottom-3 sm:bottom-5 left-1/2 -translate-x-1/2 bg-black/60 text-white px-3 sm:px-4 py-1 sm:py-2 rounded-full text-xs sm:text-sm shadow">
                @(currentIndex + 1) / @Images.Count
            </div>
        }
    </div>
    
    @* Miniaturas Grid *@
    <div class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 gap-3 mt-4">
        @for (int i = 0; i < Images.Count; i++)
        {
            var index = i;
            var isActive = index == currentIndex;
            <div class="relative cursor-pointer rounded-xl overflow-hidden aspect-[4/3] @(isActive ? "ring-2 ring-navy-900 ring-offset-2" : "hover:ring-2 hover:ring-gray-300 hover:ring-offset-1") transition-all duration-200" 
                 @onclick="() => SetCurrentImage(index)">
                <img src="@Images[index]"
                     alt="@GetThumbnailAltText(index)"
                     class="w-full h-full object-cover @(isActive ? "opacity-100" : "opacity-60 hover:opacity-100") transition-opacity duration-200"
                     loading="lazy" />
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public List<string> Images { get; set; } = new();

    private int currentIndex = 0;
    private DotNetObjectReference<ImageGallery>? _dotNetRef;

    private const string PlaceholderImage = "/images/placeholder.jpg";
    private string CurrentImage => Images.Count > 0 ? Images[currentIndex] : PlaceholderImage;

    private bool IsPlaceholder(string image) => string.Equals(image, PlaceholderImage, StringComparison.OrdinalIgnoreCase);

    private string GetMainAltText() => IsPlaceholder(CurrentImage)
        ? L["ImageGallery:PlaceholderAltMain"]
        : L["ImageGallery:MainAlt"];

    private string GetThumbnailAltText(int index)
    {
        var image = Images.ElementAtOrDefault(index) ?? PlaceholderImage;
        return IsPlaceholder(image)
            ? L["ImageGallery:PlaceholderAltThumb"]
            : L["ImageGallery:ThumbAlt", index + 1];
    }
    
    private void NextImage()
    {
        if (Images.Count > 0)
        {
            currentIndex = (currentIndex + 1) % Images.Count;
        }
    }
    
    private void PreviousImage()
    {
        if (Images.Count > 0)
        {
            currentIndex = currentIndex == 0 ? Images.Count - 1 : currentIndex - 1;
        }
    }
    
    private void SetCurrentImage(int index)
    {
        currentIndex = index;
    }
    
    private async Task OpenLightbox()
    {
        if (Images.Count == 0) return;
        
        _dotNetRef ??= DotNetObjectReference.Create(this);
        await JS.InvokeVoidAsync("cimaLightbox.open", Images, currentIndex, _dotNetRef);
    }
    
    [JSInvokable]
    public void OnLightboxIndexChanged(int newIndex)
    {
        currentIndex = newIndex;
        StateHasChanged();
    }
    
    [JSInvokable]
    public void OnLightboxClosed()
    {
        // Lightbox cerrado, nada que hacer aqu√≠ por ahora
    }
    
    protected override void OnInitialized()
    {
        // Si no hay imagenes, agregar una de placeholder
        if (Images.Count == 0)
        {
            Images.Add(PlaceholderImage);
        }
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JS.InvokeVoidAsync("cimaLightbox.close");
        }
        catch
        {
            // Ignore errors during disposal
        }
        
        _dotNetRef?.Dispose();
    }
}

