@using cima.Listings
@using cima.Blazor.Client.Services
@using System.Linq
@inject NavigationManager Navigation
@inject EnumLocalizationService EnumLocalizer

<article class="group bg-white rounded-2xl shadow-md hover:shadow-2xl transition-all duration-300 overflow-hidden cursor-pointer transform hover:-translate-y-1" 
         @onclick="NavigateToDetail"
         @onclick:stopPropagation="true">
    
    @* Image Container *@
    <div class="relative aspect-[4/3] overflow-hidden">
        @{
            var imageUrl = Listing.Images?.FirstOrDefault()?.Url;
        }
        @if (!string.IsNullOrEmpty(imageUrl))
        {
            <img src="@imageUrl" 
                 alt="@Listing.Title" 
                 class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" 
                 loading="lazy" />
        }
        else
        {
            <div class="w-full h-full bg-gradient-to-br from-neutral-100 to-neutral-200 flex items-center justify-center">
                <svg class="w-16 h-16 text-neutral-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" 
                          d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" 
                          d="M9 22V12h6v10" />
                </svg>
            </div>
        }
        
        @* Overlay gradient *@
        <div class="absolute inset-0 bg-gradient-to-t from-navy-950/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
        
        @* Top badges *@
        <div class="absolute top-3 left-3 right-3 flex justify-between items-start">
            @* Image count badge (if multiple) *@
            @if (Listing.Images?.Count > 1)
            {
                <span class="flex items-center gap-1 px-2 py-1 bg-navy-900/70 backdrop-blur-sm text-white text-xs font-medium rounded-lg ml-auto">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    @Listing.Images.Count
                </span>
            }
        </div>
        
        @* Property type badge *@
        <div class="absolute bottom-3 left-3">
            <span class="px-3 py-1.5 bg-white/95 backdrop-blur-sm text-navy-800 text-xs font-semibold rounded-lg shadow-sm">
                @EnumLocalizer.GetPropertyTypeName(Listing.Type)
            </span>
        </div>
    </div>
    
    @* Content *@
    <div class="p-5">
        @* Location *@
        <div class="flex items-center gap-1.5 text-neutral-500 text-sm mb-2">
            <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <span class="truncate">@GetLocationDisplay()</span>
        </div>
        
        @* Title *@
        <h3 class="text-lg font-display font-bold text-navy-900 mb-3 line-clamp-2 group-hover:text-navy-700 transition-colors">
            @Listing.Title
        </h3>
        
        @* Features *@
        <div class="flex items-center gap-4 text-sm text-neutral-600 mb-4 pb-4 border-b border-neutral-100">
            @if (Listing.Bedrooms > 0)
            {
                <div class="flex items-center gap-1.5" title="Recámaras">
                    @* Icono de cama *@
                    <svg class="w-4 h-4 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M3 7v11m0-4h18m0 4V8a2 2 0 00-2-2H9a2 2 0 00-2 2v3" />
                    </svg>
                    <span class="font-medium">@Listing.Bedrooms</span>
                </div>
            }
            @if (Listing.Bathrooms > 0)
            {
                <div class="flex items-center gap-1.5" title="Baños">
                    @* Icono de bañera/ducha *@
                    <svg class="w-4 h-4 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M3 13h18v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M5 13V6a2 2 0 012-2h1" />
                        <circle cx="8" cy="4" r="1" fill="currentColor" />
                    </svg>
                    <span class="font-medium">@Listing.Bathrooms</span>
                </div>
            }
            @if (Listing.ConstructionArea > 0)
            {
                <div class="flex items-center gap-1.5" title="Área de construcción">
                    <svg class="w-4 h-4 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                    </svg>
                    <span class="font-medium">@Listing.ConstructionArea<span class="text-xs text-neutral-400 ml-0.5">m²</span></span>
                </div>
            }
        </div>
        
        @* Price and CTA *@
        <div class="flex items-center justify-between">
            <div>
                <p class="text-xs text-neutral-500 uppercase tracking-wide mb-0.5">Precio</p>
                <p class="text-xl font-display font-bold text-navy-900">
                    @FormatPrice(Listing.Price)
                </p>
            </div>
            
            <div class="flex items-center text-navy-600 font-semibold text-sm group-hover:text-navy-800 transition-colors">
                <span>Ver más</span>
                <svg class="w-4 h-4 ml-1 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </div>
        </div>
    </div>
</article>

@code {
    [Parameter]
    public ListingDto Listing { get; set; } = default!;

    private void NavigateToDetail()
    {
        Navigation.NavigateTo($"/properties/{Listing.Id}");
    }

    private string FormatPrice(decimal price)
    {
        if (price >= 1_000_000)
        {
            return $"${price / 1_000_000:N2}M MXN";
        }
        else if (price >= 1_000)
        {
            return $"${price / 1_000:N0}K MXN";
        }
        return price.ToString("C0") + " MXN";
    }

    private string GetLocationDisplay()
    {
        var location = Listing.Location?.ToString();
        return string.IsNullOrWhiteSpace(location) ? "Ubicación no especificada" : location;
    }
}
