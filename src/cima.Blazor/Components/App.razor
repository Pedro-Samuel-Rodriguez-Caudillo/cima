@using System.Globalization
@using Microsoft.Extensions.Hosting
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using cima.Blazor.Client.Authentication
@using Volo.Abp.Localization
@inject IHostEnvironment Env
@inject PersistentComponentState PersistentComponentState
@inject AuthenticationStateProvider AuthenticationStateProvider
@implements IDisposable
@{
    var rtl = CultureHelper.IsRtl ? "rtl" : string.Empty;
}

<!DOCTYPE html>
<html lang="@CultureInfo.CurrentCulture.Name" dir="@rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>cima</title>
    <base href="/" />

    <!-- Preload critical resources -->
    <link rel="preload" href="_framework/blazor.web.js" as="script" />
    <link rel="preload" href="/css/app.min.css" as="style" />

    <!-- Scoped styles -->
    <link href="cima.Blazor.styles.css" rel="stylesheet"/>
    <link href="cima.Blazor.Client.styles.css" rel="stylesheet"/>
    
    <!-- MudBlazor -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
    <link href="_content/MudBlazor/MudBlazor.min.css" rel="stylesheet" />

    <!-- Tailwind -->
    <link href="/css/app.min.css" rel="stylesheet"/>
    
    <HeadOutlet @rendermode="InteractiveAuto" />

    <!-- Loading indicator styles - DESACTIVADO -->
    <style>
        #blazor-loading-indicator {
            display: none !important;
        }
    </style>
</head>
<body class="abp-application-layout @rtl">

    <!-- Loading indicator - DESACTIVADO -->
    <!--
    <div id="blazor-loading-indicator">
        <div class="spinner"></div>
        <span>Cargando...</span>
    </div>
    -->

    <Routes @rendermode="InteractiveAuto" />

    <div id="blazor-error-ui">
        @if (Env.IsDevelopment())
        {
            <text>An unhandled exception has occurred. See browser dev tools for details.</text>
        }
        else if (Env.IsStaging() || Env.IsProduction())
        {
            <text>An error has occurred. This application may no longer respond until reloaded.</text>
        }
        <a href="" class="reload">Reload</a>
        <a class="dismiss">X</a>
    </div>
    
    <!-- Script de navbar ANTES de Blazor -->
    <script src="/js/navbar-scroll.js"></script>
    
    <script src="_content/Volo.Abp.AspNetCore.Components.Web/libs/abp/js/abp.js"></script>
    
    <!-- Script de Blazor con autostart=false para controlar inicio -->
    <script src="_framework/blazor.web.js" autostart="false"></script>
    <script src="_content/MudBlazor/MudBlazor.min.js"></script>
    
    <!-- Control de inicio de Blazor -->
    <script>
        (function() {
            // Iniciar Blazor manualmente
            Blazor.start().then(function() {
                console.log('[cima] Blazor iniciado');
            }).catch(function(err) {
                console.error('[cima] Error iniciando Blazor:', err);
            });
        })();
    </script>

</body>
</html>

@code{
    private PersistingComponentStateSubscription _persistingSubscription;

    protected override async Task OnInitializedAsync()
    {
        _persistingSubscription = PersistentComponentState.RegisterOnPersisting(PersistAuthenticationState);
    }

    private async Task PersistAuthenticationState()
    {
        var authenticationState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        
        if (authenticationState.User.Identity?.IsAuthenticated == true)
        {
            var userInfo = new UserInfo
            {
                UserId = authenticationState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? string.Empty,
                UserName = authenticationState.User.FindFirst(ClaimTypes.Name)?.Value ?? string.Empty,
                Email = authenticationState.User.FindFirst(ClaimTypes.Email)?.Value,
                Roles = authenticationState.User.FindAll(ClaimTypes.Role).Select(c => c.Value).ToArray()
            };
            
            PersistentComponentState.PersistAsJson(nameof(UserInfo), userInfo);
        }
    }

    public void Dispose()
    {
        _persistingSubscription.Dispose();
    }
}