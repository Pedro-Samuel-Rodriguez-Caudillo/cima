@using System.Globalization
@using Microsoft.Extensions.Hosting
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using cima.Blazor.Client.Authentication
@using Volo.Abp.AspNetCore.Components.Server.BasicTheme.Bundling
@using Volo.Abp.Localization
@using Volo.Abp.AspNetCore.Components.Web.Theming.Bundling
@inject IHostEnvironment Env
@inject PersistentComponentState PersistentComponentState
@inject AuthenticationStateProvider AuthenticationStateProvider
@implements IDisposable
@{
    var rtl = CultureHelper.IsRtl ? "rtl" : string.Empty;
}

<!DOCTYPE html>
<html lang="@CultureInfo.CurrentCulture.Name" dir="@rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>cima</title>
    <base href="/" />


    <!-- Scoped styles primero (menor prioridad) -->
    <link href="cima.Blazor.styles.css" rel="stylesheet"/>
    <link href="cima.Blazor.Client.styles.css" rel="stylesheet"/>
    
    <!-- Tailwind al final (mayor prioridad - desde wwwroot del servidor) -->
    <link href="/css/app.min.css" rel="stylesheet"/>
    
    <HeadOutlet @rendermode="InteractiveAuto" />

    
</head>
<body class="abp-application-layout @rtl">

    <Routes @rendermode="InteractiveAuto" />

    <div id="blazor-error-ui">
        @if (Env.IsDevelopment())
        {
            <text>An unhandled exception has occurred. See browser dev tools for details.</text>
        }
        else if (Env.IsStaging() || Env.IsProduction())
        {
            <text>An error has occurred. This application may no longer respond until reloaded.</text>
        }
        <a href="" class="reload">Reload</a>
        <a class="dismiss">🗙</a>
    </div>
    <script src="_content/Volo.Abp.AspNetCore.Components.Web/libs/abp/js/abp.js"></script>
    
    <!-- Script de Blazor -->
    <script src="_framework/blazor.web.js"></script>
    
    <!-- Script personalizado de navbar -->
    <script src="/js/navbar-scroll.js"></script>

</body>
</html>

@code{
    private PersistingComponentStateSubscription _persistingSubscription;

    protected override async Task OnInitializedAsync()
    {
        // Registrar callback para persistir el estado
        _persistingSubscription = PersistentComponentState.RegisterOnPersisting(PersistAuthenticationState);
    }

    private async Task PersistAuthenticationState()
    {
        // Este método se ejecuta durante el callback OnPersisting
        var authenticationState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        
        if (authenticationState.User.Identity?.IsAuthenticated == true)
        {
            var userInfo = new UserInfo
            {
                UserId = authenticationState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? string.Empty,
                UserName = authenticationState.User.FindFirst(ClaimTypes.Name)?.Value ?? string.Empty,
                Email = authenticationState.User.FindFirst(ClaimTypes.Email)?.Value,
                Roles = authenticationState.User.FindAll(ClaimTypes.Role).Select(c => c.Value).ToArray()
            };
            
            PersistentComponentState.PersistAsJson(nameof(UserInfo), userInfo);
        }
    }

    public void Dispose()
    {
        _persistingSubscription.Dispose();
    }
}