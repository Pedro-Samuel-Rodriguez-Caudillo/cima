name: Tests - Domain Unit Tests

on:
  push:
    branches:
      - develop
      - 'feature/**'
      - 'bugfix/**'
  pull_request:
    branches:
      - develop
      - staging
      - main
    paths:
      - 'src/**'
      - 'test/**'
      - '**.csproj'
      - '**.cs'

env:
  DOTNET_VERSION: '9.0.x'

jobs:
  test-domain:
    name: Domain Layer Tests (124 tests)
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
    
    - name: Restore dependencies
      run: dotnet restore test/cima.Domain.Tests/cima.Domain.Tests.csproj
    
    - name: Build test project
      run: dotnet build test/cima.Domain.Tests/cima.Domain.Tests.csproj --configuration Release --no-restore
    
    - name: Run Domain Unit Tests
      id: domain_tests
      run: |
        echo "::group::Domain Layer Unit Tests"
        dotnet test test/cima.Domain.Tests/cima.Domain.Tests.csproj \
          --configuration Release \
          --no-build \
          --no-restore \
          --verbosity normal \
          --logger "trx;LogFileName=domain-test-results.trx" \
          --logger "console;verbosity=detailed" \
          --collect:"XPlat Code Coverage" \
          -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
        echo "::endgroup::"
    
    - name: Test Report
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Domain Tests Report
        path: '**/domain-test-results.trx'
        reporter: dotnet-trx
        fail-on-error: true
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: domain-test-results
        path: |
          **/domain-test-results.trx
          **/coverage.opencover.xml
        retention-days: 30
    
    - name: Test Summary
      if: always()
      run: |
        echo "### Domain Tests Summary ??" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Total Tests**: 124" >> $GITHUB_STEP_SUMMARY
        echo "- **Expected Pass Rate**: 100%" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Duration**: ~7 seconds" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "#### Coverage" >> $GITHUB_STEP_SUMMARY
        echo "- ? Listing Entity (15 tests)" >> $GITHUB_STEP_SUMMARY
        echo "- ? Architect Entity (11 tests)" >> $GITHUB_STEP_SUMMARY
        echo "- ? ContactRequest Entity (17 tests)" >> $GITHUB_STEP_SUMMARY
        echo "- ? FeaturedListing Entity (60 tests)" >> $GITHUB_STEP_SUMMARY
        echo "- ? ListingImage Value Object (21 tests)" >> $GITHUB_STEP_SUMMARY
    
    - name: Quality Gate
      if: failure()
      run: |
        echo "::error::Domain tests failed! All 124 tests must pass."
        exit 1

  test-status:
    name: Test Status Check
    runs-on: ubuntu-latest
    needs: test-domain
    if: always()
    
    steps:
    - name: Check test results
      run: |
        if [ "${{ needs.test-domain.result }}" != "success" ]; then
          echo "::error::Tests failed - blocking merge"
          exit 1
        fi
        echo "::notice::All tests passed - ready to merge ?"
