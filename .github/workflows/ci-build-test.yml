name: CI - Build and Test

on:
  push:
    branches: 
      - develop
      - 'feature/**'
      - 'bugfix/**'
  pull_request:
    branches: 
      - develop
      - staging
      - main

env:
  DOTNET_VERSION: '9.0.x'
  NODE_VERSION: '20'

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET 9
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: Display environment
      run: |
        echo "Running on: ${{ runner.os }}"
        echo ".NET version: $(dotnet --version)"
        echo "Node version: $(node --version)"
        echo "NPM version: $(npm --version)"
    
    - name: Restore .NET dependencies
      run: dotnet restore cima.sln
    
    - name: Build solution
      run: dotnet build cima.sln --configuration Release --no-restore
    
    - name: Install NPM dependencies (Tailwind CSS)
      working-directory: src/cima.Blazor.Client
      run: npm ci
    
    - name: Build Tailwind CSS
      working-directory: src/cima.Blazor.Client
      run: npm run build:css
    
    # Tests de Domain Layer (124 tests - 100% passing)
    - name: Run Domain Unit Tests
      run: |
        echo "Running Domain Layer tests (124 tests)..."
        dotnet test test/cima.Domain.Tests/cima.Domain.Tests.csproj \
          --configuration Release \
          --no-build \
          --no-restore \
          --verbosity normal \
          --logger "trx;LogFileName=domain-test-results.trx" \
          --logger "console;verbosity=detailed"
      continue-on-error: false
    
    # Tests de Application Layer (preparados pero requieren configuraci√≥n)
    # - name: Run Application Tests
    #   run: |
    #     echo "Running Application Layer tests..."
    #     dotnet test test/cima.Application.Tests/cima.Application.Tests.csproj \
    #       --configuration Release \
    #       --no-build \
    #       --no-restore \
    #       --verbosity normal \
    #       --logger "trx;LogFileName=application-test-results.trx"
    #   continue-on-error: true
    
    - name: Test Summary
      if: always()
      run: |
        echo "================================"
        echo "Test Execution Summary"
        echo "================================"
        echo "Domain Tests: ? Executed"
        echo "Application Tests: ? Skipped (require EF Core config)"
        echo "================================"
    
    - name: Upload Domain test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: domain-test-results
        path: '**/domain-test-results.trx'
        retention-days: 7
    
    - name: Publish application
      if: success()
      run: dotnet publish src/cima.Blazor/cima.Blazor.csproj -c Release -o ./publish --no-build
    
    - name: Upload publish artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: blazor-app
        path: ./publish
        retention-days: 7
    
    - name: Build Summary
      if: always()
      run: |
        echo "================================"
        echo "CI/CD Pipeline Summary"
        echo "================================"
        echo "Build: ${{ job.status }}"
        echo "Tests: 124 Domain tests"
        echo "Artifacts: Published app ready"
        echo "================================"

  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    needs: build-and-test
    if: needs.build-and-test.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: dotnet restore cima.sln
    
    - name: Code Format Check
      run: |
        echo "Checking code format..."
        dotnet format cima.sln --verify-no-changes --verbosity diagnostic || true
      continue-on-error: true
    
    - name: Quality Summary
      run: |
        echo "================================"
        echo "Code Quality Summary"
        echo "================================"
        echo "Format Check: Completed"
        echo "Static Analysis: Ready for integration"
        echo "================================"
