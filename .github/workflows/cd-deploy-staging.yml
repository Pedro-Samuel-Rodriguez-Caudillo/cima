name: CD - Deploy to Staging

# Deploy automático cuando hay push a develop
on:
  push:
    branches: [ develop ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Railway hace deploy automático cuando detecta cambios en develop
  # Este workflow solo notifica y verifica
  notify-deployment:
    name: Notify Railway Deployment
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Get commit info
      id: commit
      run: |
        echo "sha_short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
        COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1 | tr -d '\n\r')
        echo "message=${COMMIT_MSG}" >> "$GITHUB_OUTPUT"
    
    - name: Notify deployment started
      run: |
        echo "?? Railway Deployment Triggered"
        echo "Branch: develop"
        echo "Commit: ${{ steps.commit.outputs.sha_short }}"
        echo "Message: ${{ steps.commit.outputs.message }}"
        echo ""
        echo "Railway will automatically deploy to staging environment"
        echo "Monitor deployment: https://railway.app/dashboard"
    
    - name: Wait for Railway deployment
      run: |
        echo "Waiting 30 seconds for Railway to start deployment..."
        sleep 30
    
    - name: Display next steps
      run: |
        echo "? Deployment notification complete"
        echo ""
        echo "Next steps:"
        echo "1. Check Railway dashboard for deployment status"
        echo "2. Monitor logs in Railway"
        echo "3. Test staging URL when deployment completes"
        echo "4. If successful, create PR to master for production"

# ==============================================================
# NOTAS:
# ==============================================================
# 
# Railway detecta automáticamente los cambios en la rama develop
# y hace deploy sin necesidad de este workflow.
# 
# Este workflow es solo para notificación y registro.
# 
# Para deploy manual desde Railway CLI:
#   npm install -g @railway/cli
#   railway login
#   railway link
#   railway up
#
# Ver docs/RAILWAY_STAGING_CONFIG.md para más información
# ==============================================================
