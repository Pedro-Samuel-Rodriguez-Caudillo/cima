name: CD - Deploy to Staging

# Deploy automático cuando hay push a STAGING (no develop)
on:
  push:
    branches: [ staging ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Railway hace deploy automático cuando detecta cambios en staging
  # Este workflow solo notifica y verifica
  notify-deployment:
    name: Notify Railway Deployment
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Get commit info
      id: commit
      run: |
        echo "sha_short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
        COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1 | tr -d '\n\r')
        echo "message=${COMMIT_MSG}" >> "$GITHUB_OUTPUT"
    
    - name: Notify deployment started
      run: |
        echo "?? Railway Deployment Triggered"
        echo "Branch: staging"
        echo "Commit: ${{ steps.commit.outputs.sha_short }}"
        echo "Message: ${{ steps.commit.outputs.message }}"
        echo ""
        echo "Railway will automatically deploy to staging environment"
        echo "Monitor deployment: https://railway.app/dashboard"
    
    - name: Wait for Railway deployment
      run: |
        echo "Waiting 30 seconds for Railway to start deployment..."
        sleep 30
    
    - name: Display next steps
      run: |
        echo "? Deployment notification complete"
        echo ""
        echo "Next steps:"
        echo "1. Check Railway dashboard for deployment status"
        echo "2. Monitor logs in Railway"
        echo "3. Test staging URL when deployment completes"
        echo "4. Perform complete QA testing"
        echo "5. If successful, create PR staging ? main for production"

# ==============================================================
# NOTAS:
# ==============================================================
# 
# Railway detecta automáticamente los cambios en la rama staging
# y hace deploy sin necesidad de este workflow.
# 
# Este workflow es solo para notificación y registro.
# 
# FLUJO RECOMENDADO:
# - develop: desarrollo continuo
# - staging: testing y QA (Railway deploy automático)
# - main: producción
#
# Para deploy manual desde Railway CLI:
#   npm install -g @railway/cli
#   railway login
#   railway link
#   railway up
#
# Ver .github/BRANCHING_STRATEGY.md para más información
# ==============================================================
