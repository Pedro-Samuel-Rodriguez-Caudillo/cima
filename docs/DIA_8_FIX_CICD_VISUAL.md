# CI/CD FIX - GUÍA VISUAL

## ?? ERRORES IDENTIFICADOS

```
ERROR 1: Docker Build
????????????????????????????????????????
ERROR: failed to solve: 
process "/bin/sh -c dotnet publish \"cima.Blazor.csproj\"" 
did not complete successfully: exit code: 1
```

```
ERROR 2: GitHub Actions CI
????????????????????????????????????????
error MSB3030: Could not copy the file 
"/home/runner/.../appsettings.secrets.json" 
because it was not found.
```

---

## ? SOLUCIONES APLICADAS

### Fix 1: Dockerfile

```diff
src/cima.Blazor/Dockerfile

# Stage 3: Publish
FROM build AS publish
ARG BUILD_CONFIGURATION=Release
- WORKDIR "/src/src/cima.Blazor"
- RUN dotnet publish "cima.Blazor.csproj" \
+ RUN dotnet publish "/src/src/cima.Blazor/cima.Blazor.csproj" \
    -c $BUILD_CONFIGURATION \
    -o /app/publish \
    /p:UseAppHost=false
```

**Razón:** La ruta relativa no funcionaba porque `WORKDIR` creaba estructura incorrecta.

---

### Fix 2: Test Projects

```diff
test/cima.HttpApi.Client.ConsoleTestApp/cima.HttpApi.Client.ConsoleTestApp.csproj
test/cima.TestBase/cima.TestBase.csproj

  <ItemGroup>
-   <None Remove="appsettings.secrets.json" />
-   <Content Include="appsettings.secrets.json">
+   <Content Include="appsettings.secrets.json" 
+            Condition="Exists('appsettings.secrets.json')">
      <CopyToPublishDirectory>PreserveNewest</CopyToPublishDirectory>
      <CopyToOutputDirectory>Always</CopyToOutputDirectory>
    </Content>
  </ItemGroup>
```

**Razón:** Los archivos secrets están en `.gitignore`, entonces no existen en GitHub CI.

---

## ?? ARCHIVOS MODIFICADOS

```
??? src/
?   ??? cima.Blazor/
?       ??? Dockerfile ............................ MODIFICADO
?
??? test/
?   ??? cima.HttpApi.Client.ConsoleTestApp/
?   ?   ??? cima.HttpApi.Client.ConsoleTestApp.csproj ... MODIFICADO
?   ??? cima.TestBase/
?       ??? cima.TestBase.csproj .................. MODIFICADO
?
??? .gitignore ..................................... MODIFICADO
?
??? etc/scripts/
?   ??? test-docker-build.ps1 ..................... NUEVO
?
??? docs/
    ??? DIA_8_FIX_CICD.md ......................... NUEVO
    ??? DIA_8_FIX_CICD_QUICK.md ................... NUEVO
    ??? DIA_8_FIX_CICD_VISUAL.md .................. NUEVO (este)
```

---

## ?? TESTING WORKFLOW

```
???????????????????????????????????????????????????????????
? 1. LOCAL TESTING                                        ?
???????????????????????????????????????????????????????????
                        ?
                        ?
          ???????????????????????????
          ?  dotnet build           ?
          ?  ? Build succeeded     ?
          ???????????????????????????
                        ?
                        ?
          ???????????????????????????
          ?  test-docker-build.ps1  ?
          ?  ? Docker build OK     ?
          ???????????????????????????
                        ?
                        ?
???????????????????????????????????????????????????????????
? 2. GIT COMMIT & PUSH                                    ?
???????????????????????????????????????????????????????????
                        ?
                        ?
          ???????????????????????????
          ?  git add .              ?
          ?  git commit             ?
          ?  git push origin master ?
          ???????????????????????????
                        ?
                        ?
???????????????????????????????????????????????????????????
? 3. GITHUB ACTIONS CI/CD                                 ?
???????????????????????????????????????????????????????????
                        ?
          ?????????????????????????????
          ?                           ?
????????????????????       ????????????????????
? CI - Build & Test?       ? CD - Deploy Prod ?
? ? Tests pass    ?       ? ? Docker build  ?
? ? Build OK      ?       ? ? Deploy OK     ?
????????????????????       ????????????????????
```

---

## ?? COMANDOS RÁPIDOS

### Opción A: Testing Completo
```powershell
# 1. Build local
dotnet build

# 2. Test Docker
.\etc\scripts\test-docker-build.ps1

# 3. Si OK, push
git add .
git commit -F .git_commit_msg_fix_cicd.txt
git push origin master
```

### Opción B: Quick Push
```powershell
# Si confías en los cambios
dotnet build && `
git add . && `
git commit -F .git_commit_msg_fix_cicd.txt && `
git push origin master
```

---

## ?? MONITOREO POST-PUSH

```
1. Abrir GitHub Actions
   https://github.com/Pedro-Samuel-Rodriguez-Caudillo/cima/actions

2. Verificar Workflows
   ??????????????????????????????????????
   ? ? CI - Build and Test             ?
   ?    ?? Setup .NET 9                 ?
   ?    ?? Restore dependencies         ?
   ?    ?? Build solution               ?
   ?    ?? Build Tailwind CSS           ?
   ?    ?? Run tests                    ?
   ?    ?? Publish application          ?
   ??????????????????????????????????????
   
   ??????????????????????????????????????
   ? ? CD - Deploy Production          ?
   ?    ?? Checkout code                ?
   ?    ?? Docker login                 ?
   ?    ?? Build Docker image           ?
   ?    ?? Push to registry             ?
   ?    ?? Deploy to server             ?
   ??????????????????????????????????????

3. Si falla
   - Clic en workflow fallido
   - Expandir paso con error
   - Revisar logs
   - Consultar docs/DIA_8_FIX_CICD.md
```

---

## ?? TROUBLESHOOTING

### ? Docker build local falla

```powershell
# Verificar Docker está corriendo
docker ps

# Limpiar caché
docker system prune -a

# Reintentar
.\etc\scripts\test-docker-build.ps1
```

### ? GitHub Actions falla en "Build solution"

**Revisar:**
- ¿Archivos secrets.json en staging? ? `git status`
- ¿.csproj tiene Condition="Exists()"? ? Revisar commits

### ? GitHub Actions falla en "Build Docker image"

**Revisar:**
- ¿Dockerfile tiene ruta absoluta? ? Ver src/cima.Blazor/Dockerfile
- ¿Logs muestran "file not found"? ? Verificar estructura de carpetas

---

## ? RESULTADO ESPERADO

```
???????????????????????????????????????????????????????????
?                    GITHUB ACTIONS                       ?
?                                                         ?
?  ? CI - Build and Test                                ?
?     Duration: ~5-7 minutes                              ?
?     Status: Success                                     ?
?                                                         ?
?  ? CD - Deploy Production                             ?
?     Duration: ~8-10 minutes                             ?
?     Status: Success                                     ?
?                                                         ?
?  ?? All checks have passed                             ?
???????????????????????????????????????????????????????????
```

---

## ?? IMPACTO

| Métrica | Antes | Después |
|---------|-------|---------|
| CI Build | ? FALLA | ? PASA |
| Docker Build | ? FALLA | ? PASA |
| CD Deploy | ?? BLOQUEADO | ? FUNCIONAL |
| Desarrollo Local | ?? Requiere secrets | ? Opcional |

---

## ?? ESTADO ACTUAL

```
???????????????????????????????????????????
?  LOCAL                                  ?
?  ? Build: OK                          ?
?  ? Docker: Corregido                  ?
?  ? Tests: OK                          ?
???????????????????????????????????????????
           ?
           ?
???????????????????????????????????????????
?  GITHUB                                 ?
?  ? Push: PENDIENTE                    ?
?  ? CI: PENDIENTE                      ?
?  ? CD: PENDIENTE                      ?
???????????????????????????????????????????
```

---

## ?? SIGUIENTE ACCIÓN

```powershell
# Ejecutar ahora:
git add .
git commit -F .git_commit_msg_fix_cicd.txt
git push origin master

# Luego monitorear:
# https://github.com/Pedro-Samuel-Rodriguez-Caudillo/cima/actions
```

---

**Creado:** Día 8
**Tipo:** Fix CI/CD
**Prioridad:** Alta
**Confianza:** 95%
**Tiempo estimado:** 15 minutos (push + monitoreo)
